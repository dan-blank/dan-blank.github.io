<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Tony Zorman – Blog</title>
    <link href="https://tony-zorman.com/atom-haskell.xml" rel="self" />
    <link href="https://tony-zorman.com" />
    <id>https://tony-zorman.com/atom-haskell.xml</id>
    <author>
        <name>Tony Zorman</name>
        <email>tonyzorman@mailbox.org</email>
    </author>
    <updated>2023-01-27T00:00:00Z</updated>
    <entry>
    <title>Using Sidenotes with Hakyll</title>
    <link href="https://tony-zorman.com/posts/2023-01-27-block-sidenotes.html" />
    <id>https://tony-zorman.com/posts/2023-01-27-block-sidenotes.html</id>
    <published>2023-01-27T00:00:00Z</published>
    <updated>2023-01-27T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-27
      
        | <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
I’ve become quite enamoured with sidenotes recently, and so of course
this website now has them as well! Thankfully, the integration with
pandoc and Hakyll is quite straightforward, because other people have
already done the hard work. Depending on your use-case, however, the
existing libraries might not entirely fit the bill; for example, by
default blocks that are more complicated than just paragraphs of pure
text don’t work. In this post, I’d like to explain an alternative
approach of integrating sidenotes into pandoc, which does enable the use
of these features.
<!--more-->
<h2 id="introduction">Introduction</h2>
<p></p>
If you don’t know: sidenotes are footnotes, just on the side of the
page!<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">For example, this is one.</span></span>
 More specifically they are footnotes placed inside of the
margins, in order to avoid having to click or scroll, breaking the flow
of reading—a flick of the eyes is enough. This is very convenient,
especially for longer entries with lots of asides that don’t necessarily
fit the flow of the article. However, because websites are dynamic in
size, a fallback option should be provided in case the margins are too
small/nonexistent. In most cases, this amount to making sidenotes
clickable again and, in one way or another, showing their content once
clicked.
<p></p>
Gwern Branwen has written about many different sidenote implementations
<a href="https://gwern.net/Sidenotes">here</a>. I settled on <a href="https://github.com/edwardtufte/tufte-css">Tufte <span class="small-caps">css</span></a>,
mainly because it seemed to be the most popular non-JS solution. Plus,
there is the fantastic <a href="https://hackage.haskell.org/package/pandoc-sidenote">pandoc-sidenote</a>, which
provides an appropriate pandoc filter. After extracting the relevant
<span class="small-caps">css</span> into <a href="https://github.com/slotThe/slotThe.github.io/blob/main/css/sidenotes.css">sidenotes.css</a> and plugging the exported
<code>usingSidenotes</code> function into my pandoc compiler,<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">Just like you would expect:
<div class="highlight"><pre><span></span><span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">pandocCompilerWithTransformM</span>
<span class="w">    </span><span class="n">defaultHakyllReaderOptions</span>
<span class="w">    </span><span class="n">myWriter</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">pygmentsHighlight</span><span class="w"> </span><span class="c1">-- syntax highlight</span>
<span class="w">    </span><span class="o">.</span><span class="w"> </span><span class="n">usingSidenotes</span><span class="w">    </span><span class="c1">-- sidenotes</span>
<span class="w">    </span><span class="o">.</span><span class="w"> </span><span class="n">addSectionLinks</span><span class="w">   </span><span class="c1">-- link on hover</span>
<span class="w">    </span><span class="p">)</span>
</pre></div>
</span></span>
 things just
worked!
<p></p>
There is but one problem with this setup: paragraphs. A sidenote
roughly looks like the following:
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sidenote-wrapper&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;sn-NAME&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;margin-toggle sidenote-number&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;sn-NAME&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;margin-toggle&quot;</span><span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sidenote&quot;</span><span class="p">&gt;</span>
    SIDENOTE
  <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div>

<p></p>
As Chris MacKay—a Tufte <span class="small-caps">css</span> contributor—helpfully explains in an
<a href="https://github.com/edwardtufte/tufte-css/issues/93#issuecomment-234316022">issue</a>, spans officially don’t play nice with
paragraphs:
<blockquote>
<p></p>
so marginnotes and sidenotes, as they are implemented now, are
<code>&lt;span&gt;</code> elements inside paragraph <code>&lt;p&gt;</code> elements. Only inline
elements are allowed inside paragraphs per the <span class="small-caps">html</span> standard.
</blockquote>
<p></p>
I know what you’re thinking: people don’t usually let themselves be
hampered by standards, do they?<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Just ask any person who’s ever worked on a window manager what
creative “interpretations” programs have of <a href="https://x.org/releases/X11R7.6/doc/xorg-docs/specs/ICCCM/icccm.html">ICCCM</a> or <a href="https://en.wikipedia.org/wiki/Extended_Window_Manager_Hints">EWMH</a> :)</span></span>
 Alas, the <code>pandoc-sidenote</code> package
quite sensibly converts a given footnote into an approximation of the
above <span class="small-caps">html</span> by using pandoc’s native <code>Span</code> data constructor. Here is a
(heavily) simplified version of the relevant function.
<div class="highlight"><pre><span></span><span class="nf">filterInline</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Inline</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Inline</span>
<span class="nf">filterInline</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">  </span><span class="c1">-- A @Note@ signifies a footnote.</span>
<span class="w">  </span><span class="kt">Note</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="c1">-- Note has a [Block], but Span needs [Inline]</span>
<span class="w">        </span><span class="n">content</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">coerceToInline</span><span class="w"> </span><span class="n">blocks</span>
<span class="w">     </span><span class="kr">in</span><span class="w"> </span><span class="kt">Span</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;sidenote-wrapper&quot;</span><span class="p">],</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span>
<span class="w">             </span><span class="p">[</span><span class="w"> </span><span class="kt">RawInline</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="s">&quot;&lt;label for …&quot;</span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="kt">RawInline</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="s">&quot;&lt;input type …&quot;</span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="kt">Span</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;sidenote&quot;</span><span class="p">],</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span><span class="w"> </span><span class="n">content</span>
<span class="w">             </span><span class="p">]</span>
<span class="w">  </span><span class="n">inline</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">inline</span>
</pre></div>

<p></p>
Now, pandoc very much does <em>not</em> want you to put any kind of block
inside of its <code>Span</code>s—that’s why its type is
<div class="highlight"><pre><span></span><span class="kt">Span</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Attr</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Inline</span>
</pre></div>

<p></p>
Notice the absence of a <code>[Block]</code> argument. This is why
<code>coerceToInline</code> exists, which tries to convert as many blocks as it can
to inline elements.
<div class="highlight"><pre><span></span><span class="nf">coerceToInline</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span>
<span class="nf">coerceToInline</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">concatMap</span><span class="w"> </span><span class="n">deBlock</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">walk</span><span class="w"> </span><span class="n">deNote</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Block</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">Plain</span><span class="w">     </span><span class="n">ls</span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">ls</span>
<span class="w">  </span><span class="c1">-- Simulate paragraphs with double LineBreak</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">Para</span><span class="w">      </span><span class="n">ls</span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">newline</span>
<span class="w">  </span><span class="c1">-- See extension: line_blocks</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">LineBlock</span><span class="w"> </span><span class="n">lss</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">intercalate</span><span class="w"> </span><span class="p">[</span><span class="kt">LineBreak</span><span class="p">]</span><span class="w"> </span><span class="n">lss</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">newline</span>
<span class="w">  </span><span class="c1">-- Pretend RawBlock is RawInline (might not work!)</span>
<span class="w">  </span><span class="c1">-- Consider: raw &lt;div&gt; now inside RawInline... what happens?</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">RawBlock</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kt">RawInline</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="n">str</span><span class="p">]</span>
<span class="w">  </span><span class="c1">-- lists, blockquotes, headers, hrs, and tables are all omitted</span>
<span class="w">  </span><span class="c1">-- Think they shouldn't be? I'm open to sensible PR's.</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="kr">_</span><span class="w">                  </span><span class="ow">=</span><span class="w"> </span><span class="kt">[]</span>

<span class="w">  </span><span class="n">deNote</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Inline</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Inline</span>
<span class="w">  </span><span class="n">deNote</span><span class="w"> </span><span class="p">(</span><span class="kt">Note</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="n">deNote</span><span class="w"> </span><span class="n">x</span><span class="w">        </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span>
</pre></div>

<p></p>
The <code>coerceToInline</code> function behaves sensibly with respect to the
simplest kinds of blocks, but already mentions that the <code>RawBlock → RawInline</code> transformation may have some caveats. For example,
<a href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html">prerendering code blocks</a> puts one in exactly such a
“now we have a <code>&lt;div&gt;</code> tag inside of a <code>RawInline</code> element” situation.
Well, what happens?
<span class="sidenote-wrapper">
<label for="sn-2" class="margin-toggle sidenote-number"></label>
<input type="checkbox" id="sn-2" class="margin-toggle" />
<p><span class="sidenote">Now simulating <code>pandoc-sidenode</code>s behaviour, the following is a piece of code <em>in the sidenote:</em>
<div class="highlight"><pre><span></span><span class="nf">a</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span> <span class="nf">
a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">42</span> </pre></div>
</span></p>
</span>
<p></p>
This is the next line in the main document; the above code block was
supposed to be in the relevant sidenote, but “spilled” into the text
instead. This is obviously not what we want.
<p></p>
The documentation mentions other things that are missing, and that pull
requests are welcome, but for many blocks there just is no good
alternative. For example, code blocks and inline code serve very
different purposes most of the time. Pandoc itself has a
<a href="https://hackage.haskell.org/package/pandoc-3.0.1/docs/Text-Pandoc-Shared.html#v:blocksToInlines">function</a> of the same name that
attempts to convert tables, figures, and the like, but this also yields
some surprising behaviour when used instead of <code>pandoc-sidenote</code>s
variant.<!--
--><span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">Whereas now, things like
<ul>
<li><p></p>

tables
<table style="width:66%;">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="header">
<th>Fruit</th>
<th>Price</th>
<th>Advantages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Oranges</td>
<td>$2.10</td>
<td><ul>
<li>cures scurvy</li>
<li>tasty</li>
</ul></td>
</tr>
</tbody>
</table></li>
<li><p></p>

quotes
<blockquote>
<p></p>
they said that …
</blockquote></li>
<li><p></p>

display maths
<p></p>

<span class="math display">\[
\int^{a, b} \mathcal{C}(a \otimes b, {-}) \cdot Fa \otimes Gb
\]</span></li>
</ul>
<p></p>
and the like are no problem at all!</span></span>
<p></p>
So what to do? Well, life wouldn’t be fun if we didn’t at least try to
hack our way around a standard, would it?
<h2 id="rewriting-pandoc-sidenote">Rewriting <code>pandoc-sidenote</code></h2>
<p></p>
As I’ve learned while <a href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html">writing</a> about using
<code>pygmentize</code> to syntax highlight code for this site, pandoc has quite
good support for changing its <span class="small-caps">ast</span> in creative ways. A strategy unfolds:
find every <code>Note</code> block in a document, somehow render its contents, and
create a <code>RawBlock "html"</code> node instead of using pandoc’s built in
<code>Span</code> .
<p></p>
For rendering <span class="small-caps">html</span>, pandoc has a
<a href="https://hackage.haskell.org/package/pandoc-3.0.1/docs/Text-Pandoc-Writers.html#v:writeHtml5String">writeHtml5String</a> function, which is
conveniently wrapped by Hakyll in
<a href="https://hackage.haskell.org/package/hakyll-4.15.1.1/docs/Hakyll-Web-Pandoc.html#v:writePandocWith">writePandocWith</a>:
<div class="highlight"><pre><span></span><span class="c1">-- | Write a document (as HTML) using pandoc, with the supplied options</span>
<span class="nf">writePandocWith</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">WriterOptions</span><span class="w">  </span><span class="c1">-- ^ Writer options for pandoc</span>
<span class="w">                </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Item</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w">    </span><span class="c1">-- ^ Document to write</span>
<span class="w">                </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="w">    </span><span class="c1">-- ^ Resulting HTML</span>
</pre></div>

<p></p>
Importantly, rendering takes some <code>WriterOptions</code>; since we don’t want
to mess around with changing pure <span class="small-caps">html</span> afterwards, this is quite
important for us.
<p></p>
Writing this filter now essentially works by the same strategy outlined
in the last post: look through the Haddocks to find the types that we
want, <a href="https://aphyr.com/posts/342-typing-the-technical-interview">seize some meaningless functions from the void, and imbue them
with meaning</a>. The relevant bits
from pandoc’s internal types are the following.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="kt">Meta</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Block</span>
<span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="kt">Plain</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w">       </span><span class="c1">-- ^ Plain text, not a paragraph</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Para</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w">        </span><span class="c1">-- ^ Paragraph</span>
<span class="w">    </span><span class="c1">-- …</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">RawBlock</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="kt">Text</span><span class="w"> </span><span class="c1">-- ^ Raw block</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Inline</span>
<span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="kt">Text</span><span class="w">             </span><span class="c1">-- ^ Text (string)</span>
<span class="w">    </span><span class="c1">-- …</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Note</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w">         </span><span class="c1">-- ^ Footnote or endnote</span>
</pre></div>

<p></p>
While this document is <em>not</em> a literate Haskell file, the following is
still here for convenience, in case you are left wondering where some of
the functions come from.
<div class="highlight"><pre><span></span><span class="cm">{-# LANGUAGE BangPatterns             #-}</span>
<span class="cm">{-# LANGUAGE LambdaCase               #-}</span>
<span class="cm">{-# LANGUAGE OverloadedStrings        #-}</span>
<span class="cm">{-# LANGUAGE StandaloneKindSignatures #-}</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Control.Monad.State</span><span class="w"> </span><span class="p">(</span><span class="kt">State</span><span class="p">,</span><span class="w"> </span><span class="nf">foldM</span><span class="p">,</span><span class="w"> </span><span class="nf">get</span><span class="p">,</span><span class="w"> </span><span class="nf">modify'</span><span class="p">,</span><span class="w"> </span><span class="nf">runState</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Kind</span><span class="w"> </span><span class="p">(</span><span class="kt">Type</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Text</span><span class="w"> </span><span class="p">(</span><span class="kt">Text</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="k">qualified</span><span class="w"> </span><span class="nn">Data.Text</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Hakyll</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="nf">writePandocWith</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Definition</span><span class="w"> </span><span class="p">(</span><span class="kt">Block</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="kt">Inline</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Options</span><span class="w"> </span><span class="p">(</span><span class="kt">WriterOptions</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Shared</span><span class="w"> </span><span class="p">(</span><span class="nf">tshow</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Walk</span><span class="w"> </span><span class="p">(</span><span class="nf">walkM</span><span class="p">)</span>
</pre></div>

<p></p>
Rendering the actual sidenote isn’t very complicated, and amounts to
picking out the <code>Note</code> constructor, rendering it, and putting everything
back together.<!--
--><span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">The <code>Sidenote</code> type you are seeing is just some alias for <code>State</code>,
which keeps track of the sidenote number, as well as the supplied
<code>WriterOption</code>s; nothing fancy.</span></span>
<div class="highlight"><pre><span></span><span class="nf">renderSidenote</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w">            </span><span class="c1">-- ^ Inlines from a single @Note@</span>
<span class="w">               </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="nf">renderSidenote</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="kt">[]</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">go</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="w">  </span><span class="n">go</span><span class="w"> </span><span class="n">inlines</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">    </span><span class="kt">[]</span><span class="w">           </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="p">[</span><span class="kt">Plain</span><span class="w"> </span><span class="n">inlines</span><span class="p">]</span>
<span class="w">    </span><span class="kt">Note</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">renderBlock</span><span class="w"> </span><span class="n">bs</span>
<span class="w">                       </span><span class="p">([</span><span class="kt">Plain</span><span class="w"> </span><span class="n">inlines</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="n">xs</span>
<span class="w">    </span><span class="n">b</span><span class="w">       </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="p">(</span><span class="n">inlines</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">b</span><span class="p">])</span><span class="w"> </span><span class="n">xs</span>

<span class="w">  </span><span class="n">renderBlock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="kt">Block</span>
<span class="w">  </span><span class="n">renderBlock</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="c1">-- Update sidenote counter and get the `WriterOption's.</span>
<span class="w">    </span><span class="kt">SNS</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="o">&lt;*</span><span class="w"> </span><span class="n">modify'</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">sns</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sns</span><span class="p">{</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="n">sns</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="n">pure</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="c1">-- … all the opening html stuff</span>
<span class="w">                             </span><span class="n">writePandocWith</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">(</span><span class="kt">Pandoc</span><span class="w"> </span><span class="n">mempty</span><span class="w"> </span><span class="n">blocks</span><span class="p">))</span>
<span class="w">                             </span><span class="c1">-- … all the closing html stuff</span>
</pre></div>

<p></p>
Finding notes is a bit more finicky, since they could potentially occur
in a lot of places. Right now, for obvious reasons, I’ve settled on
covering all cases that currently occur on this website. Importantly,
we need to be a bit careful about inserting newlines for paragraphs (and
when to omit this). This is because <code>Note</code>s are actually inline
elements, and so we are replacing a single <code>Block</code> by a list of
<code>Block</code>s, which incurs some additional formatting.
<div class="highlight"><pre><span></span><span class="nf">mkSidenote</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="nf">mkSidenote</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">foldM</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">acc</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">acc</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="kt">[]</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">single</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Block</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="w">  </span><span class="n">single</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">    </span><span class="c1">-- Simulate a paragraph by inserting a dummy block; this is needed</span>
<span class="w">    </span><span class="c1">-- in case two consecutive paragraphs have sidenotes, or a paragraph</span>
<span class="w">    </span><span class="c1">-- doesn't have one at all.</span>
<span class="w">    </span><span class="kt">Para</span><span class="w"> </span><span class="n">inlines</span><span class="w">         </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Para</span><span class="w"> </span><span class="p">[</span><span class="kt">Str</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">]</span><span class="w"> </span><span class="kt">:</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">renderSidenote</span><span class="w"> </span><span class="n">inlines</span>
<span class="w">    </span><span class="kt">OrderedList</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">:[]</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">OrderedList</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">traverse</span><span class="w"> </span><span class="n">mkSidenote</span><span class="w"> </span><span class="n">bs</span>
<span class="w">    </span><span class="kt">BulletList</span><span class="w">        </span><span class="n">bs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">:[]</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">BulletList</span><span class="w">        </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">traverse</span><span class="w"> </span><span class="n">mkSidenote</span><span class="w"> </span><span class="n">bs</span>
<span class="w">    </span><span class="n">block</span><span class="w">                </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="p">[</span><span class="n">block</span><span class="p">]</span>
</pre></div>

<p></p>
Putting everything together, we apply this transformation to every block
in a document:
<div class="highlight"><pre><span></span><span class="nf">usingSidenotes</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">WriterOptions</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Pandoc</span>
<span class="nf">usingSidenotes</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="p">(</span><span class="kt">Pandoc</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kt">Pandoc</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="p">(</span><span class="n">walkBlocks</span><span class="w"> </span><span class="p">(</span><span class="kt">SNS</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">walkBlocks</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">SidenoteState</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="w">  </span><span class="n">walkBlocks</span><span class="w"> </span><span class="n">sns</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">    </span><span class="kt">[]</span><span class="w">       </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">[]</span>
<span class="w">    </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">bs</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b'</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">walkBlocks</span><span class="w"> </span><span class="n">s'</span><span class="w"> </span><span class="n">bs</span>
<span class="w">     </span><span class="kr">where</span><span class="w"> </span><span class="p">(</span><span class="n">b'</span><span class="p">,</span><span class="w"> </span><span class="n">s'</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runState</span><span class="w"> </span><span class="p">(</span><span class="n">walkM</span><span class="w"> </span><span class="n">mkSidenote</span><span class="w"> </span><span class="p">[</span><span class="n">b</span><span class="p">])</span><span class="w"> </span><span class="n">sns</span>
</pre></div>

<p></p>
This can now be used much like the <code>usingSidenotes</code> function from
<code>pandoc-sidenote</code>, only that it needs to know your <code>WriterOption</code>s.
More importantly, it should be the last of the transformations that you
do to pandoc’s <span class="small-caps">ast</span>, since <code>usingSidenotes</code> completely renders the
footnote, which is not what you want in case you—like me—do other
creative transformations, such as separately generating <span class="small-caps">html</span> for
<code>CodeBlock</code>s. In my configuration, I now have
<div class="highlight"><pre><span></span><span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">pandocCompilerWithTransformM</span>
<span class="w">    </span><span class="n">defaultHakyllReaderOptions</span>
<span class="w">    </span><span class="n">myWriter</span>
<span class="w">    </span><span class="p">(</span><span class="n">pure</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">usingSidenotes</span><span class="w"> </span><span class="n">myWriter</span><span class="w"> </span><span class="o">&lt;=&lt;</span><span class="w"> </span><span class="n">pygmentsHighlight</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">addSectionLinks</span><span class="p">)</span>
</pre></div>

<p></p>
Tufte <span class="small-caps">css</span> needs to be changed minimally to support this extended
functionality, but thankfully Said Achmiz has already documented what
needs to be done <a href="https://github.com/edwardtufte/tufte-css/issues/93#issuecomment-671102819">here</a>. This is
already included in my <code>sidenotes.css</code>, so if you’re just copying that
then you should be fine.
<h2 id="conclusion">Conclusion</h2>
<p></p>
Being perfectly honest, I’m not very satisfied with this solution. It
does work, but pre-rendering everything and not using pandoc’s built in
constructors feels like a big hack. More importantly though, since what
I’ve done here amounts to a complete rewrite,<!--
--><span class="sidenote-wrapper"><label for="sn-5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-5" class="margin-toggle" /><span class="sidenote">Not only that, but it’s almost certainly also a regression in
certain aspects; even after handling of margin notes is restored,
which I’ve completely ignored for now.</span></span>
 I can’t contribute
this upstream—at least I don’t see a way. I sort of don’t want to
advertise this solution as an alternative to <code>pandoc-sidenote</code>, as that
package handles the concept of sidenotes in a much better way,
philosophically. Hence, there is no standalone repository for
<a href="https://github.com/slotThe/slotThe.github.io/blob/main/src/Sidenote.hs">Sidenote.hs</a> and <a href="https://github.com/slotThe/slotThe.github.io/blob/main/css/sidenotes.css">sidenotes.css</a> at
this point.
<p></p>
Really, I would be delighted if someone told me that I just used
<code>pandoc-sidenote</code> (or another program involved) wrongly, and this is
actually very easy to achieve using <code>${METHOD}</code>. Until then, I’ll
continue to be blissfully unaware of <span class="small-caps">html</span> standards :)

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Pygmentising Hakyll's Syntax Highlighting</title>
    <link href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html" />
    <id>https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html</id>
    <published>2023-01-21T00:00:00Z</published>
    <updated>2023-01-21T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-21
      
        | <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
By default, Hakyll uses pandoc to generate syntax highlighting for all
kinds of different programming languages. However, even in simple
examples the <span class="small-caps">html</span> this produces is unsatisfactory. Thankfully, the two
programs are almost infinitely customisable, and changing pretty much
any setting doesn’t usually involve a lot of work—this is no exception.
Using <code>pygmentize</code> as an example, I will show you how you can swap out
pandoc’s native syntax highlighting with pretty much any third party
tool that can output <span class="small-caps">html</span>.
<!--more-->
<h2 id="the-problem">The Problem</h2>
<p></p>
Pandoc uses the <a href="https://hackage.haskell.org/package/skylighting">skylighting</a> library to generate syntax highlighting
for a given block of code. Skylighting, in turn, uses <a href="https://docs.kde.org/stable5/en/kate/katepart/highlight.html"><span class="small-caps">kde</span> <span class="small-caps">xml</span> syntax
definitions</a> for the respective tokenisers. However, even for simple
examples I don’t agree with the <span class="small-caps">html</span> this generates. Consider the
following Haskell code block.
<div class="highlight"><pre><span></span><span class="nf">fibs</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Integer</span><span class="p">]</span>
<span class="nf">fibs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">scanl'</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">fibs</span>
</pre></div>

<p></p>
Pandoc would generate something like the following:
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sourceCode&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;cb1&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">pre</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sourceCode haskell&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">code</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sourceCode haskell&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;cb1-1&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#cb1-1&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;-1&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ot&quot;</span><span class="p">&gt;</span>    fibs :: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> [<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dt&quot;</span><span class="p">&gt;</span>Integer <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>]
      <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;cb1-2&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#cb1-2&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;-1&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>    fibs
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ot&quot;</span><span class="p">&gt;</span>= <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dv&quot;</span><span class="p">&gt;</span>0 <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;op&quot;</span><span class="p">&gt;</span>: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        scanl<span class="ni">&amp;#39;</span> (<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;op&quot;</span><span class="p">&gt;</span>+ <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>) <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dv&quot;</span><span class="p">&gt;</span>1
        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> fibs
      <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>

<p></p>
One can already see a few things wrong with this: (i) in the type
signature, the name of the list is smushed together with the separating
double colon (worse: it’s just in the “other” syntax class), (ii) in the
actual definition, <code>fibs</code> isn’t assigned any class at all, and (iii) the
assignment operator is also in the “other” class, instead of something
related to it being a built in operator! As one can imagine, this only
gets worse as snippets get more complicated.
<p></p>
These kinds of issues, combined with the fact that certain
languages—like Emacs Lisp—don’t have any syntax definitions at all,
annoyed me enough to look for an alternative way to highlight code on
this website.<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">All of this work for a mostly greyscale theme!</span></span>
 There are of course many options to choose from; I
went with <code>pygmentize</code>, solely because I already had it installed. All
that’s left is to tell pandoc and Hakyll to make use of it. As
mentioned, this thankfully doesn’t turn out to be very difficult!
<h2 id="playing-with-pygmentize">Playing with <code>pygmentize</code></h2>
<p></p>
Having never used <code>pygmentize</code> as a command line utility,<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">So far, the only interaction I had with the program was through
the excellent <a href="https://ctan.org/pkg/minted?lang=en">minted</a> LaTeX package.</span></span>
 I expected
this to take some work—possibly involving Python <em>shudder</em>—but all of
the necessary pieces are already present in the <span class="small-caps">cli</span>. First up, the <code>-f</code>
option specifies the formatter to use, which will decide the shape of
the output.
<div class="highlight"><pre><span></span><span class="gp">$ </span>pygmentize<span class="w"> </span>-L<span class="w"> </span>formatter<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>html
<span class="go">* html:</span>
<span class="go">    Format tokens as HTML 4 ``&lt;span&gt;`` tags within a ``&lt;pre&gt;`` tag, wrapped in a ``&lt;div&gt;`` tag. The ``&lt;div&gt;``'s CSS class can be set by the `cssclass` option. (filenames *.html, *.htm)</span>
</pre></div>

<p></p>
We can test how this highlighting looks straight away; executing
<div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;fibs :: [Integer]\nfibs = 0 : scanl' (+) 1 fibs&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="se">\ </span><span class="p">|</span><span class="w"> </span>pygmentize<span class="w"> </span>-l<span class="w"> </span>haskell<span class="w"> </span>-f<span class="w"> </span>html
</pre></div>

<p></p>
produces an <span class="small-caps">html</span> output along the lines of
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;highlight&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">pre</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nf&quot;</span><span class="p">&gt;</span>fibs <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ow&quot;</span><span class="p">&gt;</span>:: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>[<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;kt&quot;</span><span class="p">&gt;</span>Integer <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>] <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nf&quot;</span><span class="p">&gt;</span>fibs <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ow&quot;</span><span class="p">&gt;</span>= <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mi&quot;</span><span class="p">&gt;</span>0 <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;kt&quot;</span><span class="p">&gt;</span>: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">&gt;</span>scanl<span class="ni">&amp;#39;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>(<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;o&quot;</span><span class="p">&gt;</span>+ <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>) <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mi&quot;</span><span class="p">&gt;</span>1 <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">&gt;</span>fibs <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>

<p></p>
This looks much better! The class names are kind of obtuse, but
<code>pygmentize</code> can also give you nicely annotated <span class="small-caps">css</span> styles for its
supported colour schemes. For example, the following is a small excerpt
of the output:
<div class="highlight"><pre><span></span><span class="gp">$ </span>pygmentize<span class="w"> </span>-S<span class="w"> </span>emacs<span class="w"> </span>-f<span class="w"> </span>html
<span class="go">…</span>
<span class="go">.nf { color: #00A000 }                    /* Name.Function */</span>
<span class="go">.ow { color: #AA22FF; font-weight: bold } /* Operator.Word */</span>
<span class="go">.kt { color: #00BB00; font-weight: bold } /* Keyword.Type */</span>
<span class="go">.w { color: #bbbbbb }                     /* Text.Whitespace */</span>
<span class="go">.c { color: #008800; font-style: italic } /* Comment */</span>
<span class="go">…</span>
</pre></div>

<p></p>
You can redirect this into a <code>pygments.css</code> file, link to it (e.g., from
your <code>default.html</code> template), and be on your way. The annotation also
makes it very easy to change that file after the fact, in case
<code>pygmentize</code> does not have the theme that you want.
<h2 id="integration">Integration</h2>
<p></p>
The idea of what we want to do is quite simple: for every code block in
a given post, shell out to <code>pygmentize</code>, and use its output to replace
the block, somehow making sure pandoc doesn’t touch it afterwards.
Let’s solve this step by step.
<h3 id="pandoc">Pandoc</h3>
<p></p>
Pandoc has an aptly named <code>Pandoc</code> type, which represents the internal
structure of a document.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="kt">Meta</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
</pre></div>

<p></p>
We’ll neglect the metadata for now and just look at the <code>Block</code>s;
specifically, we want to zoom in on two constructors that will give you
everything we need:
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Block</span>
<span class="w">  </span><span class="c1">-- Lots of other constructors omitted</span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="kt">Attr</span><span class="w"> </span><span class="kt">Text</span><span class="w">   </span><span class="c1">-- ^ Code block (literal) with attributes</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">RawBlock</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="kt">Text</span><span class="w">  </span><span class="c1">-- ^ Raw block</span>

<span class="c1">-- | Attributes: identifier, classes, key-value pairs</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Attr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="kt">Text</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">Text</span><span class="p">],</span><span class="w"> </span><span class="p">[(</span><span class="kt">Text</span><span class="p">,</span><span class="w"> </span><span class="kt">Text</span><span class="p">)])</span>

<span class="c1">-- | Formats for raw blocks</span>
<span class="kr">newtype</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="kt">Text</span>
</pre></div>

<p></p>
To get a feeling for how these <code>CodeBlock</code>s look, again consider our
<code>fibs</code> example from above. By default, the corresponding <code>CodeBlock</code>
for this would look something like
<div class="highlight"><pre><span></span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;haskell&quot;</span><span class="p">],</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span>
<span class="w">          </span><span class="s">&quot;fibs :: [Integer]</span><span class="se">\n</span><span class="s">fibs = 0 : scanl' (+) 1 fibs&quot;</span>
</pre></div>

<p></p>
Importantly, the language (if any) is the first argument of the
<code>classes</code> field of <code>Attr</code>.
<p></p>
A strategy begins to form: look for all occurences of a <code>CodeBlock</code> in
the <code>Pandoc</code> type, and replace it with a <code>RawBlock "html"</code> such that it
isn’t touched anymore. Doing so will not pose very many
challenges—pandoc has really great capabilities for
<a href="https://hackage.haskell.org/package/pandoc-types/docs/Text-Pandoc-Walk.html">walking</a> its <span class="small-caps">ast</span> in order to facilitate exactly these
kinds of changes. Unsurprisingly, the <code>Walkable</code> class resides over all
things walkable; an abbreviated definition looks like this:
<div class="highlight"><pre><span></span><span class="kr">class</span><span class="w"> </span><span class="kt">Walkable</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="c1">-- | @walk f x@ walks the structure @x@ (bottom up) and replaces every</span>
<span class="w">  </span><span class="c1">-- occurrence of an @a@ with the result of applying @f@ to it.</span>
<span class="w">  </span><span class="n">walk</span><span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b</span>
<span class="w">  </span><span class="n">walk</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runIdentity</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">walkM</span><span class="w"> </span><span class="p">(</span><span class="n">return</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">f</span><span class="p">)</span>

<span class="w">  </span><span class="c1">-- | A monadic version of 'walk'.</span>
<span class="w">  </span><span class="n">walkM</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Applicative</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Functor</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span>
</pre></div>

<p></p>
Specifically, as we’ll need to shell out to an external program, let us
restrict our attention to the more general <code>walkM</code> function here. There
is an instance
<div class="highlight"><pre><span></span><span class="kr">instance</span><span class="w"> </span><span class="kt">Walkable</span><span class="w"> </span><span class="kt">Block</span><span class="w"> </span><span class="kt">Pandoc</span>
</pre></div>

<p></p>
which will be all that we need. The necessary code now just
materialises in front of our eyes:<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">If all else fails, simply <a href="https://aphyr.com/posts/353-rewriting-the-technical-interview">trace the sigils in the air and give
them form</a>.</span></span>
<div class="highlight"><pre><span></span><span class="c1">-- {-# LANGUAGE BlockArguments    #-}</span>
<span class="c1">-- {-# LANGUAGE LambdaCase        #-}</span>
<span class="c1">-- {-# LANGUAGE OverloadedStrings #-}</span>
<span class="c1">-- {-# LANGUAGE ViewPatterns      #-}</span>
<span class="c1">--</span>
<span class="c1">-- import Data.Maybe (fromMaybe, listToMaybe)</span>
<span class="c1">-- import qualified Data.Text as T</span>
<span class="c1">-- import Hakyll</span>
<span class="c1">-- import System.Process (readProcess)</span>
<span class="c1">-- import Text.Pandoc.Definition (Block (CodeBlock, RawBlock), Pandoc)</span>
<span class="c1">-- import Text.Pandoc.Walk (walk, walkM)</span>

<span class="nf">pygmentsHighlight</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="kt">Pandoc</span>
<span class="nf">pygmentsHighlight</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">walkM</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">  </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">lang</span><span class="p">)</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">unsafeCompiler</span><span class="w"> </span><span class="p">(</span><span class="n">callPygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
<span class="w">  </span><span class="n">block</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="n">block</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">pygs</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="n">pygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">readProcess</span><span class="w"> </span><span class="s">&quot;pygmentize&quot;</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;-l&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lang</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">]</span>
</pre></div>

<p></p>
Notice how <em>a priori</em> this would have type <code>Pandoc -&gt; IO Pandoc</code>, but
since we want to use it from Hakyll I’ve already inserted a call to
<code>unsafeCompiler</code> in the correct place.
<p></p>
Further, the above code checks whether the block has an explicit
language attached to it and, if not, leaves it alone; this was suggested
by <a href="https://old.reddit.com/r/haskell/comments/10ilrui/pygmentising_hakylls_syntax_highlighting/j5fih5h/">LSLeary</a> on Reddit. If you want to have a single <code>div</code> class for
every code block—say, for some custom <span class="small-caps">css</span>—then you can replace
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">lang</span><span class="p">)</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">unsafeCompiler</span><span class="w"> </span><span class="p">(</span><span class="n">callPygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</pre></div>

<p></p>
with
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">listToMaybe</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">mbLang</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="p">(</span><span class="n">fromMaybe</span><span class="w"> </span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="n">mbLang</span><span class="p">)</span>
<span class="w">    </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">unsafeCompiler</span><span class="w"> </span><span class="p">(</span><span class="n">callPygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</pre></div>

<h3 id="hakyll">Hakyll</h3>
<p></p>
Thankfully, integrating <code>pygmentsHighlight</code> into Hakyll is not very
complicated either. In addition to the normal <code>pandocCompiler</code> or
<code>pandocCompilerWith</code> functions that you are probably already using,
there is also <a href="https://hackage.haskell.org/package/hakyll-4.15.1.1/docs/Hakyll-Web-Pandoc.html#v:pandocCompilerWithTransformM">pandocCompilerWithTransformM</a>:
<div class="highlight"><pre><span></span><span class="nf">pandocCompilerWithTransformM</span>
<span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="kt">ReaderOptions</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">WriterOptions</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="kt">Pandoc</span><span class="p">)</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
</pre></div>

<p></p>
Basically, in additions to reader and writer options, it also takes a
monadic transformation of pandoc’s <span class="small-caps">ast</span> and builds an appropriate
<code>Compiler</code> from that.
<div class="highlight"><pre><span></span><span class="c1">-- import Hakyll</span>
<span class="c1">-- import Text.Pandoc.Options</span>

<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">pandocCompilerWithTransformM</span>
<span class="w">    </span><span class="n">defaultHakyllReaderOptions</span>
<span class="w">    </span><span class="n">defaultHakyllWriterOptions</span>
<span class="w">    </span><span class="n">pygmentsHighlight</span>
</pre></div>

<p></p>
The <code>myPandocCompiler</code> function can now be used as any other compiler;
for example:
<div class="highlight"><pre><span></span><span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">hakyll</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="c1">-- …</span>
<span class="w">  </span><span class="n">match</span><span class="w"> </span><span class="s">&quot;posts/**.md&quot;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="n">route</span><span class="w"> </span><span class="p">(</span><span class="n">setExtension</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">compile</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">myPandocCompiler</span>
<span class="w">          </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">loadAndApplyTemplate</span><span class="w"> </span><span class="s">&quot;templates/default.html&quot;</span><span class="w"> </span><span class="n">defaultContext</span>
<span class="w">          </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">relativizeUrls</span>
<span class="w">  </span><span class="c1">-- …</span>
</pre></div>

<p></p>
For a full working example, see <a href="https://github.com/slotThe/slotThe.github.io/blob/main/src/site.hs#L87">my configuration</a>.
<h2 id="conclusion">Conclusion</h2>
<p></p>
That’s it! To my eyes, syntax highlighting looks much better now, and
on the way I—and perhaps you as well—even learned a little bit about how
pandoc internally represents its documents. Time well spent. As I said
in the beginning, in principle one could swap out <code>pygmentize</code> for any
other syntax highlighter that can produce <span class="small-caps">html</span>. However, for me these
results are good enough that I will probably not try out every tool
under the sun, chasing that ever present epsilon of highlighting cases
which I still don’t agree with—at least for now.

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Immediately Refile Notes with X.P.OrgMode</title>
    <link href="https://tony-zorman.com/posts/2023-01-14-orgmode-refiling.html" />
    <id>https://tony-zorman.com/posts/2023-01-14-orgmode-refiling.html</id>
    <published>2023-01-14T00:00:00Z</published>
    <updated>2023-01-14T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-14
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>, <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
In a <a href="/posts/orgmode-prompt/2022-08-27-xmonad-and-org-mode.html">previous post</a> I talked about
<a href="https://xmonad.github.io/xmonad-docs/xmonad-contrib/XMonad-Prompt-OrgMode.html">XMonad.Prompt.OrgMode</a>, an <span class="small-caps">xm</span>onad module to rapidly capture thoughts
and ideas into an Org file. The functionality that the module provides
has proven to be extremely useful to me, and really I couldn’t be
happier with it. However, a user recently contacted me by email and
told me that they’re missing but one feature: the ability to immediately
refile notes.
<!--more-->
<h2 id="motivation">Motivation</h2>
<p></p>
If you don’t know, <a href="https://orgmode.org/manual/Refile-and-Copy.html">refiling</a> is the act of moving an entry<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">A headline, possibly with an attached body.</span></span>
 <em>below</em>
another heading; i.e., such that it becomes a subheading there. This
can be useful for structuring <span class="small-caps">todo</span>s into separate categories: one might
have projects called “work”, “life”, “<span class="small-caps">xm</span>onad”, and so on, where all
related tasks live. Quite convenient!
<p></p>
So far, X.P.OrgMode just dumped the created note at the end of the
specified file, leaving you to pick up the pieces. This aligns with my
personal workflow—while I extensively use refiling, I only do so at the
end of the day after reviewing all tasks that have accumulated.
However, it is conceivable that someone might want to refile certain
tasks straight away when it’s pretty clear that (i) they’ll be kept, and
(ii) they can be unambiguously assigned to a certain heading (e.g., an
already scheduled work meeting with X).
<h2 id="showcase">Showcase</h2>
<p></p>
Long story short, this is now built into X.P.OrgMode. There are two new
functions:
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">orgPromptRefile</span><span class="w">   </span><span class="ow">::</span><span class="w"> </span><span class="kt">XPConfig</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w">           </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">FilePath</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="w">    </span><span class="n">orgPromptRefileTo</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">XPConfig</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">FilePath</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
</pre></div>

<p></p>
The former takes the same arguments as <a href="https://hackage.haskell.org/package/xmonad-contrib-0.17.1/docs/XMonad-Prompt-OrgMode.html#v:orgPrompt">orgPrompt</a> (which see), and is
for popping up another prompt that asks for a heading. The latter
refiles everything under the specified (as the second argument) heading.
<p></p>
The way <code>orgPromptRefile</code> works is that, after querying for a <span class="small-caps">todo</span>, it
<em>always</em> inserts the note into the file and then <em>possibly</em> refiles it
to another heading. This way, you don’t need to worry about losing
notes when you abort the refiling prompt or enter a non-existent
heading.
<p></p>
<img class="pure-img" src="../images/orgmode-refiling/refiling.gif">
<p></p>
Note: Refiling is (near) instant; the delay you are seeing above is due
to <code>auto-revert-mode</code>.
<h3 id="some-gory-details">Some Gory Details</h3>
<p></p>
All of the refiling is actually directly done by Emacs itself! More
precisely, the <span class="small-caps">edsl</span> that <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-Run.html">XMonad.Util.Run</a> defines—which I’ve also
<a href="/posts/2022-05-25-calling-emacs-from-xmonad.html">written about</a>—shells out to Emacs. This
might intuitively <em>feel</em> horrible, but that’s just another reason to
share it:
<div class="highlight"><pre><span></span><span class="nf">refile</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">FilePath</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">refile</span><span class="w"> </span><span class="p">(</span><span class="n">asString</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">asString</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">fp</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEmacs</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">asBatch</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">progn</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="s">&quot;find-file&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">fp</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;end-of-buffer&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;org-refile nil nil&quot;</span>
<span class="w">                    </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nil&quot;</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="n">saveExcursion</span>
<span class="w">                               </span><span class="p">[</span><span class="s">&quot;org-find-exact-headline-in-buffer&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">parent</span><span class="p">]</span>
<span class="w">                            </span><span class="p">]</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;save-buffer&quot;</span>
<span class="w">                </span><span class="p">])</span>
</pre></div>

<p></p>
This—as you probably guessed already—just executes the following elisp
snippet in Emacs’s batch mode:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">progn</span>
<span class="w">  </span><span class="p">(</span><span class="nv">find-file</span><span class="w"> </span><span class="err">«</span><span class="nv">fp</span><span class="err">»</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">end-of-buffer</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">org-refile</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span>
<span class="w">              </span><span class="p">(</span><span class="nf">list</span><span class="w"> </span><span class="err">«</span><span class="nv">parent</span><span class="err">»</span><span class="w"> </span><span class="err">«</span><span class="nv">fp</span><span class="err">»</span><span class="w"> </span><span class="no">nil</span>
<span class="w">                    </span><span class="p">(</span><span class="k">save-excursion</span>
<span class="w">                      </span><span class="p">(</span><span class="nv">org-find-exact-headline-in-buffer</span><span class="w"> </span><span class="err">«</span><span class="nv">parent</span><span class="err">»</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">save-buffer</span><span class="p">))</span>
</pre></div>

<p></p>
I know this seems insane, but letting Emacs do this work is actually
much less brittle than the alternative. The Org maintainers certainly
know best what refiling <em>means</em>, and thus also what it entails—if all of
this logic is already written, why not take advantage of it? Plus, I
now don’t have to keep track of subtle changes in newer versions of Org.
<h2 id="closing-thoughts">Closing Thoughts</h2>
<p></p>
Writing this was actually a lot of fun, and a great opportunity to play
with the <span class="small-caps">edsl</span> that X.U.Run exposes. I reckon there are a few places in
my own <span class="small-caps">xm</span>onad configuration in which I could use these kinds of “Emacs
scripts” to great effect!
<p></p>
One other idea I’ve had is to integrate this into the language that
plain old <code>orgPrompt</code> accepts. It could be prefixed by something like
“<code>ref:</code>”, followed by a unique substring with which to identity a
heading. This would have the disadvantage that—without the second
prompt—one would not get any suggestions for headings. However, if you
want to refile something you probably know where you want to put it;
plus, it would not involve a possibly distracting second prompt.
Actually, this sounds like a good first pull request: contributions
welcome!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>XMonad Module Showcase: X.A.TopicSpace</title>
    <link href="https://tony-zorman.com/posts/topic-space/2022-09-11-topic-spaces.html" />
    <id>https://tony-zorman.com/posts/topic-space/2022-09-11-topic-spaces.html</id>
    <published>2022-09-11T00:00:00Z</published>
    <updated>2022-09-11T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-09-11
      
        | <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
One of my favourite—and most used—modules is XMonad.Actions.TopicSpace.
However, it seems relatively unknown among the general <span class="small-caps">xm</span>onad community.
I fear this is due to the fact that the module is quite old and formerly
had a rather high barrier to entry. Despite having been given shiny
<a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Actions-TopicSpace.html">new documentation</a>, lots of people probably did not bother
revisiting it and thus still don’t really understand why they might be
interested in using topics instead of workspaces. Time to change that!
<!--more-->
<h2 id="introduction">Introduction</h2>
<p></p>
First, this post is not to be seen as a tutorial on X.A.TopicSpace, but
much rather as a showcase of how its functionality could be used day to
day. If you like what you see, perhaps check out the
<a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Actions-TopicSpace.html">docs</a> and give it a spin yourself! I have already written
an introduction to the module in the post about my <a href="../phd-workflow/2022-05-01-my-phd-workflow.html">research workflow</a>:
<blockquote>
<p></p>
<span class="small-caps">xm</span>onad has a module called TopicSpace, which upgrades the X11
workspace—virtual desktop—concept to so-called topics. These are
workspaces with a “theme” associated to them; for example, I have a
topic for every project that I’m currently working on. This results
in a clean separation of concerns. Plus, I always know where my
windows are!
<p></p>
Every topic has a directory and a “startup hook”, firing when the
topic is switched to and empty, associated to it. While most
convenient for programming related tasks—e.g., spawn <code>ghcid</code> in the
relevant directory or automatically build and open this website—it’s
also quite convenient for mathematical projects.
<p></p>
I have set up special keybindings to bring up an Emacs session in the
topic directory, or spawn a terminal there. Switching to topics is
done fuzzily via the <span class="small-caps">xm</span>onad prompt, which means I only have to type a
few characters to get to my destination. This makes it feasible to
have 30 topics, instead of the usual 9 or so, in the first place. As
a result, it’s rather fast to go from thinking about a certain problem
to working on it.
</blockquote>
<p></p>
At a glance, this probably does not sound very impressive—so one can
have a directory and some function associated to a workspace (hereafter
also called “topic”), big deal. However, we will see that with a bit of
creativity this can be used to great effect.
<h2 id="examples">Examples</h2>
<h3 id="basic-topics">Basic topics</h3>
<p></p>
The most obvious application of all of this is to have workspaces that
do one and only one thing. For example, I have a topic dedicated to
connecting to a VPN, should the need arise. Naturally, I automatically
want to execute <code>openvpn</code> and pick a random server whenever I happen to
enter that workspace and it’s empty (i.e., <code>openvpn</code> is not already
running).
<p></p>
More such use cases include having a topic dedicated to my RSS feed
reader, instant messaging, or IRC. Since I only show workspaces with
windows on them in xmobar, I can just glance at my status bar to find
out whether I currently have, for example, IRC open. No additional
program for checking the status of things necessary! Obviously, this
<em>modus operandi</em> takes a bit of discipline to uphold over the course of
the day, but I find that such a separation of concerns greatly reduces
mental load regarding what’s currently happening on my computer.
Definitely worth it.
<p></p>
In terms of code, this—as well as the following examples—heavily use the
<a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-Run.html#g:EDSL">new interface</a> to XMonad.Util.Run, which allows one to
spawn processes in a declarative and compositional way; I’ve <a href="../2022-05-25-calling-emacs-from-xmonad.html">written
about this</a> in another post. For example, my RSS topic is
specified thusly:
<div class="highlight"><pre><span></span><span class="c1">-- import XMonad.Actions.TopicSpace (inHome)</span>
<span class="c1">-- import XMonad.Util.Run</span>

<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">inHome</span><span class="w"> </span><span class="s">&quot;7:RSS&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEditor</span>
<span class="w">                        </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setFrameName</span><span class="w"> </span><span class="s">&quot;elfeed&quot;</span>
<span class="w">                        </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="p">(</span><span class="n">elispFun</span><span class="w"> </span><span class="s">&quot;elfeed&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
Here, <code>inHome</code> is a little helper function that takes a topic name and
an action, and creates a new topic with <code>$HOME</code> as its associated
directory.
<p></p>
You can find all of my topics (and there are a lot of them)
<a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs#L219-L265">here</a>.
<h3 id="spawning-everything-in-the-topic-directory">Spawning <em>everything</em> in the topic directory</h3>
<p></p>
More generally, programming projects in the same language almost always
require me to open the same set of standard tools, so it’s extremely
convenient to directly spawn them upon first visit. This allows for
very little friction before starting to work on whatever I wanted to
work on.
<p></p>
For example, I want to open Emacs and <a href="https://github.com/ndmitchell/ghcid">ghcid</a> in every Haskell project
of mine—so why not automate this? Using what X.U.Run gives us, we can
quickly throw together a function that executes the given instruction
inside of a terminal:
<div class="highlight"><pre><span></span><span class="c1">-- import XMonad.Actions.TopicSpace (currentTopicDir)</span>
<span class="c1">-- 'topicConfig' is my personal topic configuration.</span>

<span class="c1">-- | Execute a program in the topic directory (inside a terminal).</span>
<span class="nf">executeInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">executeInTopic</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="p">(</span><span class="n">termInDir</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span><span class="p">)</span>
<span class="w">                      </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">p</span>
</pre></div>

<p></p>
Similar functions can be created for spawning the terminal and editor:
<div class="highlight"><pre><span></span><span class="c1">-- Whatever you're looking for, it's probably in X.A.TopicSpace</span>
<span class="c1">-- or X.U.Run.</span>

<span class="c1">-- | Spawn terminal in topic directory.</span>
<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">termInDir</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>

<span class="c1">-- | Spawn editor in the current topic directory.</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>
</pre></div>

<p></p>
Check the documentation of <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-Run.html#g:EDSL">XMonad.Util.Run</a> to see how <code>inEditor</code> and
<code>termInDir</code> are defined and may be customised.
<p></p>
In my mathematical and other work-adjacent projects I keep it pretty
simple; an editor there is mostly sufficient.
<p></p>
<img class="pure-img" src="../phd-workflow/topics.gif">
<p></p>
We can also get a little bit more fancy. Since the topic action is just
a general <code>X</code> action, we can really do anything we want in there. In
addition to spawning programs, all of my Haskell projects should default
to the <code>Hacking</code><!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">In case you are interested:
<div class="highlight"><pre><span></span><span class="nf">hacking</span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="n">renamed</span><span class="w"> </span><span class="p">[</span><span class="kt">Replace</span><span class="w"> </span><span class="s">&quot;Hacking&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">limitWindows</span><span class="w"> </span><span class="mi">3</span>
<span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">magnify</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="p">(</span><span class="kt">NoMaster</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="kt">True</span>
<span class="w">  </span><span class="o">$</span><span class="w"> </span><span class="kt">ResizableTall</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="kt">[]</span>
</pre></div>

<p></p>
As the rest of my dotfiles, it’s available
<a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs#L341">here</a>.</span></span>
 layout:
<div class="highlight"><pre><span></span><span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sendMessage</span><span class="w"> </span><span class="p">(</span><span class="kt">JumpToLayout</span><span class="w"> </span><span class="s">&quot;Hacking&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spawnEditorInTopic</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">executeInTopic</span><span class="w"> </span><span class="s">&quot;ghcid&quot;</span>
</pre></div>

<p></p>
And Voilà, we can now attach this action to all the topics that we want!
<p></p>
Note that the <code>*&gt;</code> operator is—in this case—just the sequencing of
actions. If you’re more comfortable with <code>do</code> notation, you can also
write the above as
<div class="highlight"><pre><span></span><span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">sendMessage</span><span class="w"> </span><span class="p">(</span><span class="kt">JumpToLayout</span><span class="w"> </span><span class="s">&quot;Hacking&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">spawnEditorInTopic</span>
<span class="w">  </span><span class="n">executeInTopic</span><span class="w"> </span><span class="s">&quot;ghcid&quot;</span>
</pre></div>

<p></p>
Furthermore, since the associated directory for a topic can easily be
made <code>$HOME</code> by default (as we’ve seen, TopicSpace even exports the
<code>inHome</code> function), spawning programs in certain topics can easily be
made to replace the default keybindings!
<p></p>
For the sake of completeness, I will showcase one slightly more
complicated example. My main shell environment is <code>eshell</code> and getting
sane behaviour there presents one with a few more obstacles than
<code>spawnTermInTopic</code> did. It also uses <code>inProgram</code> instead of <code>inEditor</code>,
allowing access to a different instance of the Emacs server.
<div class="highlight"><pre><span></span><span class="c1">-- | Spawn an eshell frame in the current topic directory.</span>
<span class="nf">spawnEshellInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnEshellInTopic</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="nf">\</span><span class="n">dir</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inProgram</span><span class="w"> </span><span class="s">&quot;emacsclient -a '' -c -s eshell&quot;</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="p">(</span><span class="n">progn</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s">&quot;eshell&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">quote</span><span class="w"> </span><span class="s">&quot;new-shell&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eshell/cd&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">asString</span><span class="w"> </span><span class="n">dir</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eshell/clear-scrollback&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eshell-send-input&quot;</span>
<span class="w">                        </span><span class="p">])</span>
</pre></div>

<p></p>
All in all, we have something that looks a little bit like this:
<p></p>
<img class="pure-img" src="./haskell-topic.gif">
<h3 id="testing-this-website">Testing this website</h3>
<p></p>
Much in the same vein as my Haskell topics, I find the <code>website</code> topic
to be extremely handy—you can probably guess what it’s used for. Its
associated function <code>spawnWebsite</code> switches to the “Tall” layout, spawns
an Emacs frame in the topic directory, builds the website, and opens a
browser window pointing to the local copy:
<div class="highlight"><pre><span></span><span class="nf">spawnWebsite</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnWebsite</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">switchToLayout</span><span class="w"> </span><span class="s">&quot;Tall&quot;</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spawnEditorInTopic</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">executeInTopic</span><span class="w"> </span><span class="s">&quot;hakyll-build.sh --hold&quot;</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spawn</span><span class="w"> </span><span class="s">&quot;browser-new-window.sh localhost:8000&quot;</span>
</pre></div>

<p></p>
The whole thing looks like this:
<p></p>
<img class="pure-img" src="./website.gif">
<h2 id="conclusion">Conclusion</h2>
<p></p>
Hopefully these examples have convinced you to give TopicSpace a spin;
perhaps you’ve even gotten some ideas of your own you’d like to try out.
Although conceptually very simple, the module can be used in a variety
of ways to automate boring tasks just that tiny bit more—definitely a
win in my book!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Calling Emacs from XMonad</title>
    <link href="https://tony-zorman.com/posts/2022-05-25-calling-emacs-from-xmonad.html" />
    <id>https://tony-zorman.com/posts/2022-05-25-calling-emacs-from-xmonad.html</id>
    <published>2022-05-25T00:00:00Z</published>
    <updated>2022-05-25T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-05-25
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>, <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
In the post about my <a href="/posts/phd-workflow/2022-05-01-my-phd-workflow.html#citations">research workflow</a>, I briefly mentioned having to
call Emacs—or other external programs—from within <span class="small-caps">xm</span>onad. I figured
that this was perhaps something that could be of use to more people than
just me. After a little bit of deliberation and coming up with a
generic enough API, I decided to turn it into an <span class="small-caps">xm</span>onad module!
<p></p>
Yesterday these changes were merged into <a href="https://github.com/xmonad/xmonad-contrib">xmonad-contrib</a>, and they are
now available for everyone to try out; provided one has the git version
of <span class="small-caps">xm</span>onad <a href="https://xmonad.org/INSTALL.html">installed</a>.<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">If you <em>really</em> want to try this feature but don’t want to bother
installing any unreleased—though stable—version, message me in any
way and maybe we’ll hurry up and cut 0.17.1 soon!</span></span>
<p></p>
I’d like to use this opportunity to both showcase the module—how and why
one would use it—and talk a little bit about its only redeeming
implementation detail.
<!--more-->
<h2 id="main-use-cases">Main Use Cases</h2>
<p></p>
Wouldn’t it be neat to have some kind of <a href="https://en.wikipedia.org/wiki/Domain-specific_language"><span class="small-caps">edsl</span></a> for spawning external
processes? Something where one can just compose Haskell functions
together, not having to worry about the actual underlying string
manipulations? Something that’s composable, so that one does not have
to write the same <code>"emacsclient -c -a '' …"</code> or <code>"alacritty --working-directory …"</code> prefix over and over again? Well, at least
that’s what I thought on some rainy afternoon a few months ago.
<h3 id="scratchpads">Scratchpads</h3>
<p></p>
The first use case that I came up with was <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-NamedScratchpad.html">scratchpad</a>s. The idea of
these things is simple: while we normally don’t like floating windows,
it’s quite convenient to have some of them around that one can bring to
the current workspace, as well as hide, with a single keybinding. This
is useful for things like email, a calendar, a daily agenda, a
calculator, etc.
<p></p>
For scratchpads to work reliably, windows need to have some unique
characteristic they can be recognised by, like a special <a href="https://tronche.com/gui/x/icccm/sec-4.html#WM_CLASS">class or
instance name</a>. Endowing an application with additional properties
sounds exactly like what our <span class="small-caps">edsl</span> should be good at, so let’s try that!
<p></p>
Using the new features of <code>XMonad.Util.Run</code>, we could spawn an Emacs
frame with a special name for our scratchpad hooks to grab onto, and
execute <code>notmuch</code>:
<div class="highlight"><pre><span></span><span class="nf">mailSession</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="kt">String</span>
<span class="nf">mailSession</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">getInput</span><span class="w"> </span><span class="o">$</span>
<span class="w">  </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setFrameName</span><span class="w"> </span><span class="n">mailInstName</span>
<span class="w">           </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="s">&quot;notmuch&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
You can read the <code>&gt;-&gt;</code> operator a little like a pipe, where you start
with what you want and thread that information through to the end: “I
want an editor with a certain frame name that also starts up notmuch”.
<p></p>
In full, the above function would produce the string (broken into a few
lines for better readability)
<div class="highlight"><pre><span></span>&quot;emacsclient -c -a ''
             -F '(quote (name . \&quot;notmuch-scratch\&quot;))'
             --eval '(notmuch)'&quot;
</pre></div>

<p></p>
which would be quite bothersome to type indeed.
<p></p>
Because the type of <code>mailSession</code> is <code>X String</code> and not just <code>String</code>,
the setup for this is a little bit different than usual when using
scratchpads. You would use it like this:
<div class="highlight"><pre><span></span><span class="nf">myScratchpads</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="p">[</span><span class="kt">NamedScratchpad</span><span class="p">]</span>
<span class="nf">myScratchpads</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="c1">-- First, get the finished string.</span>
<span class="w">  </span><span class="n">mailSession</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">getInput</span><span class="w"> </span><span class="o">$</span>
<span class="w">    </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setFrameName</span><span class="w"> </span><span class="n">mailInst</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">elispFun</span><span class="w"> </span><span class="s">&quot;notmuch&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="c1">-- Now we can insert it into our scratchpads as normal.</span>
<span class="w">  </span><span class="n">pure</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="kt">NS</span><span class="w"> </span><span class="s">&quot;Mail&quot;</span><span class="w"> </span><span class="n">mailSession</span><span class="w"> </span><span class="p">(</span><span class="n">appName</span><span class="w"> </span><span class="o">=?</span><span class="w"> </span><span class="n">mailInst</span><span class="p">)</span><span class="w"> </span><span class="n">quake</span><span class="w"> </span><span class="p">]</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">mailInst</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;notmuch-scratch&quot;</span>
<span class="w">  </span><span class="n">quake</span><span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="n">customFloating</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">RationalRect</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>

<span class="c1">-- The call to @namedScratchpadManageHook@ in the manageHook also</span>
<span class="c1">-- needs to be slightly adjusted.</span>
<span class="nf">myManageHook</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">ManageHook</span>
<span class="nf">myManageHook</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mconcat</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="err">…</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">namedScratchpadManageHook</span><span class="w"> </span><span class="o">=&lt;&lt;</span><span class="w"> </span><span class="n">liftX</span><span class="w"> </span><span class="n">myScratchpads</span>
<span class="w">  </span><span class="p">]</span>
</pre></div>

<p></p>
Normally you would also add your <code>myScratchpads</code> list to all calls of
<code>namedScratchpadAction</code>; e.g., when you define the keys to call your
scratchpads. However, since the former lives in <code>X</code> now, this doesn’t
work anymore! Thankfully,
<a href="https://github.com/xmonad/xmonad-contrib/commit/3fc830aa09368dca04df24bf7ec4ac817f2de479">nowadays</a>
the first argument to <code>namedScratchpadAction</code> is actually unused and
only there for backwards compatibility. This means that it’s not
necessary to enter your scratchpads there at all if they are added to
your <code>manageHook</code>. For example, in the following I just provide the empty list:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="p">(</span><span class="s">&quot;M-C-t&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">namedScratchpadAction</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="s">&quot;Mail&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
This works all the same with the above definition of <code>myScratchpads</code>.
<p></p>
A full example of how a scratchpad setup would look using this machinery
can be found in <a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs#L414">my config</a>.
<h3 id="calling-emacs-in-scripts">Calling Emacs in Scripts</h3>
<p></p>
Spawning frames is nice and all, but how about something more
complicated, like Emacs’s batch mode so that we can use it properly in
scripts? No problem at all!
<p></p>
For example, I have the following snippet in my config to get the
currently selected text and call <a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a> with it to <a href="/posts/phd-workflow/2022-05-01-my-phd-workflow.html#citations">produce a
citation entry in my bibliography
files</a>:
<div class="highlight"><pre><span></span><span class="nf">callArXiv</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">callArXiv</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">getSelection</span><span class="w">  </span><span class="c1">-- from X.U.XSelection</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEmacs</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">withEmacsLibs</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="kt">ElpaLib</span><span class="w"> </span><span class="s">&quot;dash&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">ElpaLib</span><span class="w"> </span><span class="s">&quot;s&quot;</span>
<span class="w">                       </span><span class="p">,</span><span class="w"> </span><span class="kt">ElpaLib</span><span class="w"> </span><span class="s">&quot;arxiv-citation&quot;</span>
<span class="w">                       </span><span class="p">,</span><span class="w"> </span><span class="kt">Special</span><span class="w"> </span><span class="s">&quot;~/.config/emacs/private-stuff.el&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">asBatch</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">progn</span><span class="w"> </span><span class="p">[</span><span class="n">require</span><span class="w"> </span><span class="s">&quot;arxiv-citation&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">asString</span><span class="w"> </span><span class="n">url</span><span class="p">])</span>
</pre></div>

<p></p>
When executed, this translates to something like
<div class="highlight"><pre><span></span>emacs -L /home/slot/.config/emacs/elpa/dash-20220417.2250
      -L /home/slot/.config/emacs/elpa/s-20210616.619
      -L /home/slot/.config/emacs/elpa/arxiv-citation-20220510.1137/
      --batch
      --eval '(progn
                (require (quote arxiv-citation))
                (arXiv-citation &quot;&lt;url-in-the-primary-selection&gt;&quot;))'
</pre></div>

<p></p>
I certainly know which one I’d rather type—especially with <span class="small-caps">elpa</span>
directory names changing quite frequently! On that note,
<a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a> is on <span class="small-caps">melpa</span> now; yay!
<h3 id="other-programs">Other Programs</h3>
<p></p>
As this is my main use case for it, the new features of
<code>XMonad.Util.Run</code> are quite specialised for Emacs. However, even for
other programs they may well come in handy. Drawing from the point
about scratchpads again, here is a hypothetical one that spawns a ghci
session:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="n">ghci</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inTerm</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setXClass</span><span class="w"> </span><span class="n">calcInstName</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="s">&quot;ghci&quot;</span>
</pre></div>

<p></p>
Further, something that’s useful when dealing with <a href="/posts/phd-workflow/2022-05-01-my-phd-workflow.html#topics">topic-based
workspaces</a>
is spawning a terminal or an editor already in the current topic
directory:
<div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">XMonad.Actions.TopicSpace</span><span class="w">  </span><span class="c1">-- for currentTopicDir and more</span>
<span class="nf">topicConfig</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="err">…</span>

<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">termInDir</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>

<span class="c1">-- Optionally, modify the path to the editor with a function.</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>
</pre></div>

<p></p>
Quite convenient if you ask me.
<p></p>
If you have or know of a use case you would like to support but which is
awkward with the current set of functions and combinators do not
hesitate to open a pull request or an issue!
<h2 id="implementation-considerations">Implementation Considerations</h2>
<p></p>
The implementation is actually very straightforward—no really, check out
the
<a href="https://github.com/xmonad/xmonad-contrib/blob/master/XMonad/Util/Run.hs#L303">source</a>
if you don’t believe me!
<p></p>
One concept that’s still worth touching upon is the internal use of
<a href="https://github.com/spl/dlist#references">difference list</a>s. The basic idea of these things is that, instead of
concatenating strings one by one, we create functions <code>String -&gt; String</code>
and then use function composition to do the work for us:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">-- Ordinary string concatenation</span>
<span class="w">  </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>

<span class="w">  </span><span class="c1">-- Using difference lists:</span>
<span class="w">  </span><span class="n">string1</span><span class="p">,</span><span class="w"> </span><span class="n">string2</span><span class="p">,</span><span class="w"> </span><span class="n">string3</span><span class="p">,</span><span class="w"> </span><span class="n">string4</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="n">string1</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">s</span>
<span class="w">  </span><span class="n">string2</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="err">…</span>

<span class="w">  </span><span class="n">string1</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string3</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string4</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</pre></div>

<p></p>
Note how we have to apply the entire thing to <code>""</code> at the end in order
to actually get a string back. As a concrete example, assuming we have
set <code>"Emacs"</code> as our editor, the <code>inEditor</code> function would essentially
be
<div class="highlight"><pre><span></span><span class="nf">inEditor</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="nf">inEditor</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot; Emacs &quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">s</span>
</pre></div>

<p></p>
There are some further considerations to be made, since we are in the
<code>X</code> monad and thus the type is actually <code>X (String -&gt; String)</code> instead
of just <code>String -&gt; String</code>, but that isn’t too important for us here.
<p></p>
Difference lists have some performance advantages over the traditional
concatenation of strings. The concatenation <code>(&lt;&gt;)</code> on strings is left
associative by default and so
<div class="highlight"><pre><span></span><span class="w">    </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="p">((</span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>
</pre></div>

<p></p>
However, the complexity characteristics of this operation are working
against us here; the definition of <code>(&lt;&gt;)</code> on <code>String</code><!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">Really, this is the definition of <code>(++)</code> for arbitrary lists <code>[a]</code>
and <code>(&lt;&gt;) = (++)</code> for <code>String = [Char]</code>, but let’s not get into
that here.</span></span>
 is
<div class="highlight"><pre><span></span><span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="kt">[]</span><span class="w">       </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ys</span><span class="w"> </span><span class="ow">=</span><span class="w">           </span><span class="n">ys</span>
<span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ys</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ys</span>
</pre></div>

<p></p>
We are merely traversing the first string, leaving the second one
completely untouched (and unevaluated!). All in all, this means that
<code>s₁ &lt;&gt; s₂</code> is in <code>𝓞(|s₁|)</code>; given an expression of the form
<div class="highlight"><pre><span></span><span class="w">  </span><span class="p">((</span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>
</pre></div>

<p></p>
we will have to walk over <code>"string1"</code> three times! What we actually
want is a right-associative ordering—exactly what function compositions
gives us. Spelled out,
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">string1</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string3</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string4</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="n">string1</span><span class="w"> </span><span class="p">(</span><span class="n">string2</span><span class="w"> </span><span class="p">(</span><span class="n">string3</span><span class="w"> </span><span class="p">(</span><span class="n">string4</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)))</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;string2&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;string3&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;string4&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)))</span>
</pre></div>

<p></p>
which yields the desired behaviour. In fact, this is so canonical that
instead of using <code>(.)</code>, we could have also—perhaps a bit
confusingly—used <code>(&lt;&gt;)</code> directly:
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">string1</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">string2</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">string3</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">string4</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="n">string1</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">string3</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">string4</span>
</pre></div>

<p></p>
This is the fact that the <em>endomorphisms</em> for any type <code>a</code>—the functions
<code>a -&gt; a</code>—form a <em>monoid</em>. That is to say that they come equipped with
an associative an unital operation: function composition. In Haskell,
<code>(&lt;&gt;)</code> is, in some sense,
<a href="https://www.haskell.org/tutorial/classes.html">overloaded</a> so that it
can be used with any monoidal composition one can think of!<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Really, for any <em>semigroup</em>, which is a slightly weaker notion of
an operation that is merely associative, but doesn’t necessarily
have a unit.</span></span>
<p></p>
The attentive reader may have concluded that the pipe operator that we
called <code>(&gt;-&gt;)</code> above is really just <code>(&lt;&gt;)</code> in disguise, and that’s
exactly right! I, however, thought that for people not familiar with
Haskell, giving it a pipe-like appearance would be more conceptually
amenable to the threading idea.
<p></p>
I haven’t benchmarked this, so it’s not entirely clear to me whether
performance is actually relevant in this situation,<!--
--><span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">I suspect that the answer is “probably not”—that didn’t stop me,
however!</span></span>
 but using
difference lists just feels right here, and so I did.
<h2 id="conclusion">Conclusion</h2>
<p></p>
I have to say that I’m quite satisfied with this API. In fact, if I
look at the old code that only resided within my personal config, it’s
even a bit more ergonomic in a few places, despite having essentially no
user-specific strings hardcoded anywhere! As I said before, if you try
this and find something missing, do let me know and we’ll probably find
a solution! If you try this and find it useful, also let me know :)
<p></p>
Of course, technically none of this needs to live only inside your
<span class="small-caps">xm</span>onad config at all. In combination with the excellent <a href="https://hackage.haskell.org/package/turtle">turtle</a>
library, I reckon it would be quite easy to produce Haskell versions of
cool tools like magit.sh.<!--
--><span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">Available <a href="https://github.com/alphapapa/magit.sh">here</a>. I also
maintain a slightly modified and POSIX shell compatible version
<a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/scripts/.scripts/magit.sh">here</a>.</span></span>
 Go nuts!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>

</feed>

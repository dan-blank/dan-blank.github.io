<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>Tony Zorman – Blog</title>
    <link href="https://tony-zorman.com/atom.xml" rel="self" />
    <link href="https://tony-zorman.com" />
    <id>https://tony-zorman.com/atom.xml</id>
    <author>
        <name>Tony Zorman</name>
        <email>tonyzorman@mailbox.org</email>
    </author>
    <updated>2023-01-27T00:00:00Z</updated>
    <entry>
    <title>Using Sidenotes with Hakyll</title>
    <link href="https://tony-zorman.com/posts/2023-01-27-block-sidenotes.html" />
    <id>https://tony-zorman.com/posts/2023-01-27-block-sidenotes.html</id>
    <published>2023-01-27T00:00:00Z</published>
    <updated>2023-01-27T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-27
      
        | <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
I’ve become quite enamoured with sidenotes recently, and so of course
this website now has them as well! Thankfully, the integration with
pandoc and Hakyll is quite straightforward, because other people have
already done the hard work. Depending on your use-case, however, the
existing libraries might not entirely fit the bill; for example, by
default blocks that are more complicated than just paragraphs of pure
text don’t work. In this post, I’d like to explain an alternative
approach of integrating sidenotes into pandoc, which does enable the use
of these features.
<!--more-->
<h2 id="introduction">Introduction</h2>
<p></p>
If you don’t know: sidenotes are footnotes, just on the side of the
page!<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">For example, this is one.</span></span>
 More specifically they are footnotes placed inside of the
margins, in order to avoid having to click or scroll, breaking the flow
of reading—a flick of the eyes is enough. This is very convenient,
especially for longer entries with lots of asides that don’t necessarily
fit the flow of the article. However, because websites are dynamic in
size, a fallback option should be provided in case the margins are too
small/nonexistent. In most cases, this amount to making sidenotes
clickable again and, in one way or another, showing their content once
clicked.
<p></p>
Gwern Branwen has written about many different sidenote implementations
<a href="https://gwern.net/Sidenotes">here</a>. I settled on <a href="https://github.com/edwardtufte/tufte-css">Tufte <span class="small-caps">css</span></a>,
mainly because it seemed to be the most popular non-JS solution. Plus,
there is the fantastic <a href="https://hackage.haskell.org/package/pandoc-sidenote">pandoc-sidenote</a>, which
provides an appropriate pandoc filter. After extracting the relevant
<span class="small-caps">css</span> into <a href="https://github.com/slotThe/slotThe.github.io/blob/main/css/sidenotes.css">sidenotes.css</a> and plugging the exported
<code>usingSidenotes</code> function into my pandoc compiler,<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">Just like you would expect:
<div class="highlight"><pre><span></span><span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">pandocCompilerWithTransformM</span>
<span class="w">    </span><span class="n">defaultHakyllReaderOptions</span>
<span class="w">    </span><span class="n">myWriter</span>
<span class="w">    </span><span class="p">(</span><span class="w"> </span><span class="n">pygmentsHighlight</span><span class="w"> </span><span class="c1">-- syntax highlight</span>
<span class="w">    </span><span class="o">.</span><span class="w"> </span><span class="n">usingSidenotes</span><span class="w">    </span><span class="c1">-- sidenotes</span>
<span class="w">    </span><span class="o">.</span><span class="w"> </span><span class="n">addSectionLinks</span><span class="w">   </span><span class="c1">-- link on hover</span>
<span class="w">    </span><span class="p">)</span>
</pre></div>
</span></span>
 things just
worked!
<p></p>
There is but one problem with this setup: paragraphs. A sidenote
roughly looks like the following:
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sidenote-wrapper&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;sn-NAME&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;margin-toggle sidenote-number&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;sn-NAME&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;margin-toggle&quot;</span><span class="p">/&gt;</span>
  <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sidenote&quot;</span><span class="p">&gt;</span>
    SIDENOTE
  <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
</pre></div>

<p></p>
As Chris MacKay—a Tufte <span class="small-caps">css</span> contributor—helpfully explains in an
<a href="https://github.com/edwardtufte/tufte-css/issues/93#issuecomment-234316022">issue</a>, spans officially don’t play nice with
paragraphs:
<blockquote>
<p></p>
so marginnotes and sidenotes, as they are implemented now, are
<code>&lt;span&gt;</code> elements inside paragraph <code>&lt;p&gt;</code> elements. Only inline
elements are allowed inside paragraphs per the <span class="small-caps">html</span> standard.
</blockquote>
<p></p>
I know what you’re thinking: people don’t usually let themselves be
hampered by standards, do they?<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Just ask any person who’s ever worked on a window manager what
creative “interpretations” programs have of <a href="https://x.org/releases/X11R7.6/doc/xorg-docs/specs/ICCCM/icccm.html">ICCCM</a> or <a href="https://en.wikipedia.org/wiki/Extended_Window_Manager_Hints">EWMH</a> :)</span></span>
 Alas, the <code>pandoc-sidenote</code> package
quite sensibly converts a given footnote into an approximation of the
above <span class="small-caps">html</span> by using pandoc’s native <code>Span</code> data constructor. Here is a
(heavily) simplified version of the relevant function.
<div class="highlight"><pre><span></span><span class="nf">filterInline</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Inline</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Inline</span>
<span class="nf">filterInline</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">  </span><span class="c1">-- A @Note@ signifies a footnote.</span>
<span class="w">  </span><span class="kt">Note</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="c1">-- Note has a [Block], but Span needs [Inline]</span>
<span class="w">        </span><span class="n">content</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">coerceToInline</span><span class="w"> </span><span class="n">blocks</span>
<span class="w">     </span><span class="kr">in</span><span class="w"> </span><span class="kt">Span</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;sidenote-wrapper&quot;</span><span class="p">],</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span>
<span class="w">             </span><span class="p">[</span><span class="w"> </span><span class="kt">RawInline</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="s">&quot;&lt;label for …&quot;</span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="kt">RawInline</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="s">&quot;&lt;input type …&quot;</span>
<span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="kt">Span</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;sidenote&quot;</span><span class="p">],</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span><span class="w"> </span><span class="n">content</span>
<span class="w">             </span><span class="p">]</span>
<span class="w">  </span><span class="n">inline</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">inline</span>
</pre></div>

<p></p>
Now, pandoc very much does <em>not</em> want you to put any kind of block
inside of its <code>Span</code>s—that’s why its type is
<div class="highlight"><pre><span></span><span class="kt">Span</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Attr</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Inline</span>
</pre></div>

<p></p>
Notice the absence of a <code>[Block]</code> argument. This is why
<code>coerceToInline</code> exists, which tries to convert as many blocks as it can
to inline elements.
<div class="highlight"><pre><span></span><span class="nf">coerceToInline</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span>
<span class="nf">coerceToInline</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">concatMap</span><span class="w"> </span><span class="n">deBlock</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">walk</span><span class="w"> </span><span class="n">deNote</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Block</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">Plain</span><span class="w">     </span><span class="n">ls</span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">ls</span>
<span class="w">  </span><span class="c1">-- Simulate paragraphs with double LineBreak</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">Para</span><span class="w">      </span><span class="n">ls</span><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">newline</span>
<span class="w">  </span><span class="c1">-- See extension: line_blocks</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">LineBlock</span><span class="w"> </span><span class="n">lss</span><span class="w">   </span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">intercalate</span><span class="w"> </span><span class="p">[</span><span class="kt">LineBreak</span><span class="p">]</span><span class="w"> </span><span class="n">lss</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">newline</span>
<span class="w">  </span><span class="c1">-- Pretend RawBlock is RawInline (might not work!)</span>
<span class="w">  </span><span class="c1">-- Consider: raw &lt;div&gt; now inside RawInline... what happens?</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="p">(</span><span class="kt">RawBlock</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="n">str</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="kt">RawInline</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="n">str</span><span class="p">]</span>
<span class="w">  </span><span class="c1">-- lists, blockquotes, headers, hrs, and tables are all omitted</span>
<span class="w">  </span><span class="c1">-- Think they shouldn't be? I'm open to sensible PR's.</span>
<span class="w">  </span><span class="n">deBlock</span><span class="w"> </span><span class="kr">_</span><span class="w">                  </span><span class="ow">=</span><span class="w"> </span><span class="kt">[]</span>

<span class="w">  </span><span class="n">deNote</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Inline</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Inline</span>
<span class="w">  </span><span class="n">deNote</span><span class="w"> </span><span class="p">(</span><span class="kt">Note</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="n">deNote</span><span class="w"> </span><span class="n">x</span><span class="w">        </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span>
</pre></div>

<p></p>
The <code>coerceToInline</code> function behaves sensibly with respect to the
simplest kinds of blocks, but already mentions that the <code>RawBlock → RawInline</code> transformation may have some caveats. For example,
<a href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html">prerendering code blocks</a> puts one in exactly such a
“now we have a <code>&lt;div&gt;</code> tag inside of a <code>RawInline</code> element” situation.
Well, what happens?
<span class="sidenote-wrapper">
<label for="sn-2" class="margin-toggle sidenote-number"></label>
<input type="checkbox" id="sn-2" class="margin-toggle" />
<p><span class="sidenote">Now simulating <code>pandoc-sidenode</code>s behaviour, the following is a piece of code <em>in the sidenote:</em>
<div class="highlight"><pre><span></span><span class="nf">a</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span> <span class="nf">
a</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">42</span> </pre></div>
</span></p>
</span>
<p></p>
This is the next line in the main document; the above code block was
supposed to be in the relevant sidenote, but “spilled” into the text
instead. This is obviously not what we want.
<p></p>
The documentation mentions other things that are missing, and that pull
requests are welcome, but for many blocks there just is no good
alternative. For example, code blocks and inline code serve very
different purposes most of the time. Pandoc itself has a
<a href="https://hackage.haskell.org/package/pandoc-3.0.1/docs/Text-Pandoc-Shared.html#v:blocksToInlines">function</a> of the same name that
attempts to convert tables, figures, and the like, but this also yields
some surprising behaviour when used instead of <code>pandoc-sidenote</code>s
variant.<!--
--><span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">Whereas now, things like
<ul>
<li><p></p>

tables
<table style="width:66%;">
<colgroup>
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 26%" />
</colgroup>
<thead>
<tr class="header">
<th>Fruit</th>
<th>Price</th>
<th>Advantages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Oranges</td>
<td>$2.10</td>
<td><ul>
<li>cures scurvy</li>
<li>tasty</li>
</ul></td>
</tr>
</tbody>
</table></li>
<li><p></p>

quotes
<blockquote>
<p></p>
they said that …
</blockquote></li>
<li><p></p>

display maths
<p></p>

<span class="math display">\[
\int^{a, b} \mathcal{C}(a \otimes b, {-}) \cdot Fa \otimes Gb
\]</span></li>
</ul>
<p></p>
and the like are no problem at all!</span></span>
<p></p>
So what to do? Well, life wouldn’t be fun if we didn’t at least try to
hack our way around a standard, would it?
<h2 id="rewriting-pandoc-sidenote">Rewriting <code>pandoc-sidenote</code></h2>
<p></p>
As I’ve learned while <a href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html">writing</a> about using
<code>pygmentize</code> to syntax highlight code for this site, pandoc has quite
good support for changing its <span class="small-caps">ast</span> in creative ways. A strategy unfolds:
find every <code>Note</code> block in a document, somehow render its contents, and
create a <code>RawBlock "html"</code> node instead of using pandoc’s built in
<code>Span</code> .
<p></p>
For rendering <span class="small-caps">html</span>, pandoc has a
<a href="https://hackage.haskell.org/package/pandoc-3.0.1/docs/Text-Pandoc-Writers.html#v:writeHtml5String">writeHtml5String</a> function, which is
conveniently wrapped by Hakyll in
<a href="https://hackage.haskell.org/package/hakyll-4.15.1.1/docs/Hakyll-Web-Pandoc.html#v:writePandocWith">writePandocWith</a>:
<div class="highlight"><pre><span></span><span class="c1">-- | Write a document (as HTML) using pandoc, with the supplied options</span>
<span class="nf">writePandocWith</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">WriterOptions</span><span class="w">  </span><span class="c1">-- ^ Writer options for pandoc</span>
<span class="w">                </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Item</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w">    </span><span class="c1">-- ^ Document to write</span>
<span class="w">                </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="w">    </span><span class="c1">-- ^ Resulting HTML</span>
</pre></div>

<p></p>
Importantly, rendering takes some <code>WriterOptions</code>; since we don’t want
to mess around with changing pure <span class="small-caps">html</span> afterwards, this is quite
important for us.
<p></p>
Writing this filter now essentially works by the same strategy outlined
in the last post: look through the Haddocks to find the types that we
want, <a href="https://aphyr.com/posts/342-typing-the-technical-interview">seize some meaningless functions from the void, and imbue them
with meaning</a>. The relevant bits
from pandoc’s internal types are the following.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="kt">Meta</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Block</span>
<span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="kt">Plain</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w">       </span><span class="c1">-- ^ Plain text, not a paragraph</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Para</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w">        </span><span class="c1">-- ^ Paragraph</span>
<span class="w">    </span><span class="c1">-- …</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">RawBlock</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="kt">Text</span><span class="w"> </span><span class="c1">-- ^ Raw block</span>

<span class="kr">data</span><span class="w"> </span><span class="kt">Inline</span>
<span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="kt">Str</span><span class="w"> </span><span class="kt">Text</span><span class="w">             </span><span class="c1">-- ^ Text (string)</span>
<span class="w">    </span><span class="c1">-- …</span>
<span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="kt">Note</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w">         </span><span class="c1">-- ^ Footnote or endnote</span>
</pre></div>

<p></p>
While this document is <em>not</em> a literate Haskell file, the following is
still here for convenience, in case you are left wondering where some of
the functions come from.
<div class="highlight"><pre><span></span><span class="cm">{-# LANGUAGE BangPatterns             #-}</span>
<span class="cm">{-# LANGUAGE LambdaCase               #-}</span>
<span class="cm">{-# LANGUAGE OverloadedStrings        #-}</span>
<span class="cm">{-# LANGUAGE StandaloneKindSignatures #-}</span>

<span class="kr">import</span><span class="w"> </span><span class="nn">Control.Monad.State</span><span class="w"> </span><span class="p">(</span><span class="kt">State</span><span class="p">,</span><span class="w"> </span><span class="nf">foldM</span><span class="p">,</span><span class="w"> </span><span class="nf">get</span><span class="p">,</span><span class="w"> </span><span class="nf">modify'</span><span class="p">,</span><span class="w"> </span><span class="nf">runState</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Kind</span><span class="w"> </span><span class="p">(</span><span class="kt">Type</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Data.Text</span><span class="w"> </span><span class="p">(</span><span class="kt">Text</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="k">qualified</span><span class="w"> </span><span class="nn">Data.Text</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">T</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Hakyll</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="nf">writePandocWith</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Definition</span><span class="w"> </span><span class="p">(</span><span class="kt">Block</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="kt">Inline</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="p">(</span><span class="o">..</span><span class="p">))</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Options</span><span class="w"> </span><span class="p">(</span><span class="kt">WriterOptions</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Shared</span><span class="w"> </span><span class="p">(</span><span class="nf">tshow</span><span class="p">)</span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Text.Pandoc.Walk</span><span class="w"> </span><span class="p">(</span><span class="nf">walkM</span><span class="p">)</span>
</pre></div>

<p></p>
Rendering the actual sidenote isn’t very complicated, and amounts to
picking out the <code>Note</code> constructor, rendering it, and putting everything
back together.<!--
--><span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">The <code>Sidenote</code> type you are seeing is just some alias for <code>State</code>,
which keeps track of the sidenote number, as well as the supplied
<code>WriterOption</code>s; nothing fancy.</span></span>
<div class="highlight"><pre><span></span><span class="nf">renderSidenote</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w">            </span><span class="c1">-- ^ Inlines from a single @Note@</span>
<span class="w">               </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="nf">renderSidenote</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="kt">[]</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">go</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Inline</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="w">  </span><span class="n">go</span><span class="w"> </span><span class="n">inlines</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">    </span><span class="kt">[]</span><span class="w">           </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="p">[</span><span class="kt">Plain</span><span class="w"> </span><span class="n">inlines</span><span class="p">]</span>
<span class="w">    </span><span class="kt">Note</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">renderBlock</span><span class="w"> </span><span class="n">bs</span>
<span class="w">                       </span><span class="p">([</span><span class="kt">Plain</span><span class="w"> </span><span class="n">inlines</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="n">xs</span>
<span class="w">    </span><span class="n">b</span><span class="w">       </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">go</span><span class="w"> </span><span class="p">(</span><span class="n">inlines</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">b</span><span class="p">])</span><span class="w"> </span><span class="n">xs</span>

<span class="w">  </span><span class="n">renderBlock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="kt">Block</span>
<span class="w">  </span><span class="n">renderBlock</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="c1">-- Update sidenote counter and get the `WriterOption's.</span>
<span class="w">    </span><span class="kt">SNS</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">get</span><span class="w"> </span><span class="o">&lt;*</span><span class="w"> </span><span class="n">modify'</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">sns</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">sns</span><span class="p">{</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="n">sns</span><span class="w"> </span><span class="p">})</span>
<span class="w">    </span><span class="n">pure</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="c1">-- … all the opening html stuff</span>
<span class="w">                             </span><span class="n">writePandocWith</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">(</span><span class="kt">Pandoc</span><span class="w"> </span><span class="n">mempty</span><span class="w"> </span><span class="n">blocks</span><span class="p">))</span>
<span class="w">                             </span><span class="c1">-- … all the closing html stuff</span>
</pre></div>

<p></p>
Finding notes is a bit more finicky, since they could potentially occur
in a lot of places. Right now, for obvious reasons, I’ve settled on
covering all cases that currently occur on this website. Importantly,
we need to be a bit careful about inserting newlines for paragraphs (and
when to omit this). This is because <code>Note</code>s are actually inline
elements, and so we are replacing a single <code>Block</code> by a list of
<code>Block</code>s, which incurs some additional formatting.
<div class="highlight"><pre><span></span><span class="nf">mkSidenote</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="nf">mkSidenote</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">foldM</span><span class="w"> </span><span class="p">(</span><span class="nf">\</span><span class="n">acc</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">acc</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">single</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="kt">[]</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">single</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Block</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Sidenote</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="w">  </span><span class="n">single</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">    </span><span class="c1">-- Simulate a paragraph by inserting a dummy block; this is needed</span>
<span class="w">    </span><span class="c1">-- in case two consecutive paragraphs have sidenotes, or a paragraph</span>
<span class="w">    </span><span class="c1">-- doesn't have one at all.</span>
<span class="w">    </span><span class="kt">Para</span><span class="w"> </span><span class="n">inlines</span><span class="w">         </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Para</span><span class="w"> </span><span class="p">[</span><span class="kt">Str</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">]</span><span class="w"> </span><span class="kt">:</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">renderSidenote</span><span class="w"> </span><span class="n">inlines</span>
<span class="w">    </span><span class="kt">OrderedList</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="n">bs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">:[]</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">OrderedList</span><span class="w"> </span><span class="n">attrs</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">traverse</span><span class="w"> </span><span class="n">mkSidenote</span><span class="w"> </span><span class="n">bs</span>
<span class="w">    </span><span class="kt">BulletList</span><span class="w">        </span><span class="n">bs</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">:[]</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">BulletList</span><span class="w">        </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">traverse</span><span class="w"> </span><span class="n">mkSidenote</span><span class="w"> </span><span class="n">bs</span>
<span class="w">    </span><span class="n">block</span><span class="w">                </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="p">[</span><span class="n">block</span><span class="p">]</span>
</pre></div>

<p></p>
Putting everything together, we apply this transformation to every block
in a document:
<div class="highlight"><pre><span></span><span class="nf">usingSidenotes</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">WriterOptions</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Pandoc</span>
<span class="nf">usingSidenotes</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="p">(</span><span class="kt">Pandoc</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="kt">Pandoc</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="p">(</span><span class="n">walkBlocks</span><span class="w"> </span><span class="p">(</span><span class="kt">SNS</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">blocks</span><span class="p">)</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">walkBlocks</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">SidenoteState</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
<span class="w">  </span><span class="n">walkBlocks</span><span class="w"> </span><span class="n">sns</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">    </span><span class="kt">[]</span><span class="w">       </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">[]</span>
<span class="w">    </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">bs</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b'</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">walkBlocks</span><span class="w"> </span><span class="n">s'</span><span class="w"> </span><span class="n">bs</span>
<span class="w">     </span><span class="kr">where</span><span class="w"> </span><span class="p">(</span><span class="n">b'</span><span class="p">,</span><span class="w"> </span><span class="n">s'</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runState</span><span class="w"> </span><span class="p">(</span><span class="n">walkM</span><span class="w"> </span><span class="n">mkSidenote</span><span class="w"> </span><span class="p">[</span><span class="n">b</span><span class="p">])</span><span class="w"> </span><span class="n">sns</span>
</pre></div>

<p></p>
This can now be used much like the <code>usingSidenotes</code> function from
<code>pandoc-sidenote</code>, only that it needs to know your <code>WriterOption</code>s.
More importantly, it should be the last of the transformations that you
do to pandoc’s <span class="small-caps">ast</span>, since <code>usingSidenotes</code> completely renders the
footnote, which is not what you want in case you—like me—do other
creative transformations, such as separately generating <span class="small-caps">html</span> for
<code>CodeBlock</code>s. In my configuration, I now have
<div class="highlight"><pre><span></span><span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">pandocCompilerWithTransformM</span>
<span class="w">    </span><span class="n">defaultHakyllReaderOptions</span>
<span class="w">    </span><span class="n">myWriter</span>
<span class="w">    </span><span class="p">(</span><span class="n">pure</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">usingSidenotes</span><span class="w"> </span><span class="n">myWriter</span><span class="w"> </span><span class="o">&lt;=&lt;</span><span class="w"> </span><span class="n">pygmentsHighlight</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">addSectionLinks</span><span class="p">)</span>
</pre></div>

<p></p>
Tufte <span class="small-caps">css</span> needs to be changed minimally to support this extended
functionality, but thankfully Said Achmiz has already documented what
needs to be done <a href="https://github.com/edwardtufte/tufte-css/issues/93#issuecomment-671102819">here</a>. This is
already included in my <code>sidenotes.css</code>, so if you’re just copying that
then you should be fine.
<h2 id="conclusion">Conclusion</h2>
<p></p>
Being perfectly honest, I’m not very satisfied with this solution. It
does work, but pre-rendering everything and not using pandoc’s built in
constructors feels like a big hack. More importantly though, since what
I’ve done here amounts to a complete rewrite,<!--
--><span class="sidenote-wrapper"><label for="sn-5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-5" class="margin-toggle" /><span class="sidenote">Not only that, but it’s almost certainly also a regression in
certain aspects; even after handling of margin notes is restored,
which I’ve completely ignored for now.</span></span>
 I can’t contribute
this upstream—at least I don’t see a way. I sort of don’t want to
advertise this solution as an alternative to <code>pandoc-sidenote</code>, as that
package handles the concept of sidenotes in a much better way,
philosophically. Hence, there is no standalone repository for
<a href="https://github.com/slotThe/slotThe.github.io/blob/main/src/Sidenote.hs">Sidenote.hs</a> and <a href="https://github.com/slotThe/slotThe.github.io/blob/main/css/sidenotes.css">sidenotes.css</a> at
this point.
<p></p>
Really, I would be delighted if someone told me that I just used
<code>pandoc-sidenote</code> (or another program involved) wrongly, and this is
actually very easy to achieve using <code>${METHOD}</code>. Until then, I’ll
continue to be blissfully unaware of <span class="small-caps">html</span> standards :)

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Pygmentising Hakyll's Syntax Highlighting</title>
    <link href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html" />
    <id>https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html</id>
    <published>2023-01-21T00:00:00Z</published>
    <updated>2023-01-21T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-21
      
        | <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
By default, Hakyll uses pandoc to generate syntax highlighting for all
kinds of different programming languages. However, even in simple
examples the <span class="small-caps">html</span> this produces is unsatisfactory. Thankfully, the two
programs are almost infinitely customisable, and changing pretty much
any setting doesn’t usually involve a lot of work—this is no exception.
Using <code>pygmentize</code> as an example, I will show you how you can swap out
pandoc’s native syntax highlighting with pretty much any third party
tool that can output <span class="small-caps">html</span>.
<!--more-->
<h2 id="the-problem">The problem</h2>
<p></p>
Pandoc uses the <a href="https://hackage.haskell.org/package/skylighting">skylighting</a> library to generate syntax highlighting
for a given block of code. Skylighting, in turn, uses <a href="https://docs.kde.org/stable5/en/kate/katepart/highlight.html"><span class="small-caps">kde</span> <span class="small-caps">xml</span> syntax
definitions</a> for the respective tokenisers. However, even for simple
examples I don’t agree with the <span class="small-caps">html</span> this generates. Consider the
following Haskell code block.
<div class="highlight"><pre><span></span><span class="nf">fibs</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Integer</span><span class="p">]</span>
<span class="nf">fibs</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">scanl'</span><span class="w"> </span><span class="p">(</span><span class="o">+</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">fibs</span>
</pre></div>

<p></p>
Pandoc would generate something like the following:
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sourceCode&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;cb1&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">pre</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sourceCode haskell&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">code</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;sourceCode haskell&quot;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;cb1-1&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#cb1-1&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;-1&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ot&quot;</span><span class="p">&gt;</span>    fibs :: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> [<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dt&quot;</span><span class="p">&gt;</span>Integer <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>]
      <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;cb1-2&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#cb1-2&quot;</span> <span class="na">aria-hidden</span><span class="o">=</span><span class="s">&quot;true&quot;</span> <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;-1&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>    fibs
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ot&quot;</span><span class="p">&gt;</span>= <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dv&quot;</span><span class="p">&gt;</span>0 <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;op&quot;</span><span class="p">&gt;</span>: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
        scanl<span class="ni">&amp;#39;</span> (<span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;op&quot;</span><span class="p">&gt;</span>+ <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>) <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;dv&quot;</span><span class="p">&gt;</span>1
        <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> fibs
      <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>

<p></p>
One can already see a few things wrong with this: (i) in the type
signature, the name of the list is smushed together with the separating
double colon (worse: it’s just in the “other” syntax class), (ii) in the
actual definition, <code>fibs</code> isn’t assigned any class at all, and (iii) the
assignment operator is also in the “other” class, instead of something
related to it being a built in operator! As one can imagine, this only
gets worse as snippets get more complicated.
<p></p>
These kinds of issues, combined with the fact that certain
languages—like Emacs Lisp—don’t have any syntax definitions at all,
annoyed me enough to look for an alternative way to highlight code on
this website.<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">All of this work for a mostly greyscale theme!</span></span>
 There are of course many options to choose from; I
went with <code>pygmentize</code>, solely because I already had it installed. All
that’s left is to tell pandoc and Hakyll to make use of it. As
mentioned, this thankfully doesn’t turn out to be very difficult!
<h2 id="playing-with-pygmentize">Playing with <code>pygmentize</code></h2>
<p></p>
Having never used <code>pygmentize</code> as a command line utility,<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">So far, the only interaction I had with the program was through
the excellent <a href="https://ctan.org/pkg/minted?lang=en">minted</a> LaTeX package.</span></span>
 I expected
this to take some work—possibly involving Python <em>shudder</em>—but all of
the necessary pieces are already present in the <span class="small-caps">cli</span>. First up, the <code>-f</code>
option specifies the formatter to use, which will decide the shape of
the output.
<div class="highlight"><pre><span></span><span class="gp">$ </span>pygmentize<span class="w"> </span>-L<span class="w"> </span>formatter<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>html
<span class="go">* html:</span>
<span class="go">    Format tokens as HTML 4 ``&lt;span&gt;`` tags within a ``&lt;pre&gt;`` tag, wrapped in a ``&lt;div&gt;`` tag. The ``&lt;div&gt;``'s CSS class can be set by the `cssclass` option. (filenames *.html, *.htm)</span>
</pre></div>

<p></p>
We can test how this highlighting looks straight away; executing
<div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;fibs :: [Integer]\nfibs = 0 : scanl' (+) 1 fibs&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span><span class="se">\ </span><span class="p">|</span><span class="w"> </span>pygmentize<span class="w"> </span>-l<span class="w"> </span>haskell<span class="w"> </span>-f<span class="w"> </span>html
</pre></div>

<p></p>
produces an <span class="small-caps">html</span> output along the lines of
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;highlight&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">pre</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nf&quot;</span><span class="p">&gt;</span>fibs <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ow&quot;</span><span class="p">&gt;</span>:: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>[<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;kt&quot;</span><span class="p">&gt;</span>Integer <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>] <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;nf&quot;</span><span class="p">&gt;</span>fibs <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;ow&quot;</span><span class="p">&gt;</span>= <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mi&quot;</span><span class="p">&gt;</span>0 <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;kt&quot;</span><span class="p">&gt;</span>: <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">&gt;</span>scanl<span class="ni">&amp;#39;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>(<span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;o&quot;</span><span class="p">&gt;</span>+ <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;p&quot;</span><span class="p">&gt;</span>) <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;mi&quot;</span><span class="p">&gt;</span>1 <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span> <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;w&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">span</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;n&quot;</span><span class="p">&gt;</span>fibs <span class="p">&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">pre</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>

<p></p>
This looks much better! The class names are kind of obtuse, but
<code>pygmentize</code> can also give you nicely annotated <span class="small-caps">css</span> styles for its
supported colour schemes. For example, the following is a small excerpt
of the output:
<div class="highlight"><pre><span></span><span class="gp">$ </span>pygmentize<span class="w"> </span>-S<span class="w"> </span>emacs<span class="w"> </span>-f<span class="w"> </span>html
<span class="go">…</span>
<span class="go">.nf { color: #00A000 }                    /* Name.Function */</span>
<span class="go">.ow { color: #AA22FF; font-weight: bold } /* Operator.Word */</span>
<span class="go">.kt { color: #00BB00; font-weight: bold } /* Keyword.Type */</span>
<span class="go">.w { color: #bbbbbb }                     /* Text.Whitespace */</span>
<span class="go">.c { color: #008800; font-style: italic } /* Comment */</span>
<span class="go">…</span>
</pre></div>

<p></p>
You can redirect this into a <code>pygments.css</code> file, link to it (e.g., from
your <code>default.html</code> template), and be on your way. The annotation also
makes it very easy to change that file after the fact, in case
<code>pygmentize</code> does not have the theme that you want.
<h2 id="integration">Integration</h2>
<p></p>
The idea of what we want to do is quite simple: for every code block in
a given post, shell out to <code>pygmentize</code>, and use its output to replace
the block, somehow making sure pandoc doesn’t touch it afterwards.
Let’s solve this step by step.
<h3 id="pandoc">Pandoc</h3>
<p></p>
Pandoc has an aptly named <code>Pandoc</code> type, which represents the internal
structure of a document.
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="kt">Meta</span><span class="w"> </span><span class="p">[</span><span class="kt">Block</span><span class="p">]</span>
</pre></div>

<p></p>
We’ll neglect the metadata for now and just look at the <code>Block</code>s;
specifically, we want to zoom in on two constructors that will give you
everything we need:
<div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">Block</span>
<span class="w">  </span><span class="c1">-- Lots of other constructors omitted</span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="kt">Attr</span><span class="w"> </span><span class="kt">Text</span><span class="w">   </span><span class="c1">-- ^ Code block (literal) with attributes</span>
<span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="kt">RawBlock</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="kt">Text</span><span class="w">  </span><span class="c1">-- ^ Raw block</span>

<span class="c1">-- | Attributes: identifier, classes, key-value pairs</span>
<span class="kr">type</span><span class="w"> </span><span class="kt">Attr</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="kt">Text</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">Text</span><span class="p">],</span><span class="w"> </span><span class="p">[(</span><span class="kt">Text</span><span class="p">,</span><span class="w"> </span><span class="kt">Text</span><span class="p">)])</span>

<span class="c1">-- | Formats for raw blocks</span>
<span class="kr">newtype</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Format</span><span class="w"> </span><span class="kt">Text</span>
</pre></div>

<p></p>
To get a feeling for how these <code>CodeBlock</code>s look, again consider our
<code>fibs</code> example from above. By default, the corresponding <code>CodeBlock</code>
for this would look something like
<div class="highlight"><pre><span></span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;haskell&quot;</span><span class="p">],</span><span class="w"> </span><span class="kt">[]</span><span class="p">)</span>
<span class="w">          </span><span class="s">&quot;fibs :: [Integer]</span><span class="se">\n</span><span class="s">fibs = 0 : scanl' (+) 1 fibs&quot;</span>
</pre></div>

<p></p>
Importantly, the language (if any) is the first argument of the
<code>classes</code> field of <code>Attr</code>.
<p></p>
A strategy begins to form: look for all occurences of a <code>CodeBlock</code> in
the <code>Pandoc</code> type, and replace it with a <code>RawBlock "html"</code> such that it
isn’t touched anymore. Doing so will not pose very many
challenges—pandoc has really great capabilities for
<a href="https://hackage.haskell.org/package/pandoc-types/docs/Text-Pandoc-Walk.html">walking</a> its <span class="small-caps">ast</span> in order to facilitate exactly these
kinds of changes. Unsurprisingly, the <code>Walkable</code> class resides over all
things walkable; an abbreviated definition looks like this:
<div class="highlight"><pre><span></span><span class="kr">class</span><span class="w"> </span><span class="kt">Walkable</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="c1">-- | @walk f x@ walks the structure @x@ (bottom up) and replaces every</span>
<span class="w">  </span><span class="c1">-- occurrence of an @a@ with the result of applying @f@ to it.</span>
<span class="w">  </span><span class="n">walk</span><span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b</span>
<span class="w">  </span><span class="n">walk</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">runIdentity</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">walkM</span><span class="w"> </span><span class="p">(</span><span class="n">return</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">f</span><span class="p">)</span>

<span class="w">  </span><span class="c1">-- | A monadic version of 'walk'.</span>
<span class="w">  </span><span class="n">walkM</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Monad</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Applicative</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="kt">Functor</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="n">b</span>
</pre></div>

<p></p>
Specifically, as we’ll need to shell out to an external program, let us
restrict our attention to the more general <code>walkM</code> function here. There
is an instance
<div class="highlight"><pre><span></span><span class="kr">instance</span><span class="w"> </span><span class="kt">Walkable</span><span class="w"> </span><span class="kt">Block</span><span class="w"> </span><span class="kt">Pandoc</span>
</pre></div>

<p></p>
which will be all that we need. The necessary code now just
materialises in front of our eyes:<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">If all else fails, simply <a href="https://aphyr.com/posts/353-rewriting-the-technical-interview">trace the sigils in the air and give
them form</a>.</span></span>
<div class="highlight"><pre><span></span><span class="c1">-- {-# LANGUAGE BlockArguments    #-}</span>
<span class="c1">-- {-# LANGUAGE LambdaCase        #-}</span>
<span class="c1">-- {-# LANGUAGE OverloadedStrings #-}</span>
<span class="c1">-- {-# LANGUAGE ViewPatterns      #-}</span>
<span class="c1">--</span>
<span class="c1">-- import Data.Maybe (fromMaybe, listToMaybe)</span>
<span class="c1">-- import qualified Data.Text as T</span>
<span class="c1">-- import Hakyll</span>
<span class="c1">-- import System.Process (readProcess)</span>
<span class="c1">-- import Text.Pandoc.Definition (Block (CodeBlock, RawBlock), Pandoc)</span>
<span class="c1">-- import Text.Pandoc.Walk (walk, walkM)</span>

<span class="nf">pygmentsHighlight</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="kt">Pandoc</span>
<span class="nf">pygmentsHighlight</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">walkM</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">  </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">lang</span><span class="p">)</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">unsafeCompiler</span><span class="w"> </span><span class="p">(</span><span class="n">callPygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
<span class="w">  </span><span class="n">block</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="n">block</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">pygs</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="n">pygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">readProcess</span><span class="w"> </span><span class="s">&quot;pygmentize&quot;</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;-l&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">lang</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">]</span>
</pre></div>

<p></p>
Notice how <em>a priori</em> this would have type <code>Pandoc -&gt; IO Pandoc</code>, but
since we want to use it from Hakyll I’ve already inserted a call to
<code>unsafeCompiler</code> in the correct place.
<p></p>
Further, the above code checks whether the block has an explicit
language attached to it and, if not, leaves it alone; this was suggested
by <a href="https://old.reddit.com/r/haskell/comments/10ilrui/pygmentising_hakylls_syntax_highlighting/j5fih5h/">LSLeary</a> on Reddit. If you want to have a single <code>div</code> class for
every code block—say, for some custom <span class="small-caps">css</span>—then you can replace
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">lang</span><span class="p">)</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">    </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">unsafeCompiler</span><span class="w"> </span><span class="p">(</span><span class="n">callPygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</pre></div>

<p></p>
with
<div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">CodeBlock</span><span class="w"> </span><span class="p">(</span><span class="kr">_</span><span class="p">,</span><span class="w"> </span><span class="n">listToMaybe</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">mbLang</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">body</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">unpack</span><span class="w"> </span><span class="p">(</span><span class="n">fromMaybe</span><span class="w"> </span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="n">mbLang</span><span class="p">)</span>
<span class="w">    </span><span class="kt">RawBlock</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">T</span><span class="o">.</span><span class="n">pack</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">unsafeCompiler</span><span class="w"> </span><span class="p">(</span><span class="n">callPygs</span><span class="w"> </span><span class="n">lang</span><span class="w"> </span><span class="n">body</span><span class="p">)</span>
</pre></div>

<h3 id="hakyll">Hakyll</h3>
<p></p>
Thankfully, integrating <code>pygmentsHighlight</code> into Hakyll is not very
complicated either. In addition to the normal <code>pandocCompiler</code> or
<code>pandocCompilerWith</code> functions that you are probably already using,
there is also <a href="https://hackage.haskell.org/package/hakyll-4.15.1.1/docs/Hakyll-Web-Pandoc.html#v:pandocCompilerWithTransformM">pandocCompilerWithTransformM</a>:
<div class="highlight"><pre><span></span><span class="nf">pandocCompilerWithTransformM</span>
<span class="w">  </span><span class="ow">::</span><span class="w"> </span><span class="kt">ReaderOptions</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">WriterOptions</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">Pandoc</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="kt">Pandoc</span><span class="p">)</span>
<span class="w">  </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
</pre></div>

<p></p>
Basically, in additions to reader and writer options, it also takes a
monadic transformation of pandoc’s <span class="small-caps">ast</span> and builds an appropriate
<code>Compiler</code> from that.
<div class="highlight"><pre><span></span><span class="c1">-- import Hakyll</span>
<span class="c1">-- import Text.Pandoc.Options</span>

<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Compiler</span><span class="w"> </span><span class="p">(</span><span class="kt">Item</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span>
<span class="nf">myPandocCompiler</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">pandocCompilerWithTransformM</span>
<span class="w">    </span><span class="n">defaultHakyllReaderOptions</span>
<span class="w">    </span><span class="n">defaultHakyllWriterOptions</span>
<span class="w">    </span><span class="n">pygmentsHighlight</span>
</pre></div>

<p></p>
The <code>myPandocCompiler</code> function can now be used as any other compiler;
for example:
<div class="highlight"><pre><span></span><span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">hakyll</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="c1">-- …</span>
<span class="w">  </span><span class="n">match</span><span class="w"> </span><span class="s">&quot;posts/**.md&quot;</span><span class="w"> </span><span class="kr">do</span>
<span class="w">    </span><span class="n">route</span><span class="w"> </span><span class="p">(</span><span class="n">setExtension</span><span class="w"> </span><span class="s">&quot;html&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">compile</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">myPandocCompiler</span>
<span class="w">          </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">loadAndApplyTemplate</span><span class="w"> </span><span class="s">&quot;templates/default.html&quot;</span><span class="w"> </span><span class="n">defaultContext</span>
<span class="w">          </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="n">relativizeUrls</span>
<span class="w">  </span><span class="c1">-- …</span>
</pre></div>

<p></p>
For a full working example, see <a href="https://github.com/slotThe/slotThe.github.io/blob/main/src/site.hs#L87">my configuration</a>.
<h2 id="conclusion">Conclusion</h2>
<p></p>
That’s it! To my eyes, syntax highlighting looks much better now, and
on the way I—and perhaps you as well—even learned a little bit about how
pandoc internally represents its documents. Time well spent. As I said
in the beginning, in principle one could swap out <code>pygmentize</code> for any
other syntax highlighter that can produce <span class="small-caps">html</span>. However, for me these
results are good enough that I will probably not try out every tool
under the sun, chasing that ever present epsilon of highlighting cases
which I still don’t agree with—at least for now.

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Immediately Refile Notes with X.P.OrgMode</title>
    <link href="https://tony-zorman.com/posts/2023-01-14-orgmode-refiling.html" />
    <id>https://tony-zorman.com/posts/2023-01-14-orgmode-refiling.html</id>
    <published>2023-01-14T00:00:00Z</published>
    <updated>2023-01-14T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-14
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>, <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
In a <a href="/posts/orgmode-prompt/2022-08-27-xmonad-and-org-mode.html">previous post</a> I talked about
<a href="https://xmonad.github.io/xmonad-docs/xmonad-contrib/XMonad-Prompt-OrgMode.html">XMonad.Prompt.OrgMode</a>, an <span class="small-caps">xm</span>onad module to rapidly capture thoughts
and ideas into an Org file. The functionality that the module provides
has proven to be extremely useful to me, and really I couldn’t be
happier with it. However, a user recently contacted me by email and
told me that they’re missing but one feature: the ability to immediately
refile notes.
<!--more-->
<h2 id="motivation">Motivation</h2>
<p></p>
If you don’t know, <a href="https://orgmode.org/manual/Refile-and-Copy.html">refiling</a> is the act of moving an entry<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">A headline, possibly with an attached body.</span></span>
 <em>below</em>
another heading; i.e., such that it becomes a subheading there. This
can be useful for structuring <span class="small-caps">todo</span>s into separate categories: one might
have projects called “work”, “life”, “<span class="small-caps">xm</span>onad”, and so on, where all
related tasks live. Quite convenient!
<p></p>
So far, X.P.OrgMode just dumped the created note at the end of the
specified file, leaving you to pick up the pieces. This aligns with my
personal workflow—while I extensively use refiling, I only do so at the
end of the day after reviewing all tasks that have accumulated.
However, it is conceivable that someone might want to refile certain
tasks straight away when it’s pretty clear that (i) they’ll be kept, and
(ii) they can be unambiguously assigned to a certain heading (e.g., an
already scheduled work meeting with X).
<h2 id="showcase">Showcase</h2>
<p></p>
Long story short, this is now built into X.P.OrgMode. There are two new
functions:
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">orgPromptRefile</span><span class="w">   </span><span class="ow">::</span><span class="w"> </span><span class="kt">XPConfig</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w">           </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">FilePath</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="w">    </span><span class="n">orgPromptRefileTo</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">XPConfig</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">FilePath</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
</pre></div>

<p></p>
The former takes the same arguments as <a href="https://hackage.haskell.org/package/xmonad-contrib-0.17.1/docs/XMonad-Prompt-OrgMode.html#v:orgPrompt">orgPrompt</a> (which see), and is
for popping up another prompt that asks for a heading. The latter
refiles everything under the specified (as the second argument) heading.
<p></p>
The way <code>orgPromptRefile</code> works is that, after querying for a <span class="small-caps">todo</span>, it
<em>always</em> inserts the note into the file and then <em>possibly</em> refiles it
to another heading. This way, you don’t need to worry about losing
notes when you abort the refiling prompt or enter a non-existent
heading.
<p></p>
<img class="pure-img" src="../images/orgmode-refiling/refiling.gif">
<p></p>
Note: Refiling is (near) instant; the delay you are seeing above is due
to <code>auto-revert-mode</code>.
<h3 id="some-gory-details">Some gory details</h3>
<p></p>
All of the refiling is actually directly done by Emacs itself! More
precisely, the <span class="small-caps">edsl</span> that <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-Run.html">XMonad.Util.Run</a> defines—which I’ve also
<a href="/posts/2022-05-25-calling-emacs-from-xmonad.html">written about</a>—shells out to Emacs. This
might intuitively <em>feel</em> horrible, but that’s just another reason to
share it:
<div class="highlight"><pre><span></span><span class="nf">refile</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">FilePath</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">refile</span><span class="w"> </span><span class="p">(</span><span class="n">asString</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">asString</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">fp</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEmacs</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">asBatch</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">progn</span>
<span class="w">                </span><span class="p">[</span><span class="w"> </span><span class="s">&quot;find-file&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">fp</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;end-of-buffer&quot;</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;org-refile nil nil&quot;</span>
<span class="w">                    </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">list</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nil&quot;</span>
<span class="w">                            </span><span class="p">,</span><span class="w"> </span><span class="n">saveExcursion</span>
<span class="w">                               </span><span class="p">[</span><span class="s">&quot;org-find-exact-headline-in-buffer&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">parent</span><span class="p">]</span>
<span class="w">                            </span><span class="p">]</span>
<span class="w">                </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;save-buffer&quot;</span>
<span class="w">                </span><span class="p">])</span>
</pre></div>

<p></p>
This—as you probably guessed already—just executes the following elisp
snippet in Emacs’s batch mode:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="k">progn</span>
<span class="w">  </span><span class="p">(</span><span class="nv">find-file</span><span class="w"> </span><span class="err">«</span><span class="nv">fp</span><span class="err">»</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">end-of-buffer</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">org-refile</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span>
<span class="w">              </span><span class="p">(</span><span class="nf">list</span><span class="w"> </span><span class="err">«</span><span class="nv">parent</span><span class="err">»</span><span class="w"> </span><span class="err">«</span><span class="nv">fp</span><span class="err">»</span><span class="w"> </span><span class="no">nil</span>
<span class="w">                    </span><span class="p">(</span><span class="k">save-excursion</span>
<span class="w">                      </span><span class="p">(</span><span class="nv">org-find-exact-headline-in-buffer</span><span class="w"> </span><span class="err">«</span><span class="nv">parent</span><span class="err">»</span><span class="p">))))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">save-buffer</span><span class="p">))</span>
</pre></div>

<p></p>
I know this seems insane, but letting Emacs do this work is actually
much less brittle than the alternative. The Org maintainers certainly
know best what refiling <em>means</em>, and thus also what it entails—if all of
this logic is already written, why not take advantage of it? Plus, I
now don’t have to keep track of subtle changes in newer versions of Org.
<h2 id="closing-thoughts">Closing thoughts</h2>
<p></p>
Writing this was actually a lot of fun, and a great opportunity to play
with the <span class="small-caps">edsl</span> that X.U.Run exposes. I reckon there are a few places in
my own <span class="small-caps">xm</span>onad configuration in which I could use these kinds of “Emacs
scripts” to great effect!
<p></p>
One other idea I’ve had is to integrate this into the language that
plain old <code>orgPrompt</code> accepts. It could be prefixed by something like
“<code>ref:</code>”, followed by a unique substring with which to identity a
heading. This would have the disadvantage that—without the second
prompt—one would not get any suggestions for headings. However, if you
want to refile something you probably know where you want to put it;
plus, it would not involve a possibly distracting second prompt.
Actually, this sounds like a good first pull request: contributions
welcome!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Duality in Monoidal Categories</title>
    <link href="https://tony-zorman.com/posts/2023-01-10-duality-in-monoidal-categories.html" />
    <id>https://tony-zorman.com/posts/2023-01-10-duality-in-monoidal-categories.html</id>
    <published>2023-01-10T00:00:00Z</published>
    <updated>2023-01-10T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2023-01-10
      
        | <a title="All pages tagged 'maths'." href="/tags/maths.html">maths</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
I have a new preprint <a href="https://arxiv.org/abs/2301.03545">on the arXiv</a>! It is joint work with
Sebastian Halbig, and concerns itself with the interplay of different
structures on monoidal categories that give rise to a notion of
“duality”. At five pages, it is a very short paper; yet I’d still like
to give a little teaser as to what kind of question we sought to answer.
<!--more-->
<h2 id="setting-the-scene">Setting the scene</h2>
<p></p>
We mainly concerned ourselves with three notions of <em>duality</em> for
(non-symmetric!) <a href="https://ncatlab.org/nlab/show/monoidal+category">monoidal</a> categories: <a href="https://ncatlab.org/nlab/show/closed+monoidal+category">closed monoidal</a> categories,
<a href="https://ncatlab.org/nlab/show/star-autonomous+category">*-autonomous</a><!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">Or rather, a non-symmetric variant of it called an <em>r-category</em> in
<a href="https://zbmath.org/1370.18007">[BD13]</a>.</span></span>
 categories, and <a href="https://ncatlab.org/nlab/show/rigid+monoidal+category">rigid (monoidal)</a> categories. It
is well-known that these concepts are all connected in the following
way.
<blockquote>
<ol type="1">
<li><p></p>

Every *-autonomous category is closed monoidal.
For all <span class="math inline">\(x, y \in \mathcal{C}\)</span>, the internal-hom <span class="math inline">\([x, y]\)</span>
is given by <span class="math inline">\(D^{-1}(Dy \otimes x)\)</span>, where <span class="math inline">\(D\)</span> is the duality
functor.</li>
<li><p></p>

Every rigid monoidal category is *-autonomous. The internal-hom
then simplifies to <span class="math inline">\([x, y] = y \otimes x^*\)</span>, where <span class="math inline">\({-}^*\)</span> is the
duality functor.</li>
</ol>
</blockquote>
<p></p>
An obvious next question one could ask is: does this already
characterise rigid and *-autonomous categories? More explicitly, are
there any conditions one could impose on the internal-hom, such that
closedness already implies rigidity? What about *-autonomy?
<h2 id="autonomy">*-autonomy</h2>
<p></p>
We’ll start with a positive result for *-autonomy. So the question is
this: given a closed monoidal category <span class="math inline">\(\mathcal{C}\)</span> in which the
internal-hom is given by tensoring with another object, is this category
already *-autonomous?
<p></p>
More formally, is it true that <span class="math inline">\(\mathcal{C}\)</span> is *-autonomous if
for all <span class="math inline">\(x \in \mathcal{C}\)</span>, there exists an object
<span class="math inline">\(Dx \in \mathcal{C}\)</span>, such that there is an adjunction
<span class="math display">\[
  {-} \otimes x \dashv {-} \otimes Dx?
\]</span>
<p></p>
Almost! In good cases, we can recover what we want from just a little
extra condition:
<blockquote>
<p></p>
Let <span class="math inline">\(\mathcal{C}\)</span> be a monoidal category. Suppose that for all
<span class="math inline">\(x \in \mathcal{C}\)</span> there exist objects
<span class="math inline">\(Lx, Rx \in \mathcal{C}\)</span>, such that we have adjunctions
<span class="math display">\[
  {-} \otimes Lx  \dashv  {-} \otimes x  \dashv  {-} \otimes Rx.
\]</span>
Then <span class="math inline">\(\mathcal{C}\)</span> is *-autonomous.
</blockquote>
<p></p>
Using the notion of a *-autonomous category of <a href="https://zbmath.org/1370.18007">[BD13]</a>—that is, for
every <span class="math inline">\(x \in \mathcal{C}\)</span> the functor <span class="math inline">\(\mathcal{C}({-} \otimes x, 1)\)</span> is
representable by <span class="math inline">\(Dx\)</span>—this becomes an exercise in “Yoneda Yoga”. More
precisely, one uses the fact that the Yoneda embedding is fully faithful
a lot. Try it yourself!
<h2 id="rigidity">Rigidity</h2>
<p></p>
At first sight, it’s not even clear there is anything to show for
rigidity. Something one is immediately tempted to do is to conjecture
the following:
<blockquote>
<p></p>
A closed monoidal category <span class="math inline">\(\mathcal{C}\)</span> is rigid monoidal
if for all <span class="math inline">\(x \in \mathcal{C}\)</span> we have
<span class="math inline">\([x, {-}] \cong {-} \otimes Dx\)</span>, for some object assignment
<span class="math inline">\(D \colon \mathrm{Ob}\,\mathcal{C} \to \mathrm{Ob}\,\mathcal{C}\)</span>.
</blockquote>
<p></p>
This seems sensible; after all, the snake identities of an adjunction
look almost completely the same as the ones for a dual!<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">This is not a coincidence; for example, adjoints in the monoidal
category <span class="math inline">\(([\mathcal{C}, \mathcal{C}], \circ, \mathrm{Id})\)</span> are
exactly duals!.</span></span>
 However, if
one sits down and actually writes down the diagrams, something doesn’t
quite fit. As a reminder, suppose we have an adjunction
<span class="math inline">\(F\colon \mathcal{C} \leftrightarrows \mathcal{C} : \! U\)</span> with unit
<span class="math inline">\(\eta \colon \mathrm{Id}_{\mathcal{C}} \Longrightarrow U F\)</span>
and counit
<span class="math inline">\(\varepsilon \colon F U \Longrightarrow \mathrm{Id}_{\mathcal{C}}\)</span>.
The snake identities for this adjunction look like
<p></p>
<img class="pure-img" src="../images/duality-in-monoidal-categories/snake-idents-adjunction.png">
<p></p>
In particular, we get two such diagrams if we apply everything to the
monoidal unit <span class="math inline">\(1 \in \mathcal{C}\)</span>. Specialised to the adjunction
<span class="math inline">\({-} \otimes x \dashv {-} \otimes Dx\)</span> the above then becomes
<p></p>
<img class="pure-img" src="../images/duality-in-monoidal-categories/snake-idents-adjunction-specialised.png">
<p></p>
These are just the snake identities for duals if we make the definitions
<span class="math inline">\(\mathrm{ev}_x ≔ \varepsilon_1\)</span> and <span class="math inline">\(\mathrm{coev}_x ≔ \eta_1\)</span>, right?
Wrong! In the latter case we, for example, require that
<span class="math display">\[
  (x \otimes \varepsilon_1) \circ (\eta_1 \otimes x) = \mathrm{id}_x.
\]</span>
However, the above diagram does <em>not</em> say that! It says that the
relation
<span class="math display">\[
  \varepsilon_x \circ (\eta_1 \otimes x) = \mathrm{id}_x
\]</span>
holds. This means that we would have to impose the additional
conditions that <span class="math inline">\(\varepsilon\)</span> and <span class="math inline">\(\eta\)</span> are morphisms of modules; i.e.,
<span class="math inline">\(\varepsilon_x \overset{\scriptsize{!}}{=} x \otimes \varepsilon_1 = x \otimes \mathrm{coev}_x\)</span>,
as well as a dual statement. This is not the case in general.
<p></p>
Finding a counterexample now works by exploiting exactly this fact: we
write down a syntactic category <span class="math inline">\(\mathcal{D}\)</span> that is generated by a
family of morphisms
<span class="math display">\[
  \eta_{m, n} \colon m \to m \otimes n \otimes n
  \qquad \text{and} \qquad
  \varepsilon_{m, n} \colon m \otimes n \otimes n \to m,
\]</span>
and impose relations guaranteeing the naturality of these arrows. There
is a subcategory <span class="math inline">\(\mathcal{C}\)</span> of <span class="math inline">\(\mathcal{D}\)</span> in which we additionally
require <span class="math inline">\(\eta\)</span> and <span class="math inline">\(\varepsilon\)</span> satisfy the snake equations of an
adjunction. One can now show that the category <span class="math inline">\(\mathcal{C}\)</span> is closed
monoidal, with the appealing adjunction
<span class="math display">\[
  {-} \otimes n \dashv {-} \otimes n.
\]</span>
However, it is not rigid! The proof exploits certain strong monoidal
functors to the category of finite-dimensional vector spaces, and shows
that the subset of arrows <em>in <span class="math inline">\(\mathcal{D}\)</span></em> that contains one of the
snake identities for duals is (i) closed under exactly these relations,
and (ii) all morphisms in this set have length at least two. Hence, if
we project any morphism down to <span class="math inline">\(\mathcal{C}\)</span>, it can’t possibly be the
identity, and thus the snake identities for duals do not hold. If you
want more details, check <a href="https://arxiv.org/abs/2301.03545">the paper</a>!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Announcing: vc-use-package</title>
    <link href="https://tony-zorman.com/posts/2022-12-22-vc-use-package.html" />
    <id>https://tony-zorman.com/posts/2022-12-22-vc-use-package.html</id>
    <published>2022-12-22T00:00:00Z</published>
    <updated>2022-12-22T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-12-22
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->


<p></p>
I’d like to announce a small package I’ve written: <a href="https://github.com/slotThe/vc-use-package">vc-use-package</a>. It
is a first attempt at integrating the new (as of Emacs 29)
<code>package-vc.el</code> with the now built-in use-package. I’ve already talked
about how these two interact in my <a href="https://tony-zorman.com/posts/2022-11-30-package-vc-install.html">last post</a>—you can
see this package as automating things juuuust a little more.
<!--more-->
<h2 id="motivation">Motivation</h2>
<p></p>
For the last post, someone gave me some <a href="https://old.reddit.com/r/emacs/comments/z9i4ce/exploring_packagevcinstall_as_an_alternative_to/iygzeum/">feedback</a>:
couldn’t we go a little further? In particular, they wanted a new <code>:vc</code>
keyword for use-package, much like <a href="https://github.com/quelpa/quelpa">quelpa</a> has done with
<a href="https://github.com/quelpa/quelpa-use-package">quelpa-use-package</a>. I already gave them a small working example in a
follow-up comment, but figured this might actually interest enough
people so that turning it into a proper package could be worth it; and
here we are!
<p></p>
The basic premise is really this simple—we create a handler for a new
<code>:vc</code> use-package keyword. It can be used like so:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">math-delimiters</span>
<span class="w">  </span><span class="nb">:vc</span><span class="w"> </span><span class="p">(</span><span class="nb">:fetcher</span><span class="w"> </span><span class="nv">github</span><span class="w"> </span><span class="nb">:repo</span><span class="w"> </span><span class="nv">oantolin/math-delimiters</span><span class="p">))</span>
</pre></div>

<p></p>
One can specify most arguments that <code>package-vc-install</code> also accepts; for example:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">math-delimiters</span>
<span class="w">  </span><span class="nb">:vc</span><span class="w"> </span><span class="p">(</span><span class="nb">:fetcher</span><span class="w"> </span><span class="s">&quot;github&quot;</span>
<span class="w">       </span><span class="nb">:repo</span><span class="w"> </span><span class="s">&quot;oantolin/math-delimiters&quot;</span>
<span class="w">       </span><span class="nb">:rev</span><span class="w"> </span><span class="s">&quot;master&quot;</span><span class="w">         </span><span class="c1">; also accepts the special `:last-release'</span>
<span class="w">       </span><span class="nb">:backend</span><span class="w"> </span><span class="nv">Git</span><span class="p">))</span>
</pre></div>

<p></p>
Much like quelpa-use-package, there is some care needed concerning the
interaction between this package and the <code>use-package-always-ensure</code>
variable, but this should mostly be taken care of automatically. For
more information (and manual controls), see the
<a href="https://github.com/slotThe/vc-use-package#in-combination-with-use-package-always-ensure">README</a>.
<h2 id="conclusion">Conclusion</h2>
<p></p>
As I’ve said in the corresponding Reddit post, now that both
<code>package-vc.el</code> and use-package are built-in, someone should really add
this to Emacs proper. Alas, since I copied the idea and most of the
initial implementation from quelpa-use-package—and thus copyright
assignment is a bit iffy—it will not be me. Still, implementing this
from scratch does not sound so hard. If anyone feels inspired to do
exactly this, I’d be delighted!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Exploring package-vc-install</title>
    <link href="https://tony-zorman.com/posts/2022-11-30-package-vc-install.html" />
    <id>https://tony-zorman.com/posts/2022-11-30-package-vc-install.html</id>
    <published>2022-11-30T00:00:00Z</published>
    <updated>2022-11-30T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-11-30
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
The Emacs 29 release branch was just cut—and it’s chock full of new
features! In this post, I want to talk about the new
<code>package-vc-install</code> function, which allows one to install packages
directly from their respective upstream source; for example, GitHub. It
can be seen as a built-in alternative to things like quelpa or
straight.el.
<!--more-->
<h2 id="the-story-so-far">The story so far</h2>
<p></p>
I’ve been using <a href="https://github.com/quelpa/quelpa">quelpa</a> and <a href="https://github.com/quelpa/quelpa-use-package">quelpa-use-package</a> to install packages
that are not on any popular archive straight from source. Especially
the latter package resulted in an almost seemless integration with the
rest of my configuration; for example:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">math-delimiters</span>
<span class="w">  </span><span class="nb">:quelpa</span><span class="w"> </span><span class="p">(</span><span class="nv">math-delimiters</span><span class="w"> </span><span class="nb">:fetcher</span><span class="w"> </span><span class="nv">github</span><span class="w"> </span><span class="nb">:repo</span><span class="w"> </span><span class="s">&quot;oantolin/math-delimiters&quot;</span><span class="p">))</span>
</pre></div>

<p></p>
<a href="https://git.savannah.gnu.org/cgit/emacs.git/commit/?id=5fa2f116799b8a7c17ff6eedd6e1b1af077c116b">Recently</a>, Emacs added built-in capabilities for
installing a package directly from its remote repository. Eager to
shave yet another external package from my otherwise ever growing list,
I took <code>package-vc.el</code> out for a spin: turns out, it almost perfectly
covers the use-case for which I—and perhaps a few other people—used
quelpa up until now!
<p></p>
The most user-facing of these new functions is <code>package-vc-install</code>,
with signature
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">package-vc-install</span><span class="w"> </span><span class="nv">PACKAGE</span><span class="w"> </span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">NAME</span><span class="w"> </span><span class="nv">REV</span><span class="w"> </span><span class="nv">BACKEND</span><span class="p">)</span>
</pre></div>

<p></p>
In the simplest case, it takes a URL pointing to some online source as
its argument and installs the respective package from there, guessing
the name from the URL. In case that doesn’t work—or one wants more
control, like requiring a specific revision—there are some other
optional arguments available, see the function’s documentation.
<h2 id="customising-package-vc-install">Customising <code>package-vc-install</code></h2>
<p></p>
When a package is already installed, <code>package-vc-install</code> will ask the
user to interactively confirm whether they really want to overwrite the
existing directory. Naturally, this is not a good experience when
trying to use this in a non-interactive fashion.
<p></p>
There are a few ways one could go about fixing this. One of these is
even documented in the manual: customise <code>package-vc-selected-packages</code>
and then call <code>package-vc-install-selected-packages</code>, which works much
like <code>package-install-selected-packages</code>. However, this feels
unergonomic to me—at least considering that I want to use
<code>package-vc-install</code> as a (hopefully) drop-in replacement for
use-package’s <code>quelpa</code> keyword. Plus, I’d rather have the information
that package X is not installed from *<span class="small-caps">elpa</span> local to the use-package
declaration of X itself.
<p></p>
So, let’s take the easy way out and write a small wrapper:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">cl-defun</span><span class="w"> </span><span class="nv">slot/vc-install</span><span class="w"> </span><span class="p">(</span><span class="kp">&amp;key</span><span class="w"> </span><span class="p">(</span><span class="nv">fetcher</span><span class="w"> </span><span class="s">&quot;github&quot;</span><span class="p">)</span><span class="w"> </span><span class="nv">repo</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">rev</span><span class="w"> </span><span class="nv">backend</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Install a package from a remote if it's not already installed.</span>
<span class="s">This is a thin wrapper around </span><span class="ss">`package-vc-install'</span><span class="s"> in order to</span>
<span class="s">make non-interactive usage more ergonomic.  Takes the following</span>
<span class="s">named arguments:</span>

<span class="s">- FETCHER the remote where to get the package (e.g., \&quot;gitlab\&quot;).</span>
<span class="s">  If omitted, this defaults to \&quot;github\&quot;.</span>

<span class="s">- REPO should be the name of the repository (e.g.,</span>
<span class="s">  \&quot;slotThe/arXiv-citation\&quot;.</span>

<span class="s">- NAME, REV, and BACKEND are as in </span><span class="ss">`package-vc-install'</span><span class="s"> (which</span>
<span class="s">  see).&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">url</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;https://www.%s.com/%s&quot;</span><span class="w"> </span><span class="nv">fetcher</span><span class="w"> </span><span class="nv">repo</span><span class="p">))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">iname</span><span class="w"> </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="p">(</span><span class="nf">intern</span><span class="w"> </span><span class="nv">name</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">pac-name</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="nv">iname</span><span class="w"> </span><span class="p">(</span><span class="nf">intern</span><span class="w"> </span><span class="p">(</span><span class="nv">file-name-base</span><span class="w"> </span><span class="nv">repo</span><span class="p">)))))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">unless</span><span class="w"> </span><span class="p">(</span><span class="nv">package-installed-p</span><span class="w"> </span><span class="nv">pac-name</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">package-vc-install</span><span class="w"> </span><span class="nv">url</span><span class="w"> </span><span class="nv">iname</span><span class="w"> </span><span class="nv">rev</span><span class="w"> </span><span class="nv">backend</span><span class="p">))))</span>
</pre></div>

<p></p>
This function can now be used under the <code>init</code> keyword of the
use-package macro, almost without changing the shape of the declaration
from above:
<div class="highlight"><pre><span></span><span class="c1">;; Before</span>
<span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">math-delimiters</span>
<span class="w">  </span><span class="nb">:quelpa</span><span class="w"> </span><span class="p">(</span><span class="nv">math-delimiters</span><span class="w"> </span><span class="nb">:fetcher</span><span class="w"> </span><span class="nv">github</span><span class="w"> </span><span class="nb">:repo</span><span class="w"> </span><span class="s">&quot;oantolin/math-delimiters&quot;</span><span class="p">))</span>

<span class="c1">;; After</span>
<span class="p">(</span><span class="nb">use-package</span><span class="w"> </span><span class="nv">math-delimiters</span>
<span class="w">  </span><span class="nb">:init</span><span class="w"> </span><span class="p">(</span><span class="nv">slot/vc-install</span><span class="w"> </span><span class="nb">:fetcher</span><span class="w"> </span><span class="s">&quot;github&quot;</span><span class="w"> </span><span class="nb">:repo</span><span class="w"> </span><span class="s">&quot;oantolin/math-delimiters&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="c1">;; OR (slot/vc-install :repo &quot;oantolin/math-delimiters&quot;)</span>
<span class="w">  </span><span class="p">)</span>
</pre></div>

<p></p>
In case you think I cherry picked the example, <a href="https://gitlab.com/slotThe/dotfiles/-/commit/6d55ac184af125a117215a1bb812ad75c5b0ab03">here</a>
is the full commit that exchanges quelpa for <code>slot/vc-install</code>.
<h2 id="thats-all-folks">That’s all folks!</h2>
<p></p>
Admittedly, my use of quelpa was rather primitive. I can imagine users
more heavily invested in, for example, the <code>straight.el</code> ecosystem
probably want a bit more out of their package manager than <code>package.el</code>
can give them right now, even with the added convenience of
<code>package-vc.el</code>. However, for me—and probably at least a few people out
there—this is quite enough. After all, for anything more there’s always
<a href="https://nixos.org/">nix</a> :)

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Adjusting preview.el for vertical monitors</title>
    <link href="https://tony-zorman.com/posts/2022-11-05-vertical-previews.html" />
    <id>https://tony-zorman.com/posts/2022-11-05-vertical-previews.html</id>
    <published>2022-11-05T00:00:00Z</published>
    <updated>2022-11-05T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-11-05
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->


<p></p>
Here’s a fun one: when previewing LaTeX fragments via AUCTeX’s
<code>preview.el</code> library (whether it be in a .tex buffer, or—via
<a href="https://github.com/karthink/org-auctex">org-auctex</a>—in Org) things get <em>really</em> messed up when one or more
monitors are set up in portrait mode.
<!--more-->
<p></p>
When you have two monitors oriented vertically, previews might end up
looking something like this:
<p style="text-align:center;">
<img class="pure-img" src="../images/vertical-preview/two-vertical.png">
</p>
<p></p>
With the perhaps more common setup of one vertical and one horizontal
monitor, you could instead get the charming
<p style="text-align:center;">
<img class="pure-img" src="../images/vertical-preview/one-vertical.png">
</p>
<p></p>
Imagine a whole page of this—things get pretty funky. Being a boring
person, I would rather prefer the much more ordinary looking
<p style="text-align:center;">
<img class="pure-img" src="../images/vertical-preview/normal.png">
</p>
<p></p>
Thankfully, this isn’t so complicated. Looking into <code>preview.el</code>, we
get the geometry of the frame from <code>preview-get-geometry</code>. At least,
this is what <code>preview-generate-preview</code> calls before delegating the
heavy lifting to some internal functions. After staring at the former
function for a while, one can single out <code>preview-get-dpi</code> as the main
culprit. It seems to calculate the “resolution” of the preview:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">preview-get-dpi</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">monitor-attrs</span><span class="w"> </span><span class="p">(</span><span class="nv">frame-monitor-attributes</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">mm-dims</span><span class="w"> </span><span class="p">(</span><span class="nf">cdr</span><span class="w"> </span><span class="p">(</span><span class="nf">assoc</span><span class="w"> </span><span class="ss">'mm-size</span><span class="w"> </span><span class="nv">monitor-attrs</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">mm-width</span><span class="w"> </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">mm-dims</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">mm-height</span><span class="w"> </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">mm-dims</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">pixel-dims</span><span class="w"> </span><span class="p">(</span><span class="nv">cl-cdddr</span><span class="w"> </span><span class="p">(</span><span class="nf">assoc</span><span class="w"> </span><span class="ss">'geometry</span><span class="w"> </span><span class="nv">monitor-attrs</span><span class="p">)))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">pixel-width</span><span class="w"> </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">pixel-dims</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">pixel-height</span><span class="w"> </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">pixel-dims</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="p">(</span><span class="nf">/</span><span class="w"> </span><span class="p">(</span><span class="nf">*</span><span class="w"> </span><span class="mf">25.4</span><span class="w"> </span><span class="nv">pixel-width</span><span class="p">)</span><span class="w"> </span><span class="nv">mm-width</span><span class="p">)</span>
<span class="w">            </span><span class="p">(</span><span class="nf">/</span><span class="w"> </span><span class="p">(</span><span class="nf">*</span><span class="w"> </span><span class="mf">25.4</span><span class="w"> </span><span class="nv">pixel-height</span><span class="p">)</span><span class="w"> </span><span class="nv">mm-height</span><span class="p">))))</span>
</pre></div>

<p></p>
Monitor details are returned by the <code>frame-monitor-attributes</code> function;
its output for a horizontal monitor is
<div class="highlight"><pre><span></span><span class="w">  </span><span class="o">'</span><span class="p">((</span><span class="nv">name</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;DP1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">geometry</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1920</span><span class="w"> </span><span class="mi">1080</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">workarea</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1920</span><span class="w"> </span><span class="mi">1080</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">mm-size</span><span class="w"> </span><span class="mi">530</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">frames</span><span class="w"> </span><span class="nv">&lt;&lt;omitted&gt;&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">source</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;XRandR 1.5&quot;</span><span class="p">))</span>
</pre></div>

<p></p>
While the same monitor in “vertical-mode” returns
<div class="highlight"><pre><span></span><span class="w">  </span><span class="o">'</span><span class="p">((</span><span class="nv">name</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;DP1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">geometry</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1080</span><span class="w"> </span><span class="mi">1920</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">workarea</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1080</span><span class="w"> </span><span class="mi">1920</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">mm-size</span><span class="w"> </span><span class="mi">530</span><span class="w"> </span><span class="mi">300</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">frames</span><span class="w"> </span><span class="nv">&lt;&lt;omitted&gt;&gt;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">source</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;XRandR 1.5&quot;</span><span class="p">))</span>
</pre></div>

<p></p>
Crucially, the physical width and height of the monitor don’t change,
but the <em>geometry</em>—the pixel width and height—does; you can <code>C-h f display-monitor-attributes-list RET</code> for more information. This means
that in portrait mode, we actually compare the pixel <em>width</em> of the
monitor with its physical <em>height</em>, as well as its pixel height with its
width. Naturally, and depending on the specific setup, this produces
too narrow or too wide previews.
<p></p>
The solution is to only compare the comparable values. Indeed,
overriding the built-in <code>preview-get-dpi</code> function with
<div class="highlight"><pre><span></span><span class="w">  </span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">preview-get-dpi</span><span class="w"> </span><span class="p">()</span>
<span class="w">    </span><span class="p">(</span><span class="nv">-let</span><span class="w"> </span><span class="p">(((</span><span class="nv">&amp;alist</span><span class="w"> </span><span class="ss">'mm-size</span><span class="w"> </span><span class="p">(</span><span class="nv">mw</span><span class="w"> </span><span class="nv">mh</span><span class="p">)</span>
<span class="w">                    </span><span class="ss">'geometry</span><span class="w"> </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="nv">_</span><span class="w"> </span><span class="nv">pw</span><span class="w"> </span><span class="nv">ph</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nv">frame-monitor-attributes</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="p">(</span><span class="nf">/</span><span class="w"> </span><span class="p">(</span><span class="nf">*</span><span class="w"> </span><span class="mf">25.4</span><span class="w"> </span><span class="p">(</span><span class="nf">max</span><span class="w"> </span><span class="nv">pw</span><span class="w"> </span><span class="nv">ph</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">max</span><span class="w"> </span><span class="nv">mw</span><span class="w"> </span><span class="nv">mh</span><span class="p">))</span>
<span class="w">            </span><span class="p">(</span><span class="nf">/</span><span class="w"> </span><span class="p">(</span><span class="nf">*</span><span class="w"> </span><span class="mf">25.4</span><span class="w"> </span><span class="p">(</span><span class="nf">min</span><span class="w"> </span><span class="nv">pw</span><span class="w"> </span><span class="nv">ph</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">min</span><span class="w"> </span><span class="nv">mw</span><span class="w"> </span><span class="nv">mh</span><span class="p">)))))</span>
</pre></div>

<p></p>
produces the correct behaviour! This implicit assumption—that monitors
are generally wider than they are tall—of <code>preview-get-dpi</code> should
probably be fixed; I will report it as an Emacs bug.
<p></p>
As an aside, this is an excellent opportunity to see the ergonomic
benefits of the <a href="https://github.com/magnars/dash.el">dash.el</a> library. Compare the readability of the
“fixed” implementation using <code>-let</code> to the original one above. I
certainly know which of the two I’d rather write!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>A Potpourri of Emacs Tweaks</title>
    <link href="https://tony-zorman.com/posts/2022-10-22-emacs-potpourri.html" />
    <id>https://tony-zorman.com/posts/2022-10-22-emacs-potpourri.html</id>
    <published>2022-10-22T00:00:00Z</published>
    <updated>2022-10-22T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-10-22
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
Emacs is the “extensible text editor”, and it wouldn’t be fun if one
didn’t at least try to take advantage of that, right? Having just
written a <a href="https://gitlab.com/slotThe/dotfiles/-/tree/master/emacs/.config/emacs">README</a> for my Emacs configuration, I
thought it might be nice to somewhat expand on certain ideas and give a
little context to some snippets that have accumulated over time.
<p></p>
While there is a post about <a href="https://tony-zorman.com/posts/query-replace/2022-08-06-query-replace-many.html">my version</a> of the
<code>query-replace</code> function, most other tidbits have only seen the light of
day in places like the “Weekly Tips, Tricks, &c.” thread on Reddit. In
the spirit of hosting my content somewhere that I actually control,<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">I am aware of the futility of this—Reddit is almost certainly
going to be around longer than my personal site will. And yet,
this feels “more correct” in some way.</span></span>

I chose to showcase these again here, hoping that other people may also
find some of this stuff useful.
<!--more-->
<h2 id="frame-inhibit-implied-resize"><code>frame-inhibit-implied-resize</code></h2>
<p></p>
This variable is interesting for all the people who, for one reason or
another, care about the startup time of their Emacs session. Even more
if one uses a tiling window manager, as then Emacs doesn’t get a say in
how big its frame will be anyway. An excerpt from the documentation:
<blockquote>
<p></p>
Whether frames should be resized implicitly.
<p></p>
If this option is nil, setting font, menu bar, tool bar, tab bar,
internal borders, fringes or scroll bars of a specific frame may
resize the frame in order to preserve the number of columns or lines
it displays. If this option is t, no such resizing is done.
</blockquote>
<p></p>
I always wondered why startup time skyrocketed whenever I changed the
default font to something else—surely opening a font and using it can’t
be that expensive! What I didn’t realise was that what I set was
slightly larger than Emacs’s default font, which I reckon was some kind
of monospace fallback on my system. Setting
<code>frame-inhibit-implied-resize</code> to <code>t</code> will thusly prevent Emacs from
trying to—futilely, since I use <a href="https://xmonad.org"><span class="small-caps">xm</span>onad</a>—resize its frame in order to
“preserve the number of columns or lines it displays”. The upshot is
that this cuts my startup time from just over 1 second to about 0.8
seconds. This may not seem like much, but it’s literally <a href="https://gitlab.com/slotThe/dotfiles/-/blob/460060b7b5e164e6b892397e264b0da470ed74c9/emacs/.config/emacs/early-init.el#L51">setting a
single variable</a> in my <code>early-init.el</code>—pretty good
value for money.
<h2 id="pixel-scroll-precision-mode"><code>pixel-scroll-precision-mode</code></h2>
<p></p>
This is pretty old news by now, but I wanted to take the opportunity to
again praise <code>pixel-scroll-precision-mode</code>. My day job is being a <a href="./phd-workflow/2022-05-01-my-phd-workflow.html">PhD
student in maths</a>, which means that I write a lot of
LaTeX and also use Org extensively for taking notes. While ordinary
LaTeX entry in Org works quite well, commutative diagrams are a pain
more often than not. In fact, It’s much easier to draw them with a tool
like <a href="https://q.uiver.app/">quiver</a>, make a screenshot, and then include the resulting picture
in the file. However, now we have the problem that Emacs treats
pictures as very large single characters—the result is a scrolling
experience that’s very far from optimal. This is <em>exactly</em> where
<code>pixel-scroll-precision-mode</code> comes in and saves the day, but see the
difference for yourself:
<video width="100%" controls>
<source src="../images/emacs-potpourri/pixel-scroll-precision-mode.mp4" type="video/mp4">
</video>
<h2 id="quickly-insert-images-in-org-roam">Quickly insert images in <code>org-roam</code></h2>
<p></p>
Speaking of inserting images into Org; how does one do that, exactly?
Doing everything by hand seems like a slog: select an arbitrary
rectangle on the screen, take a screenshot of it, move the resulting
picture into the correct directory, give it an appropriate name, and
insert a link to it into the current buffer. This sounds like a lot of
busywork for something that I ideally don’t want to think about at all;
thankfully, most of this can be nicely automated.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/org-roam-insert-image</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="s">&quot;Select and insert an image at point.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">interactive</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">file-name</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;%s-%s.png&quot;</span>
<span class="w">                            </span><span class="p">(</span><span class="nv">file-name-sans-extension</span><span class="w"> </span><span class="p">(</span><span class="nf">buffer-name</span><span class="p">))</span>
<span class="w">                            </span><span class="p">(</span><span class="nv">cl-random</span><span class="w"> </span><span class="p">(</span><span class="nf">expt</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="mi">31</span><span class="p">))))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">path</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;%s/%s/%s&quot;</span><span class="w"> </span><span class="nv">org-roam-directory</span><span class="w"> </span><span class="s">&quot;images&quot;</span><span class="w"> </span><span class="nv">file-name</span><span class="p">)))</span>
<span class="w">    </span><span class="c1">;; The mouse movement via xdotool is needed because otherwise, if</span>
<span class="w">    </span><span class="c1">;; unclutter is active, the pointer will remain hidden.  Uff.</span>
<span class="w">    </span><span class="p">(</span><span class="nf">call-process</span><span class="w"> </span><span class="s">&quot;xdotool&quot;</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="s">&quot;mousemove_relative&quot;</span><span class="w"> </span><span class="s">&quot;--&quot;</span><span class="w"> </span><span class="s">&quot;-1&quot;</span><span class="w"> </span><span class="s">&quot;0&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">scrot-exit</span><span class="w"> </span><span class="p">(</span><span class="nf">call-process</span><span class="w"> </span><span class="s">&quot;scrot&quot;</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span>
<span class="w">                                    </span><span class="s">&quot;-z&quot;</span><span class="w"> </span><span class="s">&quot;-f&quot;</span><span class="w"> </span><span class="s">&quot;-s&quot;</span><span class="w"> </span><span class="s">&quot;--file&quot;</span><span class="w"> </span><span class="nv">path</span><span class="p">)))</span>
<span class="w">      </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">scrot-exit</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;[[../images/%s]]&quot;</span><span class="w"> </span><span class="nv">file-name</span><span class="p">))))))</span>
</pre></div>

<p></p>
All it needs is <code>xdotool</code> for moving the mouse (though, if you don’t use
<code>unclutter</code> then this may well be deleted) and <code>scrot</code> for actually
taking the screenshot. Pretty convenient. If <code>scrot</code> is too low-tech
for you, then the above snippet probably also works with <code>flameshot</code> or
a similar tool.
<h2 id="latex-for-the-lazy-mathematician">LaTeX for the lazy mathematician</h2>
<p></p>
I am pretty impatient when it comes to LaTeX entry. So impatient that I
have created a few “now you’re really taking it too far”-type of
functions. To be honest, they kind of delight me.
<p></p>
First, the following is an override for the <code>self-insert-command</code>, which
enables faster entry of one-character math symbols:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/LaTeX-self-insert</span><span class="w"> </span><span class="p">(</span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">arg</span><span class="w"> </span><span class="nv">char</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;</span><span class="ss">`self-insert-command'</span><span class="s"> for LaTeX mode.</span>
<span class="s">If the previous word is just a single character, surround it with</span>
<span class="s">dollar signs.  If already in math mode, do nothing.  If the</span>
<span class="s">character is a single </span><span class="ss">`a'</span><span class="s">, do nothing.</span>

<span class="s">If called with a single \\[universal-argument], just call</span>
<span class="ss">`self-insert-command'</span><span class="s">.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">interactive</span><span class="w"> </span><span class="s">&quot;P&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nb">pcase</span><span class="w"> </span><span class="nv">arg</span>
<span class="w">    </span><span class="p">(</span><span class="o">'</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">self-insert-command</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">_</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">ppoint</span><span class="w"> </span><span class="p">(</span><span class="k">save-excursion</span><span class="w"> </span><span class="p">(</span><span class="nv">backward-word</span><span class="p">)</span><span class="w">       </span><span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="nv">ipoint</span><span class="w"> </span><span class="p">(</span><span class="k">save-excursion</span><span class="w"> </span><span class="p">(</span><span class="nv">back-to-indentation</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">point</span><span class="p">)))</span>
<span class="w">             </span><span class="p">(</span><span class="nv">word</span><span class="w">   </span><span class="p">(</span><span class="nv">word-at-point</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nb">unless</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nv">length&gt;</span><span class="w"> </span><span class="nv">word</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">   </span><span class="c1">; longer than a single character</span>
<span class="w">                     </span><span class="p">(</span><span class="nv">not</span><span class="w"> </span><span class="nv">word</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="nv">ipoint</span><span class="w"> </span><span class="nv">ppoint</span><span class="p">)</span><span class="w">  </span><span class="c1">; the first thing on a new line</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">equal</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="w"> </span><span class="nv">word</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nv">number-at-point</span><span class="p">)</span>
<span class="w">                     </span><span class="p">(</span><span class="nv">texmathp</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nv">-let</span><span class="w"> </span><span class="p">(((</span><span class="nv">open</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">close</span><span class="p">)</span><span class="w"> </span><span class="nv">math-delimiters-inline</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="nf">backward-char</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="nv">open</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">forward-char</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="nv">close</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nf">self-insert-command</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">char</span><span class="p">)))))</span>
</pre></div>

<p></p>
Bound to <code>&lt;SPC&gt;</code> (and also things like <code>.</code> and <code>-</code>), it enables one to
write <code>"foo T&lt;SPC&gt;"</code> and have Emacs insert <code>"foo $T$ "</code> instead—very
convenient, and much faster even than having a snippet to insert dollars
based on some condition.
<p></p>
The laziness continues with me not wanting to write <code>\blank</code> so
often.<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">This is a placeholder that’s often used when not wanting to
explicitly quantify over an argument.</span></span>
 I could also create an auto-expanding snippet for this, but
wouldn’t it be <em>much better</em> to insert it on a double tap of the space
bar instead? I think so!
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/LaTeX-space</span><span class="w"> </span><span class="p">(</span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">arg</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Insert a space; or not.</span>
<span class="s">In case the previous character was already a space, insert</span>
<span class="s">\\blank instead.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">interactive</span><span class="w"> </span><span class="s">&quot;P&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="nf">=</span><span class="w"> </span><span class="sc">?\s</span><span class="w"> </span><span class="p">(</span><span class="nf">char-before</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nv">texmathp</span><span class="p">))</span>
<span class="w">      </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="s">&quot;\\blank &quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">slot/LaTeX-self-insert</span><span class="w"> </span><span class="nv">arg</span><span class="w"> </span><span class="sc">?\s</span><span class="p">)))</span>
</pre></div>

<p></p>
Now, writing something like <code>"C(&lt;SPC&gt;&lt;SPC&gt;,&lt;SPC&gt;&lt;SPC&gt;)"</code> in math-mode
nicely inserts <code>"C( \blank , \blank )"</code>. Because the space bar is so
easy to press, this is again marginally faster than having to write
something like <code>"C(bln,bln)"</code>.
<p></p>
Together with auto-expanding snippets, this enables reasonably fast
LaTeX entry:
<p></p>
<img class="pure-img" src="../images/emacs-potpourri/latex-entry.gif">
<p></p>
More examples can be found in the <a href="./phd-workflow/2022-05-01-my-phd-workflow.html#digital-notes">post</a> about
my research workflow.
<h2 id="erc">ERC</h2>
<p></p>
I recently switched from WeeChat to <a href="https://www.gnu.org/software/emacs/erc.html">ERC</a> for IRC. It’s
really great so far, but some things felt a bit lackluster out of the
box. As such, my <a href="https://gitlab.com/slotThe/dotfiles/-/blob/460060b7b5e164e6b892397e264b0da470ed74c9/emacs/.config/emacs/lisp/erc-config.el">ERC config</a> has already grown quite a
bit.<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Though it’s still much smaller than whatever it is that WeeChat
auto-generates :)</span></span>
 The following are a few tweaks that improve my experience
greatly.
<h3 id="mark-the-current-frame-as-urgent">Mark the current frame as urgent</h3>
<p></p>
One feature I was dearly missing was the ability to set <a href="https://tronche.com/gui/x/xlib/ICC/client-to-window-manager/wm-hints.html">urgency
hints</a> in the case I get highlighted/pinged. This is
essentially the window telling your window manager or desktop
environment that it wants your attention. You can then execute an
action based on this urgency hint. Thankfully, Emacs is extensible, so
hacking this behaviour into ERC wasn’t actually all that complicated.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/mark-emacs-urgent</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="s">&quot;Mark the current frame as urgent.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">WM-HINTS</span><span class="w"> </span><span class="s">&quot;WM_HINTS&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nv">hints</span><span class="w"> </span><span class="p">(</span><span class="nv">seq--into-list</span>
<span class="w">                 </span><span class="c1">;; By default this returns a string/vector.</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">x-window-property</span><span class="w"> </span><span class="nv">WM-HINTS</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="nv">WM-HINTS</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">t</span><span class="p">))))</span>
<span class="w">    </span><span class="c1">;; Urgency flag: (1L &lt;&lt; 8) == 256</span>
<span class="w">    </span><span class="c1">;; Source (as always): https://tronche.com/gui/x/xlib/ICC/client-to-window-manager/wm-hints.html</span>
<span class="w">    </span><span class="p">(</span><span class="nf">setcar</span><span class="w"> </span><span class="nv">hints</span><span class="w"> </span><span class="p">(</span><span class="nf">logior</span><span class="w"> </span><span class="p">(</span><span class="nf">car</span><span class="w"> </span><span class="nv">hints</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">lsh</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">8</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">x-change-window-property</span><span class="w"> </span><span class="nv">WM-HINTS</span><span class="w"> </span><span class="nv">hints</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="nv">WM-HINTS</span><span class="w"> </span><span class="mi">32</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/beep-on-match</span><span class="w"> </span><span class="p">(</span><span class="nv">match-type</span><span class="w"> </span><span class="nv">_nickuserhost</span><span class="w"> </span><span class="nf">message</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Beep and mark the frame as urgent on highlight.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">visible-bell</span><span class="w"> </span><span class="no">nil</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">slot/mark-emacs-urgent</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">erc-beep-on-match</span><span class="w"> </span><span class="nv">match-type</span><span class="w"> </span><span class="nv">_nickuserhost</span><span class="w"> </span><span class="nf">message</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">add-hook</span><span class="w"> </span><span class="ss">'erc-text-matched-hook</span><span class="w"> </span><span class="nf">#'</span><span class="nv">slot/beep-on-match</span><span class="p">)</span>
</pre></div>

<p></p>
And that’s really it! Now ERC correctly sends an urgency hint whenever
I get highlighted. Note that, <a href="https://old.reddit.com/r/emacs/comments/xjyuni/weekly_tips_tricks_c_thread/ipfjlw0/">as we found out</a>, if
you use a reparenting window manager (you probably do if you use a
desktop environment) you might have to give <code>x-change-window-property</code>
above an extra <code>t</code> argument.
<h3 id="dont-highlight-quite-so-much">Don’t highlight quite so much</h3>
<p></p>
Having configured quite a few regular expressions for when I get
highlighted, things can get quite overwhelming at times. For example,
when ERC starts up it prints <code>/users</code> in every channel buffer. Of
course, I’m a user in a channel that I’m in, so Emacs happily starts
beeping and throwing around urgency hints—not a good experience. This
also clutters the <code>ERC Keywords</code> buffer (which is built-in and akin to
WeeChat’s <code>highmon.pl</code>).
<p></p>
Thankfully, however, there is a straightforward hack around this: just
check the message for certain regular expression first and do nothing
when they are present.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/erc-ignore-highlight</span><span class="w"> </span><span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Don't highlight me when these things happen.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nf">message</span><span class="w"> </span><span class="p">(</span><span class="nv">s-trim-left</span><span class="w"> </span><span class="nv">msg</span><span class="p">))</span>
<span class="w">        </span><span class="p">(</span><span class="nv">channel</span><span class="w"> </span><span class="p">(</span><span class="k">or</span><span class="w"> </span><span class="p">(</span><span class="nv">erc-default-target</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">--any?</span><span class="w"> </span><span class="p">(</span><span class="nv">s-prefix?</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nf">message</span><span class="p">)</span>
<span class="w">            </span><span class="o">`</span><span class="p">(</span><span class="s">&quot;*** Users on&quot;</span>
<span class="w">              </span><span class="s">&quot;*** Your new nickname is&quot;</span>
<span class="w">              </span><span class="s">&quot;*** Welcome to the&quot;</span>
<span class="w">              </span><span class="o">,</span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="s">&quot;*** &quot;</span><span class="w"> </span><span class="nv">channel</span><span class="w"> </span><span class="s">&quot;: topic set by&quot;</span><span class="p">)))))</span>
</pre></div>

<p></p>
All that’s left to do is to thread this function through to
<code>erc-log-matches</code> and the above-defined <code>slot/beep-on-match</code>:
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/erc-log-matches</span><span class="w"> </span><span class="p">(</span><span class="nv">match-type</span><span class="w"> </span><span class="nv">nickuserhost</span><span class="w"> </span><span class="nf">message</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Log matches to extra buffer, unless they are annoying.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">unless</span><span class="w"> </span><span class="p">(</span><span class="nv">slot/erc-ignore-highlight</span><span class="w"> </span><span class="nf">message</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="nv">erc-log-matches</span><span class="w"> </span><span class="nv">match-type</span><span class="w"> </span><span class="nv">nickuserhost</span><span class="w"> </span><span class="nf">message</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/beep-on-match</span><span class="w"> </span><span class="p">(</span><span class="nv">match-type</span><span class="w"> </span><span class="nv">_nickuserhost</span><span class="w"> </span><span class="nf">message</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Beep and mark the frame as urgent on highlight.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">visible-bell</span><span class="w"> </span><span class="no">nil</span><span class="p">))</span>
<span class="w">    </span><span class="p">(</span><span class="nb">unless</span><span class="w"> </span><span class="p">(</span><span class="nv">slot/erc-ignore-highlight</span><span class="w"> </span><span class="nf">message</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">slot/mark-emacs-urgent</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">erc-beep-on-match</span><span class="w"> </span><span class="nv">match-type</span><span class="w"> </span><span class="nv">_nickuserhost</span><span class="w"> </span><span class="nf">message</span><span class="p">))))</span>

<span class="c1">;; As before, now add the appropriate hooks to `erc-text-matched-hook'.</span>
</pre></div>

<p></p>
If it works, it works, right?
<h2 id="inserting-links">Inserting links</h2>
<p></p>
Next to being a user, I also spend way too much time working on <span class="small-caps">xm</span>onad.
As such, I often help people coming into our IRC or posting on the
subreddit with their problems. More often than not one needs to link to
the same resources over and over again—why not write something so that I
don’t have to dig up these links again and again?
<p></p>
I currently have a set-up where I can link to every <span class="small-caps">xm</span>onad module, all
of my blog posts, as well as selected extra sites, like our tutorial and
installation instructions. Depending on the given universal argument, a
different link style is used, to accomodate for different platforms.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/get-xmonad-modules</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="s">&quot;Get all XMonad modules in the form (NAME . DOC-URL).&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">xmonad-cabal</span><span class="w"> </span><span class="s">&quot;~/repos/xmonad/xmonad-contrib/xmonad-contrib.cabal&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nv">hackage</span><span class="w"> </span><span class="s">&quot;https://hackage.haskell.org/package/xmonad-contrib/docs/&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nv">modules</span><span class="w"> </span><span class="p">(</span><span class="nv">shell-command-to-string</span>
<span class="w">                   </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="s">&quot;tail -n +50 %s | grep -E \&quot; XMonad\\.*\&quot;&quot;</span>
<span class="w">                           </span><span class="nv">xmonad-cabal</span><span class="p">))))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">-&gt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="nv">s-lines</span><span class="w"> </span><span class="nv">modules</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nv">-drop-last</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">                 </span><span class="c1">; empty line</span>
<span class="w">         </span><span class="p">(</span><span class="nv">--map</span><span class="w"> </span><span class="p">(</span><span class="nv">s-trim</span><span class="w"> </span><span class="p">(</span><span class="nv">s-replace</span><span class="w"> </span><span class="s">&quot;exposed-modules:&quot;</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="nv">it</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">--map</span><span class="w"> </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="nv">it</span>
<span class="w">                      </span><span class="p">(</span><span class="nf">format</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">hackage</span><span class="w"> </span><span class="p">(</span><span class="nv">s-replace</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="nv">it</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;.html&quot;</span><span class="p">)))))))</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/get-posts</span><span class="w"> </span><span class="p">()</span>
<span class="w">  </span><span class="s">&quot;Get all of my blog posts in the form (NAME . URL).&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">let*</span><span class="w"> </span><span class="p">((</span><span class="nv">website</span><span class="w"> </span><span class="s">&quot;https://tony-zorman.com/&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nv">base-path</span><span class="w"> </span><span class="s">&quot;~/repos/slotThe.github.io/&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="p">(</span><span class="nv">posts</span><span class="w"> </span><span class="p">(</span><span class="nv">directory-files-recursively</span><span class="w"> </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">base-path</span><span class="w"> </span><span class="s">&quot;posts/&quot;</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;.md$&quot;</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nv">--map</span><span class="w"> </span><span class="p">(</span><span class="nb">with-temp-buffer</span>
<span class="w">             </span><span class="p">(</span><span class="nv">insert-file-contents-literally</span><span class="w"> </span><span class="nv">it</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">search-forward</span><span class="w"> </span><span class="s">&quot;title: &quot;</span><span class="p">)</span>
<span class="w">             </span><span class="p">(</span><span class="nf">cons</span><span class="w">                      </span><span class="c1">; Name . URL</span>
<span class="w">              </span><span class="p">(</span><span class="nv">string-replace</span><span class="w"> </span><span class="s">&quot;\&quot;&quot;</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">buffer-substring</span><span class="w"> </span><span class="p">(</span><span class="nf">point</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">point-at-eol</span><span class="p">)))</span>
<span class="w">              </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="nv">website</span><span class="w"> </span><span class="p">(</span><span class="nv">string-trim</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="nv">base-path</span><span class="w"> </span><span class="s">&quot;.md&quot;</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;.html&quot;</span><span class="p">)))</span>
<span class="w">           </span><span class="nv">posts</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/often-used-links</span><span class="w"> </span><span class="p">(</span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">arg</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Choose a link and insert it into the buffer in .md format.</span>
<span class="s">This is quite useful, since many people happen to have very</span>
<span class="s">similar problems when, for example, first starting out with</span>
<span class="s">xmonad.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">interactive</span><span class="w"> </span><span class="s">&quot;P&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="p">(</span><span class="nv">-let*</span><span class="w"> </span><span class="p">((</span><span class="nv">links</span>
<span class="w">           </span><span class="p">(</span><span class="nv">-concat</span><span class="w"> </span><span class="o">'</span><span class="p">((</span><span class="s">&quot;tutorial&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;https://xmonad.org/TUTORIAL.html&quot;</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="s">&quot;install&quot;</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="s">&quot;https://xmonad.org/INSTALL.html&quot;</span><span class="p">)</span>
<span class="w">                      </span><span class="p">(</span><span class="s">&quot;xmonad.hs&quot;</span><span class="o">.</span><span class="w"> </span><span class="s">&quot;https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">slot/get-xmonad-modules</span><span class="p">)</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">slot/get-posts</span><span class="p">)))</span>
<span class="w">          </span><span class="p">(</span><span class="nv">choice</span><span class="w"> </span><span class="p">(</span><span class="nf">completing-read</span><span class="w"> </span><span class="s">&quot;Link: &quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="nf">#'car</span><span class="w"> </span><span class="nv">links</span><span class="p">)))</span>
<span class="w">          </span><span class="p">((</span><span class="nv">name</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">link</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">assoc</span><span class="w"> </span><span class="nv">choice</span><span class="w"> </span><span class="nv">links</span><span class="p">)))</span>
<span class="w">    </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="s">&quot;[&quot;</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="s">&quot;]&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="nv">arg</span>
<span class="w">        </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="s">&quot;(&quot;</span><span class="w"> </span><span class="nv">link</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="k">save-excursion</span><span class="w"> </span><span class="p">(</span><span class="nf">insert</span><span class="w"> </span><span class="s">&quot;\n\n[&quot;</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="s">&quot;]: &quot;</span><span class="w"> </span><span class="nv">link</span><span class="p">)))))</span>
</pre></div>

<p></p>
I bind this to <code>C-c l</code> in <code>markdown-mode</code>; it looks like this:
<p></p>
<img class="pure-img" src="../images/emacs-potpourri/markdown-entry.gif">
<h2 id="a-macro-for-repeat-mode">A macro for <code>repeat-mode</code></h2>
<p></p>
I’ve written a macro for Emacs’s <code>repeat-mode</code>, which allows you to
execute repeated commands without having to press the same prefix over
and over again. For example, one can set this up for Org navigation
commands such that <code>C-c C-n n n</code> executes <code>org-next-visible-heading</code>
three times. A great introduction to <code>repeat-mode</code> can be found
<a href="https://karthinks.com/software/it-bears-repeating/">here</a>.
<p></p>
There are <a href="https://tildegit.org/acdw/define-repeat-map.el">lots</a> of <a href="https://github.com/mmarshall540/repeaters">packages</a>
around that define different macros which probably work much better than
the one below. Even <a href="https://github.com/jwiegley/use-package">use-package</a> now sports a <code>:repeat-map</code> keyword
now. However, obviously the one I wrote feels the most natural to <em>me</em>,
so it’s being kept around regardless.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defmacro</span><span class="w"> </span><span class="nv">defrepeatmap</span><span class="w"> </span><span class="p">(</span><span class="nv">sym</span><span class="w"> </span><span class="nv">pairs</span><span class="w"> </span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">docstring</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;A macro for defining </span><span class="ss">`repeat-map'</span><span class="s">s.</span>
<span class="s">Defines a new repeat-map called SYM with the given DOCSTRING.</span>
<span class="s">The keys are derived via the list PAIRS, whose elements are cons</span>
<span class="s">cells of the form (KEY . DEF), where KEY and DEF must fulfill the</span>
<span class="s">same requirements as if given to </span><span class="ss">`define-key'</span><span class="s">.</span>

<span class="s">If the key only consists of a single character; i.e., is already</span>
<span class="s">bound and a repeat map is created afterwards, simply add it to</span>
<span class="s">the repeat-map SYM.  If not, globally bind KEY to DEF and only</span>
<span class="s">insert the last character of DEF into the repeat map SYM.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nb">declare</span><span class="w"> </span><span class="p">(</span><span class="nv">indent</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">debug</span><span class="w"> </span><span class="no">t</span><span class="p">))</span>
<span class="w">  </span><span class="o">`</span><span class="p">(</span><span class="k">progn</span>
<span class="w">     </span><span class="p">(</span><span class="k">defvar</span><span class="w"> </span><span class="o">,</span><span class="nv">sym</span>
<span class="w">       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">kmap</span><span class="w"> </span><span class="p">(</span><span class="nf">make-sparse-keymap</span><span class="p">)))</span>
<span class="w">         </span><span class="p">(</span><span class="nv">--each</span><span class="w"> </span><span class="o">,</span><span class="nv">pairs</span>
<span class="w">           </span><span class="p">(</span><span class="nv">-let</span><span class="w"> </span><span class="p">(((</span><span class="nv">key</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">fun</span><span class="p">)</span><span class="w"> </span><span class="nv">it</span><span class="p">))</span>
<span class="w">             </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">length=</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                 </span><span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">kmap</span><span class="w"> </span><span class="p">(</span><span class="nv">kbd</span><span class="w"> </span><span class="nv">key</span><span class="p">)</span><span class="w"> </span><span class="nv">fun</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="nv">bind-key</span><span class="w"> </span><span class="p">(</span><span class="nv">kbd</span><span class="w"> </span><span class="nv">key</span><span class="p">)</span><span class="w"> </span><span class="nv">fun</span><span class="p">)</span>
<span class="w">               </span><span class="p">(</span><span class="nf">define-key</span><span class="w"> </span><span class="nv">kmap</span><span class="w"> </span><span class="p">(</span><span class="nv">kbd</span><span class="w"> </span><span class="p">(</span><span class="nv">s-right</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">key</span><span class="p">))</span><span class="w"> </span><span class="nv">fun</span><span class="p">))))</span>
<span class="w">         </span><span class="nv">kmap</span><span class="p">)</span>
<span class="w">       </span><span class="o">,</span><span class="nv">docstring</span><span class="p">)</span>
<span class="w">     </span><span class="c1">;; Tell the keys they are in a repeat map.</span>
<span class="w">     </span><span class="p">(</span><span class="nv">--each</span><span class="w"> </span><span class="p">(</span><span class="nf">mapcar</span><span class="w"> </span><span class="ss">'cdr</span><span class="w"> </span><span class="p">(</span><span class="nf">cdr</span><span class="w"> </span><span class="o">,</span><span class="nv">sym</span><span class="p">))</span>
<span class="w">       </span><span class="p">(</span><span class="nf">put</span><span class="w"> </span><span class="nv">it</span><span class="w"> </span><span class="ss">'repeat-map</span><span class="w"> </span><span class="ss">',sym</span><span class="p">))))</span>
</pre></div>

<p></p>
The following would, for example, bind <code>mc/mark-next-like-this-word</code> to
<code>M-s s</code> globally and to <code>s</code> in the created <code>mc-repeat-map</code>. Likewise,
<code>mc/mark-next-word-like-this</code> is bound to <code>.</code> in that map, and so on.
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">defrepeatmap</span><span class="w"> </span><span class="nv">mc-repeat-map</span>
<span class="w">    </span><span class="o">'</span><span class="p">((</span><span class="s">&quot;M-s s&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">mc/mark-next-like-this-word</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;C-M-.&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">mc/mark-next-word-like-this</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;C-M-,&quot;</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">mc/mark-previous-word-like-this</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;C-&gt;&quot;</span><span class="w">   </span><span class="o">.</span><span class="w"> </span><span class="nv">mc/skip-to-next-like-this</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="s">&quot;C-&lt;&quot;</span><span class="w">   </span><span class="o">.</span><span class="w"> </span><span class="nv">mc/skip-to-previous-like-this</span><span class="p">))</span>
<span class="w">    </span><span class="s">&quot;</span><span class="ss">`repeat-mode'</span><span class="s"> keymap to repeat </span><span class="ss">`multiple-cursors'</span><span class="s"> bindings.&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
This may be too implicit for many people, but for me it’s just right—and
that’s sort of the point of all of this, right?

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Understanding Weighted Colimits as Tensor Products of Modules</title>
    <link href="https://tony-zorman.com/posts/weighted-colimits/2022-10-15-weighted-colimits.html" />
    <id>https://tony-zorman.com/posts/weighted-colimits/2022-10-15-weighted-colimits.html</id>
    <published>2022-10-15T00:00:00Z</published>
    <updated>2022-10-15T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-10-15
      
        | <a title="All pages tagged 'maths'." href="/tags/maths.html">maths</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
If you’ve been doing category theory for any amount of time, you’ll
probably have stumbled upon enriched category theory as a way of
expressing categorical ideas internal to some context other than
<strong>Set</strong>. Reading into it, you might have come across these foreign
sounding concepts like weighted (co)limits and wondered what that was
all about—and then got lost for a few days, trying to decipher what
<a href="http://www.tac.mta.ca/tac/reprints/articles/10/tr10abs.html">Kelly</a> is talking about and why symbols resembling tensor
products are suddenly being thrown around. At least that’s what
happened to me.
<p></p>
After scouring the internet for good resources, I found two really
enlightening blog posts: one by <a href="https://golem.ph.utexas.edu/category/2007/02/day_on_rcfts.html#c007723">Todd Trimble</a> and the
other by <a href="https://golem.ph.utexas.edu/category/2007/02/day_on_rcfts.html#c007688">John Baez</a>—and they’re too good not to share.
Plus, people always say that you don’t understand a concept unless you
can explain it to someone else, so here’s my shot at it!
<!--more-->
<p></p>
I will assume familiarity with basic notions of category theory (limits,
colimits, adjunctions, monoidal categories, …), as well as elementary
abstract algebra (in particular, rings and modules). If you’re not
comfortable with these and have a lot of time to kill, I recommend
<a href="https://math.jhu.edu/~eriehl/context.pdf">Category Theory in Context</a> by Emily Riehl for the former and
<a href="https://bookstore.ams.org/gsm-56/">A Course in Algebra</a> by Ernest Vinberg for the latter.
<p></p>
Really, it’s good if you have heard about enriched category theory
before, as this is where weighted colimits tend to naturally crop; also
because I can’t possibly do the topic justice in a single blog post. I
will still try, of course, but be warned. However, weighted colimits
also appear in ordinary category theory, so if you don’t want to touch
the enriched stuff just insert <span class="math inline">\(\mathsf{Set}\)</span> whenever I write
<span class="math inline">\(\mathcal{V}\)</span> below—it will only get easier. Further, most of the <a href="#weighted-colimits">main
part</a> of the text doesn’t use enrichment at all, so
don’t be too alarmed.
<p></p>
First and foremost I must note that—more-so than elsewhere—these are
very much not my own thoughts. I’m just retelling the story in order to
understand it better myself. Sources and resources for everything are
linked <a href="#resources">at the end</a>. The key insights come from the
mentioned blog posts by <a href="https://golem.ph.utexas.edu/category/2007/02/day_on_rcfts.html#c007723">Todd Trimble</a> and <a href="https://golem.ph.utexas.edu/category/2007/02/day_on_rcfts.html#c007688">John
Baez</a>, as well as the accompanying (resulting) <a href="https://ncatlab.org/nlab/show/weighted+colimit">nLab
article</a>.
<h2 id="enriched-category-theory">Enriched category theory</h2>
<p></p>
As I said, we first turn our attention to <em>enriched</em> category theory.
Before diving into the gory details, I will first discuss things a bit
more intuitively. In short, one studies not ordinary categories—whose
hom<em>sets</em> are always sets—but so-called <span class="math inline">\(\mathcal{V}\)</span>-categories, whose
hom-<em>objects</em> are objects in some “environmental” category
<span class="math inline">\(\mathcal{V}\)</span>. This category is what replaces <span class="math inline">\(\mathsf{Set}\)</span>, so it
will usually be assumed to have some <em>very</em> nice properties. For the
purposes of this blog post, I will assume that <span class="math inline">\((\mathcal{V}, \otimes, 1)\)</span> is a (small) complete and cocomplete closed symmetric monoidal
category.<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">This is also sometimes called a <em>cosmos</em>.</span></span>
 If you don’t know what some of these words mean, you can
read that as “it’s an environment in which we can think about category
theory in an effective way”.
<p></p>
In addition, I would also like to fix a <span class="math inline">\(\mathcal{V}\)</span>-category
<span class="math inline">\(\mathcal{C}\)</span> for the rest of this blog post. For the moment, you can
think of this like an ordinary category such that for any two objects
<span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> in <span class="math inline">\(\mathcal{C}\)</span>, we have that <span class="math inline">\(\mathcal{C}(a, b) ≔ \mathrm{Hom}_{\mathcal{C}}(a, b)\)</span> is an object in <span class="math inline">\(\mathcal{V}\)</span>.
Naturally, all the usual axioms of a category—like associativity and
unitality of morphisms—ought to hold in this new setting. As you can
imagine, this makes certain things more complicated. The fact that
<span class="math inline">\(\mathcal{C}(a,b)\)</span> is an object in <span class="math inline">\(\mathcal{V}\)</span> means that it is now a
black box—we can’t peek into it anymore! Writing <span class="math inline">\(f \in \mathcal{C}(a,b)\)</span> is no longer legal, so we somehow have to make do with
not talking about individual morphisms. A little bit more care has to
be taken for the precise definition of an enriched category to make
sense. First, however, I will show you a few examples.
<p></p>
Thankfully—lest the world explodes—categories enriched in <span class="math inline">\(\mathsf{Set}\)</span>
are exactly ordinary categories. Likewise, a lot of categories that
people are interested in and you may be familiar with arise in this way:
2-categories (in the strict sense) are categories enriched over
<span class="math inline">\(\mathsf{Cat}\)</span>, preadditive categories are those enriched over
<span class="math inline">\(\mathsf{Ab}\)</span>, and <span class="math inline">\(k\)</span>-linear categories are ones enriched over
<span class="math inline">\(\mathsf{Vect}_k\)</span>. Further, rings can also be seen as categories.
Namely, they have just a single object <span class="math inline">\(\star\)</span> and
<span class="math inline">\(\mathrm{Hom}(\star,\star)\)</span> forms an abelian group—more on that later.
<p></p>
With these examples in mind, let us explore the technical definition of
a category enriched over <span class="math inline">\(\mathcal{V}\)</span>. Formally, such a <span class="math inline">\(\mathcal{C}\)</span>
consists of:
<ul>
<li>A collection of objects <span class="math inline">\(\mathrm{ob}\, \mathcal{C}\)</span>.</li>
<li>For <span class="math inline">\(x, y \in \mathcal{C}\)</span>, a hom-object
<span class="math inline">\(\mathcal{C}(x, y) \in \mathcal{V}\)</span>.</li>
<li>For <span class="math inline">\(x, y, z \in \mathcal{C}\)</span>, a composition map in <span class="math inline">\(\mathcal{V}\)</span>:
<span class="math display">\[
  \circ_{x, y, z} \colon \mathcal{C}(y, z) \times \mathcal{C}(x, y)
                  \longrightarrow \mathcal{C}(x, z).
\]</span></li>
<li>For <span class="math inline">\(x \in \mathcal{C}\)</span> an identities map
<span class="math inline">\(e_x \colon 1 \longrightarrow \mathcal{C}(x,x)\)</span>.</li>
</ul>
<p></p>
Further, this data has to satisfy appropriate associativity and
unitality conditions:
<p></p>
<img class="pure-img" src="./enriched.png">
<p></p>
In the above diagrams, <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\lambda\)</span>, and <span class="math inline">\(\rho\)</span> respectively
denote the associativity, left, and right unitality constraints of
<span class="math inline">\(\mathcal{V}\)</span>.
<p></p>
If these diagrams remind you of a <a href="https://ncatlab.org/nlab/show/monoidal+category">monoidal
category</a>, they absolutely should! Much like
you can think of ordinary categories as multi-object monoids, a decent
mental model for <span class="math inline">\(\mathcal{V}\)</span>-categories is to think of them as
multi-object monoidal categories.
<h3 id="functors-and-natural-transformations">Functors and natural transformations</h3>
<p></p>
We furthermore need analogues for functors and natural
transformations—they now also come with a <span class="math inline">\(\mathcal{V}\)</span>- prefix. The
functor laws get a bit more complicated, as we can’t simply say that
<span class="math inline">\(F(f \circ g) = Ff \circ Fg\)</span>, for some arrows <span class="math inline">\(f\)</span> and <span class="math inline">\(g\)</span>, and need to
draw commutative diagrams instead (remember that we can’t talk about
individual arrows anymore). However, most of the intuition you already
have about functors and natural transformations should carry over just
fine. I will leave the technical definitions of enriched functors and
natural transformations as exercises to the reader—they are relatively
straightforward to write down and not all that important for what
follows.
<p></p>
The upshot of all of this is that, in order to do enriched category
theory, we not only need analogues for functors and natural
transformations, but also for all the other basic notions of ordinary
category theory. Since limits and colimits are among the most important
constructions, people naturally started to think about how one could
express them in the enriched language—this is precisely what lead to the
development of weighted colimits!
<p></p>
One interesting thing I want to highlight about enriched functors is the
induced arrow on morphisms that an <span class="math inline">\(F \colon \mathcal{C} \longrightarrow \mathcal{V}\)</span> always comes with. Namely, <span class="math inline">\(\mathcal{C}(a, b) \longrightarrow \mathcal{V}(F a, F b)\)</span>. Because <span class="math inline">\(\mathcal{V}\)</span> is
symmetric monoidal, we can use the tensor-hom adjunction and rewrite the
above to look more like an action:
<p></p>
<span class="math display">\[
  \mathcal{C}(a, b) \otimes F a \longrightarrow F b.
\]</span>
<p></p>
Likewise, a <span class="math inline">\(\mathcal{V}\)</span>-functor <span class="math inline">\(F \colon \mathcal{C}^{\mathrm{op}} \longrightarrow \mathcal{V}\)</span> comes equipped with an “action” from the
other side:
<p></p>
<span class="math display">\[
  F b \otimes \mathcal{C}(a, b) \longrightarrow F a.
\]</span>
<h2 id="copowers">Copowers</h2>
<p></p>
Before we get to the fun stuff, we have to talk about one more important
technical detail: copowers. The basic idea is that in any ordinary
monoidal category <span class="math inline">\((\mathcal{A}, \otimes_{\mathcal{A}}, 1_{\mathcal{A}})\)</span>, we have the tensor-hom adjunction (also called
<em>currying</em>) <span class="math inline">\({-} \otimes b \dashv [b, {-}]\)</span>. In particular, this means
that
<p></p>
<span class="math display">\[
  \mathcal{A}(a \otimes_{\mathcal{A}} b, c) \cong \mathcal{A}(a, [b, c]),
  \qquad \text{for } a, b, c \in \mathcal{A}.
\]</span>
<p></p>
If we’re in an enriched setting, we want to somehow “switch out” the
tensor product of the monoidal category with some action, say <span class="math inline">\(\cdot \colon \mathcal{C} \times \mathcal{V} \longrightarrow \mathcal{C}\)</span>,
while retaining this nice property. As such, the <em>copower</em> of <span class="math inline">\(c \in \mathcal{C}\)</span> <em>by a</em> <span class="math inline">\(v \in \mathcal{V}\)</span> is an object <span class="math inline">\(c \cdot v \in \mathcal{C}\)</span>, such that for all <span class="math inline">\(b \in \mathcal{C}\)</span>, there is a natural
isomorphism
<p></p>
<span class="math display">\[
  \mathcal{C}(c \cdot v, b) \cong \mathcal{V}(v, \mathcal{C}(c, b)).
\]</span>
<p></p>
Above I have slightly abused notation; <span class="math inline">\(\mathcal{V}({-}, {-})\)</span> now
denotes the <em>internal</em> hom of <span class="math inline">\(\mathcal{V}\)</span>, instead of the external
one. If <span class="math inline">\(\mathcal{V}\)</span> is clear from the context, one also often writes
<span class="math inline">\([{-},{-}]\)</span> here. Also do remember that <span class="math inline">\(\mathcal{C}(a,b)\)</span> is an object
in <span class="math inline">\(\mathcal{V}\)</span> now!
<p></p>
The best thing about copowers is their existence when it comes to
<span class="math inline">\(\mathsf{Set}\)</span> and ordinary categories. If <span class="math inline">\(\mathcal{A}\)</span> has all
coproducts, there is a canonical copower <span class="math inline">\(\cdot \colon \mathsf{Set} \times \mathcal{A} \longrightarrow \mathcal{A}\)</span>.<!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">If the category <span class="math inline">\(\mathcal{A}\)</span> is locally small. I will ignore
those kinds of technicalities for the purposes of this post.</span></span>
 For all <span class="math inline">\(X \in \mathsf{Set}\)</span> and <span class="math inline">\(a \in \mathcal{A}\)</span>, it is given by
<p></p>
<span class="math display">\[
  X \cdot a ≔     \coprod_{x \in X} 1_{\mathcal{A}} \otimes_{\mathcal{A}} a
            \cong \coprod_{x \in X} a.
\]</span>
<p></p>
The fact that this is a copower follows from
<p></p>
<span class="math display">\[
  \mathcal{A}(X \cdot a, b) = \mathcal{A}(\coprod_{x \in X} a, b)
  \cong \prod_{x \in X} \mathcal{A}(a, b) \cong \mathsf{Set}(X, \mathcal{A}(a, b)),
\]</span>
<p></p>
for all <span class="math inline">\(b \in \mathcal{A}\)</span>. Because of the closeness to the tensor
product, people sometimes call copowers “tensors” and write them with
the same symbol as they write the tensor product.
<h2 id="weighted-colimits">Weighted colimits</h2>
<p></p>
Onto the main dish. The key idea is to reframe an ordinary colimit in
terms of “looking like a monoidal product”. The weighted colimit then
becomes something akin to the tensor product over a k-algebra <span class="math inline">\(R\)</span>. We
like rings and modules, so let’s explore this further.
<p></p>
To recap, when looking at bimodules <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> over some <span class="math inline">\(k\)</span>-algebra
(ring) <span class="math inline">\(R\)</span> we can define the tensor product of <span class="math inline">\(A\)</span> and <span class="math inline">\(B\)</span> over <span class="math inline">\(R\)</span>, in
symbols <span class="math inline">\(A \otimes_R B\)</span>, as the coequaliser
<p></p>
<span class="math display">\[
  A \otimes_R B
  ≔ \mathrm{coeq} \left(
      A \otimes R \otimes B \rightrightarrows A \otimes B
    \right),
\]</span>
<p></p>
where the two parallel arrows are induced by the left and right actions
<span class="math inline">\(\rhd \colon A \otimes R \longrightarrow A\)</span> and <span class="math inline">\(\lhd \colon R \otimes B \longrightarrow B\)</span>, respectively.
<p></p>
For ease of notation, I will often write coequalisers like the above one
as
<p></p>
<span class="math display">\[
  A \otimes R \otimes B \rightrightarrows A \otimes   B
                        \longrightarrow   A \otimes_R B.
                                                            \tag{1}
\]</span>
<p></p>
Categorifying this notion, the ring <span class="math inline">\(R\)</span> can be seen as a one-object
category enriched over <span class="math inline">\(\mathsf{Ab}\)</span> with object <span class="math inline">\(1 \in R\)</span>. The
multiplication is recovered as function composition in <span class="math inline">\(R(1, 1)\)</span> and the
addition is given by the abelian structure. A right <span class="math inline">\(R\)</span>-module <span class="math inline">\(A\)</span> is
then an enriched functor <span class="math inline">\(A \colon R^{\mathrm{op}} \longrightarrow \mathsf{Ab}\)</span> and a left R-module is an enriched functor <span class="math inline">\(B \colon R \longrightarrow \mathsf{Ab}\)</span>. Inserting the definition discussed above,
we have that <span class="math inline">\(A\)</span> consists of a single object <span class="math inline">\(A1\)</span> and a single map <span class="math inline">\(A1 \otimes R(1, 1) \longrightarrow A1\)</span>. Likewise, we obtain <span class="math inline">\(B1\)</span> and
<span class="math inline">\(R(1,1) \otimes B1 \longrightarrow B1\)</span> in <span class="math inline">\(\mathcal{V}\)</span>. Thus, we have
induced arrows
<p></p>
<span class="math display">\[
    A1 \otimes R(1,1) \otimes B1 \rightrightarrows A1 \otimes B1.
\]</span>
<p></p>
Let us forget about enrichment for a while and just study ordinary
categories now. The second observation we need is the well-known fact
that any colimit can be represented as a coequaliser. Suppose
<span class="math inline">\(\mathcal{D}\)</span> to be a (cocomplete) category . Given a functor <span class="math inline">\(F \colon \mathcal{J} \longrightarrow \mathcal{D}\)</span> we can express its colimit as
<p></p>
<span class="math display">\[
  \coprod_{a, b \in \mathcal{J}}
            \coprod_{f \in \mathcal{J}(a, b)} F a
  \rightrightarrows \coprod_{b \in \mathcal{J}} F b
  \longrightarrow   \mathrm{colim}_\mathcal{J} F.
\]</span>
<p></p>
Note that we can use what we learned about (<span class="math inline">\(\mathsf{Set}\)</span>-valued)
copowers above and write <span class="math inline">\(\coprod_{f \in \mathcal{J}(a, b)} F a\)</span> as
<span class="math inline">\(\mathcal{J}(a, b) \cdot F a\)</span>, or even <span class="math inline">\(\mathcal{J}(a, b) \times F a\)</span>,
as <span class="math inline">\(\mathcal{J}(a,b)\)</span> is a set in this case. Behold:
<p></p>
<span class="math display">\[
  \coprod_{a, b \in \mathcal{J}} \mathcal{J}(a,b) \times F a
  \rightrightarrows \coprod_{b \in \mathcal{J}} F b
  \longrightarrow \mathrm{colim}_\mathcal{J} F.
                                                                \tag{2}
\]</span>
<p></p>
What’s left is to define the two parallel arrows.<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">I mostly follow Trimble and the nLab here. A more explicit
description (in the case of limits, but it should be easy enough
to dualise) is given, for example, in <a href="https://math.jhu.edu/~eriehl/context.pdf">Category Theory in
Context</a>, Theorem 3.2.13.</span></span>
<ol type="1">
<li><p></p>

One arrow is induced by the “projection” <span class="math inline">\(\pi_2 \colon \mathcal{J}(a, b) \times F a \longrightarrow F a\)</span>. Note that
<span class="math inline">\(\mathcal{J}(a, b) \times F a\)</span> is really a copower and so the
existence of such an arrow is not immediately clear. We have a
functor <span class="math inline">\({-} \times F j \colon \mathsf{Set} \longrightarrow \mathcal{C}\)</span> and so <span class="math inline">\(\pi_2\)</span> is actually the application of the
unique map<!--
--><span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">The one-element set <span class="math inline">\(\{\star\}\)</span> is the terminal object in
<span class="math inline">\(\mathsf{Set}\)</span>, hence by definition there is exactly one arrow from
any other set to it.</span></span>

<span class="math inline">\(! \colon \mathcal{J}(a, b) \longrightarrow \{\star\}\)</span>
to that functor; i.e.,
<p></p>

<span class="math display">\[
! \times F a \colon \mathcal{J}(a,b) \times F a \longrightarrow \{\star\} \times F a \cong F a.
\]</span></li>
<li><p></p>

The other arrow is induced by a collection of actions of
<span class="math inline">\(\mathcal{J}\)</span> on <span class="math inline">\(F\)</span>, indexed by arrows <span class="math inline">\(f \colon a \longrightarrow b\)</span> in <span class="math inline">\(\mathcal{J}\)</span>; i.e.,
<p></p>

<span class="math display">\[
(\mathcal{J}(a,b) \times F a \longrightarrow F b)
= \left( \coprod_{f \in \mathcal{J}(a,b)} F a \longrightarrow F b \right)
= \langle Ff \colon Fa \longrightarrow F b \rangle_{f \in \mathcal{J}(a,b)}.
\]</span></li>
</ol>
<p></p>
So that’s the story with expressing colimits as coequalisers. What’s
next is that we need to completely reframe this in terms of actions.
For the second arrow we are already done: <span class="math inline">\(F\)</span> can be seen as a left
<span class="math inline">\(\mathcal{J}\)</span>-module.
<p></p>
Using the symmetry of the Cartesian product <span class="math inline">\(\times\)</span> of sets, the arrow
<span class="math inline">\(\mathcal{J}(a, b) \longrightarrow \{\star\}\)</span> can be reinterpreted as
the components of a right action of <span class="math inline">\(\mathcal{J}\)</span> on the terminal
functor <span class="math inline">\(\mathbb{T} \colon \mathcal{J} \longrightarrow \mathsf{Set}\)</span>
that sends every object to the one-element set <span class="math inline">\(\{\star\}\)</span>:
<p></p>
<span class="math display">\[
  (\mathbb{T}b \times \mathcal{J}(a,b) \longrightarrow \mathbb{T}a)
  =     (\{\star \} \times \mathcal{J}(a,b) \longrightarrow \{\star\})
  \cong (\mathcal{J}(a,b) \longrightarrow \{\star\}).
\]</span>
<p></p>
Putting these two observations together, we really have two induced
arrows with type signature
<p></p>
<span class="math display">\[
  \mathbb{T} b \times \mathcal{J}(a, b) \times F a \longrightarrow \mathbb{T} a \times F a.
\]</span>
<p></p>
Inserting these into Equation <span class="math inline">\(2\)</span>, this yields
<p></p>
<span class="math display">\[
  \coprod_{a, b \in \mathcal{J}} \mathcal{J}(a,b) \times F a
    \cong             \coprod_{a, b \in \mathcal{J}} \mathbb{T} b \times \mathcal{J}(a, b) \times F a
    \rightrightarrows \coprod_{a \in \mathcal{J}} \mathbb{T} a \times F a
    \cong             \coprod_{a \in \mathcal{J}} F a.
\]</span>
<p></p>
This is exactly the way the tensor product of bimodules is defined in
Equation <span class="math inline">\(1\)</span>, hence it is tempting to write the resulting coequaliser as
<span class="math inline">\(1 \otimes_{\mathcal{J}} F\)</span>. As such, a colimit of a functor <span class="math inline">\(F\)</span> over
<span class="math inline">\(\mathcal{J}\)</span> can be seen as a tensor product of functors with the
terminal functor. Now, the terminal functor is not very interesting;
what if we replace it with something more complicated? Well, that’s
exactly the point where weighted colimits come into play! Using a
<em>weight</em> <span class="math inline">\(W\)</span> instead of <span class="math inline">\(\mathbb{T}\)</span>, we would end up with something
like
<p></p>
<span class="math display">\[
  \coprod_{a, b \in \mathcal{J}} W b \times \mathcal{J}(a, b) \times F a \rightrightarrows \coprod_{a \in \mathcal{J}} W a \times F a \longrightarrow W \otimes_{\mathcal{J}} F.
\]</span>
<p></p>
Because this looks like a tensor product—and it’s universal, due to it
being a colimit—it should support some sort of currying operation: given
an arrow <span class="math inline">\(W \otimes_{\mathcal{J}} F \longrightarrow c\)</span>, for some object
<span class="math inline">\(c \in \mathcal{C}\)</span>, we should be able to obtain an arrow <span class="math inline">\(W \implies \mathcal{C}(F, c)\)</span>. Now’s your time to guess what exactly a weighted
colimit will be!
<h3 id="definition">Definition</h3>
<p></p>
Still in the non-enriched setting, let me now give you the formal
definition of a weighted colimit. Suppose <span class="math inline">\(\mathcal{J}\)</span> to be a small
category. Let <span class="math inline">\(W \colon \mathcal{J}^{\mathrm{op}} \longrightarrow \mathsf{Set}\)</span> be a presheaf—the <em>weight</em>—and suppose we have a functor
<span class="math inline">\(F \colon \mathcal{J} \longrightarrow \mathcal{A}\)</span>. The <em><span class="math inline">\(W\)</span>-weighted
colimit of <span class="math inline">\(F\)</span></em> comprises an object <span class="math inline">\(W \otimes_{\mathcal{J}} F \in \mathcal{A}\)</span>, and a natural (in <span class="math inline">\(a \in \mathcal{A}\)</span>) isomorphism
<p></p>
<span class="math display">\[
  \mathcal{A}(W \otimes_{\mathcal{J}} F, a)
  \cong
  [\mathcal{J}^{\mathrm{op}}, \mathsf{Set}] (W, \mathcal{A}(F, a)).
\]</span>
<p></p>
Note that, by the <a href="https://ncatlab.org/nlab/show/Yoneda+lemma">Yoneda lemma</a>, the above isomorphism is
uniquely determined by a natural transformation <span class="math inline">\(W \implies \mathcal{A}(F, W \otimes_{\mathcal{J}} F)\)</span>. As promised, this is
exactly the representation we arrived at above.
<p></p>
A pair of an object <span class="math inline">\(c \in \mathcal{A}\)</span> and a natural transformation <span class="math inline">\(W \implies \mathcal{A}(F, c)\)</span> on their own; i.e., without the universal
property, is what one would normally call a <em><span class="math inline">\(W\)</span>-weighted cocone</em>.
<h3 id="enriched-weighted-colimits">Enriched weighted colimits</h3>
<p></p>
The enriched definition is now exactly the same! If <span class="math inline">\(\mathcal{J}\)</span> is a
small <span class="math inline">\(\mathcal{V}\)</span>-category and we have <span class="math inline">\(\mathcal{V}\)</span>-functors <span class="math inline">\(F \colon \mathcal{J} \longrightarrow \mathcal{C}\)</span> and <span class="math inline">\(W \colon \mathcal{J}^{\mathrm{op}} \longrightarrow \mathcal{V}\)</span>, then we can
define the <em><span class="math inline">\(W\)</span>-weighted colimit of <span class="math inline">\(F\)</span></em> as an object <span class="math inline">\(W \otimes_{\mathcal{J}} F \in \mathcal{C}\)</span>, and a <span class="math inline">\(\mathcal{V}\)</span>-natural
(in <span class="math inline">\(c \in \mathcal{C}\)</span>) isomorphism
<p></p>
<span class="math display">\[
  \mathcal{C}(W \otimes_{\mathcal{J}} F, c)
  \cong
  [\mathcal{J}^{\mathrm{op}}, \mathcal{V}] (W {-}, \mathcal{C}(F {-}, c)).
\]</span>
<p></p>
This is the power of this definition—it extends in a straightforward way
to the enriched setting. This may now be used to great effect: in case
you know what this means, among other things weighted colimits can be
used to define the right notion of enriched coend.
<h3 id="examples">Examples</h3>
<p></p>
It’s probably about time for some examples. For the first two, let us
focus on cocones only; this is perhaps a little easier to understand
than also throwing the universal property in there. I learned these
from Richard Garner during <a href="https://conferences.leeds.ac.uk/bcqt2022/">BCQT 2022</a>.
<ol type="1">
<li><p></p>

Suppose our diagram category is the category with two objects and one
non-trivial morphism; i.e., <span class="math inline">\(\mathcal{J} ≔ \{ \varphi \colon a \longrightarrow b \}\)</span>. Further, assume that the weight <span class="math inline">\(W\)</span> picks
out<!--
--><span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">By sending <span class="math inline">\(a\)</span> to <span class="math inline">\(\{0, 1\}\)</span>, <span class="math inline">\(b\)</span> to <span class="math inline">\(\{ 1 \}\)</span>, and <span class="math inline">\(\varphi\)</span> to
<span class="math inline">\(\{0, 1\} \longrightarrow \{1\}\)</span>.</span></span>
 the unique arrow <span class="math inline">\(\{ 0, 1 \} \longrightarrow \{ 1 \}\)</span> in
<span class="math inline">\(\mathsf{Set}\)</span>. The functor <span class="math inline">\(F \colon \mathcal{J} \longrightarrow \mathcal{C}\)</span> we would like to look at sends <span class="math inline">\(a, b \in \mathcal{J}\)</span> to
<span class="math inline">\(x, y \in \mathcal{C}\)</span> and <span class="math inline">\(\varphi\)</span> to <span class="math inline">\(\theta \colon x \longrightarrow y\)</span>.
<p></p>

Again by the Yoneda lemma we have that a cocone is given by a natural
transformation <span class="math inline">\(W \implies \mathcal{C}(F, c)\)</span>. In this restricted
setting, an arrow <span class="math inline">\(Wa \longrightarrow \mathcal{A}(Fb, c)\)</span> just picks
out two morphisms. Thus, the whole thing amounts to the
commutativity of the following diagram:
<p></p>

<img class="pure-img" src="./example-1.png">
<p></p>

In more plain language, we have a commutative diagram of the form
<p></p>

<span class="math display">\[
  (x \xrightarrow{\;\;\theta\;\;} y \xrightarrow{\;\;g\;\;} c)
  = (x \xrightarrow{\;\;\theta\;\;} y \xrightarrow{\;\;f\;\;} c),
\]</span></li>
<li><p></p>

A slightly more complicated example is the following. Assume again
that <span class="math inline">\(\mathcal{J} = \{ \varphi \colon a \longrightarrow b \}\)</span> as
above, only this time don’t work over <span class="math inline">\(\mathsf{Set}\)</span> but over
<span class="math inline">\(\mathsf{Cat}\)</span>. This means that the weight <span class="math inline">\(W\)</span> is now a functor from
<span class="math inline">\(\mathcal{A}^{\mathrm{op}}\)</span> to <span class="math inline">\(\mathsf{Cat}\)</span>. Suppose it picks out
the arrow
<p></p>

<span class="math display">\[
\{ 0 \;\; 1 \} \hookrightarrow \{ 0 \cong 1 \},
\]</span>
<p></p>

where these are understood to be categories. Now, a weighted cocone
becomes something 2-categorical. We still pick out arrows <span class="math inline">\(f\)</span> and
<span class="math inline">\(g\)</span>, but since the category we are looking at is not the terminal
one, but contains an isomorphism, the commutative diagram also
becomes more complicated. Namely, we required the commutativity of
<p></p>

<img class="pure-img" src="./example-2.png">
<p></p>

Instead of the requiring <span class="math inline">\(\theta \circ g\)</span> to <em>equal</em> <span class="math inline">\(\theta \circ f\)</span>, we now only require the existence of an invertible 2-cell that
mediates between the two.</li>
<li><p></p>

A subcategory <span class="math inline">\(\mathcal{D}\)</span> of <span class="math inline">\(\mathcal{E}\)</span> is said to be <em>dense</em> in
<span class="math inline">\(\mathcal{E}\)</span> if we can, in some sense, approximate the objects of
<span class="math inline">\(\mathcal{E}\)</span> well enough with only objects in <span class="math inline">\(\mathcal{D}\)</span> (think
of the density of <span class="math inline">\(\mathbb{Q}\)</span> inside <span class="math inline">\(\mathbb{R}\)</span>). Dense
categories are nice because they often tell us a lot about their
super categories and are sometimes easier to reason about. For
example, the category of finite-dimensional (left-)comodules of any
(possibly infinite-dimensional) Hopf algebra is dense inside the
category of all comodules, which makes them much easier to work with
than modules.
<p></p>

Formally, <span class="math inline">\(\mathcal{D}\)</span> is dense in <span class="math inline">\(\mathcal{E}\)</span> if the restricted
Yoneda embedding along the inclusion functor <span class="math inline">\(\iota \colon \mathcal{D} \hookrightarrow \mathcal{E}\)</span>
<p></p>

<span class="math display">\[
  \mathcal{E} \longrightarrow [\mathcal{E}^{\mathrm{op}}, \mathsf{Set}]
    \xrightarrow{\;[\iota, \mathsf{Set}]\;} [\mathcal{D}^{\mathrm{op}}, \mathsf{Set}]
\]</span>
<p></p>

is still fully faithful. Another way of saying this is that every
object <span class="math inline">\(e \in \mathcal{E}\)</span> is the <span class="math inline">\(\mathcal{E}(\iota, e)\)</span>-weighted
colimit of <span class="math inline">\(\iota\)</span>. Indeed, the isomorphism we have for a weighted
colimit specialised to our situation looks like
<p></p>

<span class="math display">\[
 \mathcal{E}(e, a) \cong [\mathcal{D}^{\mathrm{op}}, \mathsf{Set}] (\mathcal{E}(\iota, e), \mathcal{E}(\iota, a)),
\]</span>
<p></p>

for all <span class="math inline">\(a \in \mathcal{E}\)</span>. This is exactly what it means for the
above arrow to be fully faithful.</li>
</ol>
<p></p>
<em>Exercise</em>: Try to find a weight such that one recovers a normal,
unweighted, cocone.
<p></p>
<em>Exercise</em>: As you can imagine 1. and 2. can be used to produce all
kinds of relations between <span class="math inline">\(f\)</span> and <span class="math inline">\(g\)</span>. As such, prove the following
statements:
<ul>
<li><p></p>

A variant of 1.: in the case of the weight being <span class="math inline">\(\{0, 1\} \xrightarrow{\;\;\mathrm{id}\;\;} \{0, 1\}\)</span>, we obtain a
not-necessarily-commutative diagram.</li>
<li><p></p>

A variant of 2.: in the case that the weight is <span class="math inline">\(\{ 0 \} \hookrightarrow \{ 0 \longrightarrow 1 \}\)</span> (i.e., we only have an
arrow between 0 and 1 and not necessarily an isomorphism), we get an
ordinary (non-invertible) 2-cell as the weighted cocone.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p></p>
And that’s it! I’ve found this intuition very helpful in trying to wrap
my head around these concepts—hopefully other people will too. As a
parting gift, I leave you with some more things to think about.
<p></p>
First, one of the most important examples of weighted colimits—and
coends, of course—is the <a href="https://ncatlab.org/nlab/show/tensor+product+of+functors">tensor product of
functors</a>. If you ever wanted to be a
<a href="https://ncatlab.org/nlab/show/co-Yoneda+lemma">ninja</a>, now is the time! It’s a fun operation to think
about and play around with, and I would invite you to do just that.
<p></p>
Lastly, the category of weights <span class="math inline">\([\mathcal{J}^{\mathrm{op}}, \mathcal{V}]\)</span> is actually very special: it is the free cocompletion of
<span class="math inline">\(\mathcal{J}\)</span>. Every functor <span class="math inline">\(G \colon \mathcal{J} \longrightarrow \mathcal{A}\)</span> extends uniquely (up to unique isomorphism) to a
cocontinuous functor <span class="math inline">\([\mathcal{J}^{\mathrm{op}}, \mathcal{V}]\)</span> to
<span class="math inline">\(\mathcal{A}\)</span> by the assignment <span class="math inline">\(W \mapsto W \otimes_{\mathcal{J}} G\)</span>
(note the tensor product of functors!).
<h2 id="resources">(Re)sources</h2>
<ul>
<li><p></p>

Monoidal Category Theory:
<ul>
<li><p></p>


Saunders Mac Lane: “Natural associativity and commutativity”.
In: Rice Univ. Stud. 49.4 (1963), pp. 28–46. issn: 0035-4996.</li>
<li><p></p>


Pavel Etingof, Shlomo Gelaki, Dmitri Nikshych, and Victor Ostrik:
“Tensor categories”. In: Vol. 205. Mathematical Surveys and
Monographs. American Mathematical Society, Providence, RI, 2015,
pp. xvi+343.</li>
<li><p></p>


<a href="https://ncatlab.org/nlab/show/monoidal+category">nLab: monoidal category</a></li>
</ul></li>
<li><p></p>

Enriched Category Theory:
<ul>
<li><p></p>


Max Kelly: “Basic concepts of enriched category theory”. In: London
Math. Soc. Lec. Note Series 64, Cambridge Univ. Press 1982, 245
pp. (ISBN:9780521287029).
<p></p>


Republished as: Reprints in Theory and Applications of Categories,
No. 10 (2005) pp. 1-136 (<a href="http://www.tac.mta.ca/tac/reprints/articles/10/tr10abs.html">link</a>)</li>
<li><p></p>


<a href="https://ncatlab.org/nlab/show/enriched+category">nLab: enriched category</a></li>
</ul></li>
<li><p></p>

Copowers:
<ul>
<li><a href="https://ncatlab.org/nlab/show/copower">nlab: copower</a></li>
</ul></li>
<li><p></p>

Weighted Colimits:
<ul>
<li><p></p>


<a href="https://golem.ph.utexas.edu/category/2007/02/day_on_rcfts.html#c007723">Todd Trimble on the n-Category Café</a></li>
<li><p></p>


<a href="https://golem.ph.utexas.edu/category/2007/02/day_on_rcfts.html#c007688">John Baez on the n-Category Café</a></li>
<li><p></p>


<a href="https://ncatlab.org/nlab/show/weighted+colimit">nLab: weighted colimit</a></li>
<li><p></p>


Richard Garner: Bicategories; lecture series at <a href="https://conferences.leeds.ac.uk/bcqt2022/">BCQT 2022, Leeds</a>.</li>
<li><p></p>


Emily Riehl: “Weighted Limits and Colimits”; <a href="https://math.jhu.edu/~eriehl/weighted.pdf">lecture notes</a>.</li>
</ul></li>
</ul>

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>XMonad Module Showcase: X.A.TopicSpace</title>
    <link href="https://tony-zorman.com/posts/topic-space/2022-09-11-topic-spaces.html" />
    <id>https://tony-zorman.com/posts/topic-space/2022-09-11-topic-spaces.html</id>
    <published>2022-09-11T00:00:00Z</published>
    <updated>2022-09-11T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-09-11
      
        | <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
One of my favourite—and most used—modules is XMonad.Actions.TopicSpace.
However, it seems relatively unknown among the general <span class="small-caps">xm</span>onad community.
I fear this is due to the fact that the module is quite old and formerly
had a rather high barrier to entry. Despite having been given shiny
<a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Actions-TopicSpace.html">new documentation</a>, lots of people probably did not bother
revisiting it and thus still don’t really understand why they might be
interested in using topics instead of workspaces. Time to change that!
<!--more-->
<h2 id="introduction">Introduction</h2>
<p></p>
First, this post is not to be seen as a tutorial on X.A.TopicSpace, but
much rather as a showcase of how its functionality could be used day to
day. If you like what you see, perhaps check out the
<a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Actions-TopicSpace.html">docs</a> and give it a spin yourself! I have already written
an introduction to the module in the post about my <a href="../phd-workflow/2022-05-01-my-phd-workflow.html">research workflow</a>:
<blockquote>
<p></p>
<span class="small-caps">xm</span>onad has a module called TopicSpace, which upgrades the X11
workspace—virtual desktop—concept to so-called topics. These are
workspaces with a “theme” associated to them; for example, I have a
topic for every project that I’m currently working on. This results
in a clean separation of concerns. Plus, I always know where my
windows are!
<p></p>
Every topic has a directory and a “startup hook”, firing when the
topic is switched to and empty, associated to it. While most
convenient for programming related tasks—e.g., spawn <code>ghcid</code> in the
relevant directory or automatically build and open this website—it’s
also quite convenient for mathematical projects.
<p></p>
I have set up special keybindings to bring up an Emacs session in the
topic directory, or spawn a terminal there. Switching to topics is
done fuzzily via the <span class="small-caps">xm</span>onad prompt, which means I only have to type a
few characters to get to my destination. This makes it feasible to
have 30 topics, instead of the usual 9 or so, in the first place. As
a result, it’s rather fast to go from thinking about a certain problem
to working on it.
</blockquote>
<p></p>
At a glance, this probably does not sound very impressive—so one can
have a directory and some function associated to a workspace (hereafter
also called “topic”), big deal. However, we will see that with a bit of
creativity this can be used to great effect.
<h2 id="examples">Examples</h2>
<h3 id="basic-topics">Basic topics</h3>
<p></p>
The most obvious application of all of this is to have workspaces that
do one and only one thing. For example, I have a topic dedicated to
connecting to a VPN, should the need arise. Naturally, I automatically
want to execute <code>openvpn</code> and pick a random server whenever I happen to
enter that workspace and it’s empty (i.e., <code>openvpn</code> is not already
running).
<p></p>
More such use cases include having a topic dedicated to my RSS feed
reader, instant messaging, or IRC. Since I only show workspaces with
windows on them in xmobar, I can just glance at my status bar to find
out whether I currently have, for example, IRC open. No additional
program for checking the status of things necessary! Obviously, this
<em>modus operandi</em> takes a bit of discipline to uphold over the course of
the day, but I find that such a separation of concerns greatly reduces
mental load regarding what’s currently happening on my computer.
Definitely worth it.
<p></p>
In terms of code, this—as well as the following examples—heavily use the
<a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-Run.html#g:EDSL">new interface</a> to XMonad.Util.Run, which allows one to
spawn processes in a declarative and compositional way; I’ve <a href="../2022-05-25-calling-emacs-from-xmonad.html">written
about this</a> in another post. For example, my RSS topic is
specified thusly:
<div class="highlight"><pre><span></span><span class="c1">-- import XMonad.Actions.TopicSpace (inHome)</span>
<span class="c1">-- import XMonad.Util.Run</span>

<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">inHome</span><span class="w"> </span><span class="s">&quot;7:RSS&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEditor</span>
<span class="w">                        </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setFrameName</span><span class="w"> </span><span class="s">&quot;elfeed&quot;</span>
<span class="w">                        </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="p">(</span><span class="n">elispFun</span><span class="w"> </span><span class="s">&quot;elfeed&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
Here, <code>inHome</code> is a little helper function that takes a topic name and
an action, and creates a new topic with <code>$HOME</code> as its associated
directory.
<p></p>
You can find all of my topics (and there are a lot of them)
<a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs#L219-L265">here</a>.
<h3 id="spawning-everything-in-the-topic-directory">Spawning <em>everything</em> in the topic directory</h3>
<p></p>
More generally, programming projects in the same language almost always
require me to open the same set of standard tools, so it’s extremely
convenient to directly spawn them upon first visit. This allows for
very little friction before starting to work on whatever I wanted to
work on.
<p></p>
For example, I want to open Emacs and <a href="https://github.com/ndmitchell/ghcid">ghcid</a> in every Haskell project
of mine—so why not automate this? Using what X.U.Run gives us, we can
quickly throw together a function that executes the given instruction
inside of a terminal:
<div class="highlight"><pre><span></span><span class="c1">-- import XMonad.Actions.TopicSpace (currentTopicDir)</span>
<span class="c1">-- 'topicConfig' is my personal topic configuration.</span>

<span class="c1">-- | Execute a program in the topic directory (inside a terminal).</span>
<span class="nf">executeInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">executeInTopic</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="p">(</span><span class="n">termInDir</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span><span class="p">)</span>
<span class="w">                      </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="n">p</span>
</pre></div>

<p></p>
Similar functions can be created for spawning the terminal and editor:
<div class="highlight"><pre><span></span><span class="c1">-- Whatever you're looking for, it's probably in X.A.TopicSpace</span>
<span class="c1">-- or X.U.Run.</span>

<span class="c1">-- | Spawn terminal in topic directory.</span>
<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">termInDir</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>

<span class="c1">-- | Spawn editor in the current topic directory.</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>
</pre></div>

<p></p>
Check the documentation of <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-Run.html#g:EDSL">XMonad.Util.Run</a> to see how <code>inEditor</code> and
<code>termInDir</code> are defined and may be customised.
<p></p>
In my mathematical and other work-adjacent projects I keep it pretty
simple; an editor there is mostly sufficient.
<p></p>
<img class="pure-img" src="../phd-workflow/topics.gif">
<p></p>
We can also get a little bit more fancy. Since the topic action is just
a general <code>X</code> action, we can really do anything we want in there. In
addition to spawning programs, all of my Haskell projects should default
to the <code>Hacking</code><!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">In case you are interested:
<div class="highlight"><pre><span></span><span class="nf">hacking</span>
<span class="w">  </span><span class="ow">=</span><span class="w"> </span><span class="n">renamed</span><span class="w"> </span><span class="p">[</span><span class="kt">Replace</span><span class="w"> </span><span class="s">&quot;Hacking&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">limitWindows</span><span class="w"> </span><span class="mi">3</span>
<span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">magnify</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="p">(</span><span class="kt">NoMaster</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="kt">True</span>
<span class="w">  </span><span class="o">$</span><span class="w"> </span><span class="kt">ResizableTall</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="mi">13</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="kt">[]</span>
</pre></div>

<p></p>
As the rest of my dotfiles, it’s available
<a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs#L341">here</a>.</span></span>
 layout:
<div class="highlight"><pre><span></span><span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">sendMessage</span><span class="w"> </span><span class="p">(</span><span class="kt">JumpToLayout</span><span class="w"> </span><span class="s">&quot;Hacking&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spawnEditorInTopic</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">executeInTopic</span><span class="w"> </span><span class="s">&quot;ghcid&quot;</span>
</pre></div>

<p></p>
And Voilà, we can now attach this action to all the topics that we want!
<p></p>
Note that the <code>*&gt;</code> operator is—in this case—just the sequencing of
actions. If you’re more comfortable with <code>do</code> notation, you can also
write the above as
<div class="highlight"><pre><span></span><span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnHaskell</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">sendMessage</span><span class="w"> </span><span class="p">(</span><span class="kt">JumpToLayout</span><span class="w"> </span><span class="s">&quot;Hacking&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">spawnEditorInTopic</span>
<span class="w">  </span><span class="n">executeInTopic</span><span class="w"> </span><span class="s">&quot;ghcid&quot;</span>
</pre></div>

<p></p>
Furthermore, since the associated directory for a topic can easily be
made <code>$HOME</code> by default (as we’ve seen, TopicSpace even exports the
<code>inHome</code> function), spawning programs in certain topics can easily be
made to replace the default keybindings!
<p></p>
For the sake of completeness, I will showcase one slightly more
complicated example. My main shell environment is <code>eshell</code> and getting
sane behaviour there presents one with a few more obstacles than
<code>spawnTermInTopic</code> did. It also uses <code>inProgram</code> instead of <code>inEditor</code>,
allowing access to a different instance of the Emacs server.
<div class="highlight"><pre><span></span><span class="c1">-- | Spawn an eshell frame in the current topic directory.</span>
<span class="nf">spawnEshellInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnEshellInTopic</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span><span class="w"> </span><span class="o">&gt;&gt;=</span><span class="w"> </span><span class="nf">\</span><span class="n">dir</span><span class="w"> </span><span class="ow">-&gt;</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inProgram</span><span class="w"> </span><span class="s">&quot;emacsclient -a '' -c -s eshell&quot;</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="p">(</span><span class="n">progn</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s">&quot;eshell&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">quote</span><span class="w"> </span><span class="s">&quot;new-shell&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eshell/cd&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">asString</span><span class="w"> </span><span class="n">dir</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eshell/clear-scrollback&quot;</span>
<span class="w">                        </span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eshell-send-input&quot;</span>
<span class="w">                        </span><span class="p">])</span>
</pre></div>

<p></p>
All in all, we have something that looks a little bit like this:
<p></p>
<img class="pure-img" src="./haskell-topic.gif">
<h3 id="testing-this-website">Testing this website</h3>
<p></p>
Much in the same vein as my Haskell topics, I find the <code>website</code> topic
to be extremely handy—you can probably guess what it’s used for. Its
associated function <code>spawnWebsite</code> switches to the “Tall” layout, spawns
an Emacs frame in the topic directory, builds the website, and opens a
browser window pointing to the local copy:
<div class="highlight"><pre><span></span><span class="nf">spawnWebsite</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnWebsite</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">switchToLayout</span><span class="w"> </span><span class="s">&quot;Tall&quot;</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spawnEditorInTopic</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">executeInTopic</span><span class="w"> </span><span class="s">&quot;hakyll-build.sh --hold&quot;</span>
<span class="w">            </span><span class="o">*&gt;</span><span class="w"> </span><span class="n">spawn</span><span class="w"> </span><span class="s">&quot;browser-new-window.sh localhost:8000&quot;</span>
</pre></div>

<p></p>
The whole thing looks like this:
<p></p>
<img class="pure-img" src="./website.gif">
<h2 id="conclusion">Conclusion</h2>
<p></p>
Hopefully these examples have convinced you to give TopicSpace a spin;
perhaps you’ve even gotten some ideas of your own you’d like to try out.
Although conceptually very simple, the module can be used in a variety
of ways to automate boring tasks just that tiny bit more—definitely a
win in my book!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Rapidly Capture Ideas with XMonad and Emacs</title>
    <link href="https://tony-zorman.com/posts/orgmode-prompt/2022-08-27-xmonad-and-org-mode.html" />
    <id>https://tony-zorman.com/posts/orgmode-prompt/2022-08-27-xmonad-and-org-mode.html</id>
    <published>2022-08-27T00:00:00Z</published>
    <updated>2022-08-27T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-08-27
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->


<p></p>
As I’ve said before, basically my entire digital life happens in either
<a href="https://www.gnu.org/software/emacs/">Emacs</a> or <a href="https://xmonad.org/"><span class="small-caps">xm</span>onad</a>. Thus, a lot of time spent on my setup either goes
towards working on the two configurations separately, or—as we’ll do
today—bringing them ever closed together.
<p></p>
Specifically, I want to showcase a new<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">In version <code>0.17.0</code>, though new features are coming for <code>0.17.1</code>,
which will drop soon!</span></span>
 <span class="small-caps">xm</span>onad module:
<a href="https://xmonad.github.io/xmonad-docs/xmonad-contrib/XMonad-Prompt-OrgMode.html">XMonad.Prompt.OrgMode</a>. Building on top of <span class="small-caps">xm</span>onad’s prompt—which works
much like <a href="https://tools.suckless.org/dmenu/">dmenu</a>—it is designed to rapidly capture thoughts and ideas
whenever inspiration strikes and, importantly, to do so without
disrupting one’s current workflow. The module recently got support for
Org <a href="https://orgmode.org/manual/Priorities.html">priorities</a>, so I figured this was as good an excuse as
any to talk about it.
<!--more-->
<h3 id="motivation">Motivation</h3>
<p></p>
One theme in the post about my <a href="../phd-workflow/2022-05-01-my-phd-workflow.html">research workflow</a> was how it’s possible
to use org-mode (with all of its appendages, like <a href="https://www.orgroam.com/">org-roam</a>) to
organise one’s thoughts. <code>XMonad.Prompt.OrgMode</code> was created as yet
another link in that chain. Unlike when writing tiny <a href="../2022-05-25-calling-emacs-from-xmonad.html">Emacs Lisp
scripts in <span class="small-caps">xm</span>onad</a>, this does not involve any
custom elisp code one has to run; all of it is taken care of by the
module itself.
<p></p>
The upshot of all of this is a tool to quickly and unobtrusively jot
down an idea—quiet the monkey mind—and then get back to work straight
away. For me, having something like this is very important, lest I get
distracted by some thought about another project and spend the next hour
or so working on that instead of doing what I was actually supposed to
do. Having the idea written down in a known place—perhaps even with an
automatic reminder in my <a href="https://orgmode.org/manual/Agenda-Views.html">agenda</a>—helps me get rid of that creeping
anxiety that I’m forgetting things left and right.
<h3 id="functionality">Functionality</h3>
<p></p>
The following showcases the core functionality of the module—taking
notes!
<p></p>
<img class="pure-img" src="./simple-task.gif">
<p></p>
In case you <em>really</em> don’t want to forget something, there is also the
ability to create <code>DEADLINE</code> and <code>SCHEDULED</code> tasks. Optionally, you can
also specify a <a href="https://orgmode.org/manual/Priorities.html">priority</a>, depending on the importance of the note. If
you add the org file in which the <span class="small-caps">todo</span>s are placed to the
<code>org-agenda-files</code> variable, then this will immediately show these tasks
in your agenda!
<p></p>
<img class="pure-img" src="./deadline-task.gif">
<p></p>
How exactly one may specify the <code>SCHEDULED</code> and <code>DEADLINE</code> keywords, as
well as a date, time, and priority is covered in detail in the
<a href="https://xmonad.github.io/xmonad-docs/xmonad-contrib/XMonad-Prompt-OrgMode.html">documentation</a> for <code>X.P.OrgMode</code>.
<p></p>
Last but not least, it’s possible to capture the current (primary)
selection and, depending on the type of thing in it, use that as either
the body or the header of the task. If it’s a URL, create a link (i.e.,
it will be of the form <code>[[link][input-text]]</code>); if not, just add the
selection to the body of the note.
<p></p>
<img class="pure-img" src="selection-tasks.png">
<p></p>
Of course, you can use all of this together as well—directly link to
that one paper or blog post you wanted to read, or that one YouTube
video you want to watch on the weekend!
<h3 id="sample-configuration">Sample configuration</h3>
<p></p>
To round things off—and quickly showcase another cool (and new!)
module, <a href="https://xmonad.github.io/xmonad-docs/xmonad-contrib/XMonad-Actions-Prefix.html">XMonad.Actions.Prefix</a>—here is a sample keybinding that takes
“normal” <code>TODO</code> notes on <code>M-o c</code><!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">Note that for this post, <code>M</code> means <code>&lt;Super_L&gt;</code> and not <code>&lt;Alt_L&gt;</code>.</span></span>
 and uses the selection when called
with a universal argument:
<div class="highlight"><pre><span></span><span class="c1">-- uses {-# LANGUAGE LambdaCase #-}</span>
<span class="nf">orgKey</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="p">,</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span><span class="p">)</span>
<span class="nf">orgKey</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="p">(</span><span class="s">&quot;M-o c&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">withPrefixArgument</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="p">(`</span><span class="n">uncurry</span><span class="p">`</span><span class="w"> </span><span class="n">orgSettings</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nf">\</span><span class="kr">case</span>
<span class="w">     </span><span class="kt">Raw</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">orgPromptPrimary</span><span class="w"> </span><span class="n">promptNoHist</span>
<span class="w">     </span><span class="kr">_</span><span class="w">     </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">orgPrompt</span><span class="w">        </span><span class="n">promptNoHist</span><span class="p">)</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">orgSettings</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;TODO&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~/todos.org&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
I’ve found <code>M-u</code> to be quite convenient for <span class="small-caps">xm</span>onad’s universal argument
key, mirroring the <code>C-u</code> convention from Emacs. In either case, simply
add the <code>usePrefixArgument</code> combinator somewhere to your <code>main</code> function
and give it your preferred keybinding. For example:
<div class="highlight"><pre><span></span><span class="nf">main</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">IO</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">main</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">xmonad</span>
<span class="w">     </span><span class="o">.</span><span class="w"> </span><span class="n">usePrefixArgument</span><span class="w"> </span><span class="s">&quot;M-u&quot;</span>
<span class="w">     </span><span class="o">$</span><span class="w"> </span><span class="n">def</span><span class="p">{</span><span class="w"> </span><span class="n">modMask</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mod4Mask</span><span class="w">  </span><span class="c1">-- use &lt;Super&gt; as mod</span>
<span class="w">          </span><span class="p">}</span>
</pre></div>

<p></p>
If you’re anything like me, this will soon become an integral part of
your workflow and you won’t want to live without it. If not, then
perhaps you still don’t understand what all the fuss is about; in either
case, I’d like to <a href="mailto:soliditsallgood@mailbox.org">hear from you</a>!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>How to query-replace multiple matches!</title>
    <link href="https://tony-zorman.com/posts/query-replace/2022-08-06-query-replace-many.html" />
    <id>https://tony-zorman.com/posts/query-replace/2022-08-06-query-replace-many.html</id>
    <published>2022-08-06T00:00:00Z</published>
    <updated>2022-08-06T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-08-06
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
As its name suggests, Emacs’s <code>query-replace</code> function (bound to <code>M-%</code>
by default) can be used to replace occurences of one string with
another. In comparison to other tools that are used for similar
purposes—(a subset of) keyboard macros and multiple-cursors—the whole
process after entering the <code>from</code> and <code>to</code> strings is interactive all
the way through: it’s very fast to step through the individual matches
and decide on the spot whether one would like to replace them or not.
Needless to say, I like <code>query-replace</code> a lot! In true Emacs fashion,
the function also takes way too many arguments: among other things, it
can operate on the current region, backwards, or only on things
surrounded by words boundaries.
<p></p>
However, there is one crucial feature missing from its default
functionality: the ability to create multiple <code>from → to</code> pairs. But
this is Emacs, after all, which means that I can just write that
<code>query-replace-many</code> function I’ve always wanted!
<!--more-->
<h2 id="motivation">Motivation</h2>
<p></p>
Originally, my motivation came through <a href="../../research.html">work</a>, where I <a href="../phd-workflow/2022-05-01-my-phd-workflow.html">write a lot of
LaTeX</a>. When polishing papers, it sometimes happens that I would like
to change or unify the notation of certain objects in the current
equation/environment/file.
<p></p>
When an alteration like this only encompasses a single action, like
switching <code>T</code> to <code>H</code>, a simple <code>query-replace</code> after narrowing to the
current region of interest is totally sufficient. For others, like
changing <code>T</code> to <code>H</code> <em>and</em> <code>S</code> to <code>G</code>, this solution, along with
multiple-cursors and other tools people usually go for, would already be
unsatisfactory—the whole region would need to be traversed twice. Now
imagine that you want to change <code>T</code> to <code>U</code> <em>and</em> <code>U</code> to <code>T</code>: chaos!
Save having to give some sort of temporary name to one of the objects,
which would be even slower, <code>query-replace</code> is quite useless in this
situation. It’s possible to cook up a manual solution using the
alternative <code>query-replace-regexp</code> function and capture groups, but I’m
unsure how many people know their elisp regular expressions well enough
for that to be time efficient. I don’t, and almost certainly never
will, so it seemed much easier to automate this instead!
<h2 id="the-solution">The solution</h2>
<p></p>
Thankfully, since <code>replace.el</code> sports a decent API, writing a version of
<code>query-replace</code> that accepts multiple arguments turns out to be easy
enough. The high-level overview is this: we read in multiple queries
until an empty input is given,<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">This isn’t <em>quite</em> what’s actually done, but it’s the right mental
model to have (since this is how the function behaves). The gory
details are that we use the fact that <code>replace.el</code>’s default
suggestion is always the last query that was entered by the user.
What happens on an empty input is quite deep in the bowels of
<code>query-replace-read-from</code>. Since replacing these massive internal
functions sounds like a real pain, leaning on that functionality
suddenly appears much more reasonable. Thus, when we get back a
query that has already been entered in one way or another, we bail
out.</span></span>
 build up a regular expression of the
form <code>"\\(?:query-1\\|query-2\\|…\\)"</code>, and—when it comes to
replacing—test the current thing to be replaced against all of the
queries to select the correct one.
<p></p>
The beauty of this is that, since it’s really just a thin wrapper over
two functions from <code>replace.el</code> that do the heavy lifting, all of the
modules regular functionality, like the keybindings and history, just
work.
<p></p>
For example, in the following I replace <code>T</code> with <code>U</code> and, at the same
time, <code>U</code> with <code>T</code>. The first few matches are stepped through and the
rest is just accepted wholesale. At the bottom, you can see the default
<code>query-replace</code> interface when interacting with the query.
<p></p>
<img class="pure-img" src="./query-replace-many.gif">
<p></p>
The only cosmetic imperfection of this is that, while the replacement
candidate itself is correctly updated, we see the whole regular
expression <code>\(?U:\|T\)</code> as the thing to be replaced instead of the bit
that’s actually matching currently. However, since this would seem to
require some work and one of course sees what’s to be replaced by
looking at the thing at point, I can very much live with this for the
moment.
<h3 id="the-code">The code</h3>
<p></p>
Below is the full source code, in all of its hacky glory. Note that you
will need to <code>require</code> the <code>s.el</code> and <code>dash.el</code> libraries for this to
work, if you haven’t loaded these already (if you use any amount of
packages at all, chances are that you have).
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/get-queries</span><span class="w"> </span><span class="p">(</span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">pairs</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Get multiple </span><span class="ss">`query-replace'</span><span class="s"> pairs from the user.</span>
<span class="s">PAIRS is a list of replacement pairs of the form (FROM . TO).&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="nv">-let*</span><span class="w"> </span><span class="p">(((</span><span class="nv">from</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">delim</span><span class="w"> </span><span class="nv">arg</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nv">query-replace-read-args</span>
<span class="w">            </span><span class="p">(</span><span class="nv">s-join</span><span class="w"> </span><span class="s">&quot; &quot;</span>
<span class="w">                    </span><span class="p">(</span><span class="nv">-non-nil</span>
<span class="w">                     </span><span class="p">(</span><span class="nf">list</span><span class="w"> </span><span class="s">&quot;Query replace many&quot;</span>
<span class="w">                           </span><span class="p">(</span><span class="k">cond</span><span class="w"> </span><span class="p">((</span><span class="nf">eq</span><span class="w"> </span><span class="nv">current-prefix-arg</span><span class="w"> </span><span class="ss">'-</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;backward&quot;</span><span class="p">)</span>
<span class="w">                                 </span><span class="p">(</span><span class="nv">current-prefix-arg</span><span class="w">         </span><span class="s">&quot;word&quot;</span><span class="p">))</span>
<span class="w">                           </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nv">use-region-p</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;in region&quot;</span><span class="p">))))</span>
<span class="w">            </span><span class="no">nil</span><span class="p">))</span><span class="w">                       </span><span class="c1">; no regexp-flag</span>
<span class="w">          </span><span class="p">(</span><span class="nv">from-to</span><span class="w"> </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="p">(</span><span class="nf">regexp-quote</span><span class="w"> </span><span class="nv">from</span><span class="p">)</span>
<span class="w">                         </span><span class="p">(</span><span class="nv">s-replace</span><span class="w"> </span><span class="s">&quot;\\&quot;</span><span class="w"> </span><span class="s">&quot;\\\\&quot;</span><span class="w"> </span><span class="nv">to</span><span class="p">))))</span>
<span class="w">    </span><span class="c1">;; HACK: Since the default suggestion of replace.el will be</span>
<span class="w">    </span><span class="c1">;; the last one we've entered, an empty string will give us</span>
<span class="w">    </span><span class="c1">;; exactly that.  Instead of trying to fight against this,</span>
<span class="w">    </span><span class="c1">;; use it in order to signal an exit.</span>
<span class="w">    </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">-contains?</span><span class="w"> </span><span class="nv">pairs</span><span class="w"> </span><span class="nv">from-to</span><span class="p">)</span>
<span class="w">        </span><span class="p">(</span><span class="nf">list</span><span class="w"> </span><span class="nv">pairs</span><span class="w"> </span><span class="nv">delim</span><span class="w"> </span><span class="nv">arg</span><span class="p">)</span>
<span class="w">      </span><span class="p">(</span><span class="nv">slot/get-queries</span><span class="w"> </span><span class="p">(</span><span class="nb">push</span><span class="w"> </span><span class="nv">from-to</span><span class="w"> </span><span class="nv">pairs</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">defun</span><span class="w"> </span><span class="nv">slot/query-replace-many</span>
<span class="w">    </span><span class="p">(</span><span class="nv">pairs</span><span class="w"> </span><span class="kp">&amp;optional</span><span class="w"> </span><span class="nv">delimited</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">end</span><span class="w"> </span><span class="nv">backward</span><span class="w"> </span><span class="nv">region-noncontiguous-p</span><span class="p">)</span>
<span class="w">  </span><span class="s">&quot;Like </span><span class="ss">`query-replace'</span><span class="s">, but query for several replacements.</span>
<span class="s">Query for replacement pairs until the users enters an empty</span>
<span class="s">string (but see </span><span class="ss">`slot/get-queries'</span><span class="s">).</span>

<span class="s">Refer to </span><span class="ss">`query-replace'</span><span class="s"> and </span><span class="ss">`perform-replace'</span><span class="s"> for what the other</span>
<span class="s">arguments actually mean.&quot;</span>
<span class="w">  </span><span class="p">(</span><span class="k">interactive</span>
<span class="w">   </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">((</span><span class="nv">common</span><span class="w"> </span><span class="p">(</span><span class="nv">slot/get-queries</span><span class="p">)))</span>
<span class="w">     </span><span class="p">(</span><span class="nf">list</span><span class="w"> </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="nv">common</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nv">common</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">use-region-p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">region-beginning</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">use-region-p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">region-end</span><span class="p">))</span>
<span class="w">           </span><span class="p">(</span><span class="nf">nth</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="nv">common</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nv">use-region-p</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nv">region-noncontiguous-p</span><span class="p">)))))</span>
<span class="w">  </span><span class="p">(</span><span class="nv">perform-replace</span>
<span class="w">   </span><span class="p">(</span><span class="nf">concat</span><span class="w"> </span><span class="s">&quot;\\(?:&quot;</span><span class="w"> </span><span class="p">(</span><span class="nf">mapconcat</span><span class="w"> </span><span class="nf">#'car</span><span class="w"> </span><span class="nv">pairs</span><span class="w"> </span><span class="s">&quot;\\|&quot;</span><span class="p">)</span><span class="w"> </span><span class="s">&quot;\\)&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">; build query</span>
<span class="w">   </span><span class="p">(</span><span class="nf">cons</span><span class="w"> </span><span class="p">(</span><span class="nb">lambda</span><span class="w"> </span><span class="p">(</span><span class="nv">pairs</span><span class="w"> </span><span class="nv">_count</span><span class="p">)</span>
<span class="w">           </span><span class="p">(</span><span class="nb">cl-loop</span><span class="w"> </span><span class="nv">for</span><span class="w"> </span><span class="p">(</span><span class="nv">from</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="nv">to</span><span class="p">)</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="nv">pairs</span>
<span class="w">                    </span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">string-match</span><span class="w"> </span><span class="nv">from</span><span class="w"> </span><span class="p">(</span><span class="nv">match-string</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span>
<span class="w">                    </span><span class="nb">return</span><span class="w"> </span><span class="nv">to</span><span class="p">))</span>
<span class="w">         </span><span class="nv">pairs</span><span class="p">)</span>
<span class="w">   </span><span class="nb">:query</span><span class="w"> </span><span class="nb">:regexp</span>
<span class="w">   </span><span class="nv">delimited</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="nv">start</span><span class="w"> </span><span class="nv">end</span><span class="w"> </span><span class="nv">backward</span><span class="w"> </span><span class="nv">region-noncontiguous-p</span><span class="p">))</span>
</pre></div>


      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>Calling Emacs from XMonad</title>
    <link href="https://tony-zorman.com/posts/2022-05-25-calling-emacs-from-xmonad.html" />
    <id>https://tony-zorman.com/posts/2022-05-25-calling-emacs-from-xmonad.html</id>
    <published>2022-05-25T00:00:00Z</published>
    <updated>2022-05-25T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-05-25
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>, <a title="All pages tagged 'haskell'." href="/tags/haskell.html">haskell</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
In the post about my <a href="/posts/phd-workflow/2022-05-01-my-phd-workflow.html#citations">research workflow</a>, I briefly mentioned having to
call Emacs—or other external programs—from within <span class="small-caps">xm</span>onad. I figured
that this was perhaps something that could be of use to more people than
just me. After a little bit of deliberation and coming up with a
generic enough API, I decided to turn it into an <span class="small-caps">xm</span>onad module!
<p></p>
Yesterday these changes were merged into <a href="https://github.com/xmonad/xmonad-contrib">xmonad-contrib</a>, and they are
now available for everyone to try out; provided one has the git version
of <span class="small-caps">xm</span>onad <a href="https://xmonad.org/INSTALL.html">installed</a>.<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">If you <em>really</em> want to try this feature but don’t want to bother
installing any unreleased—though stable—version, message me in any
way and maybe we’ll hurry up and cut 0.17.1 soon!</span></span>
<p></p>
I’d like to use this opportunity to both showcase the module—how and why
one would use it—and talk a little bit about its only redeeming
implementation detail.
<!--more-->
<h2 id="main-use-cases">Main use cases</h2>
<p></p>
Wouldn’t it be neat to have some kind of <a href="https://en.wikipedia.org/wiki/Domain-specific_language"><span class="small-caps">edsl</span></a> for spawning external
processes? Something where one can just compose Haskell functions
together, not having to worry about the actual underlying string
manipulations? Something that’s composable, so that one does not have
to write the same <code>"emacsclient -c -a '' …"</code> or <code>"alacritty --working-directory …"</code> prefix over and over again? Well, at least
that’s what I thought on some rainy afternoon a few months ago.
<h3 id="scratchpads">Scratchpads</h3>
<p></p>
The first use case that I came up with was <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Util-NamedScratchpad.html">scratchpad</a>s. The idea of
these things is simple: while we normally don’t like floating windows,
it’s quite convenient to have some of them around that one can bring to
the current workspace, as well as hide, with a single keybinding. This
is useful for things like email, a calendar, a daily agenda, a
calculator, etc.
<p></p>
For scratchpads to work reliably, windows need to have some unique
characteristic they can be recognised by, like a special <a href="https://tronche.com/gui/x/icccm/sec-4.html#WM_CLASS">class or
instance name</a>. Endowing an application with additional properties
sounds exactly like what our <span class="small-caps">edsl</span> should be good at, so let’s try that!
<p></p>
Using the new features of <code>XMonad.Util.Run</code>, we could spawn an Emacs
frame with a special name for our scratchpad hooks to grab onto, and
execute <code>notmuch</code>:
<div class="highlight"><pre><span></span><span class="nf">mailSession</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="kt">String</span>
<span class="nf">mailSession</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">getInput</span><span class="w"> </span><span class="o">$</span>
<span class="w">  </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setFrameName</span><span class="w"> </span><span class="n">mailInstName</span>
<span class="w">           </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">function</span><span class="w"> </span><span class="s">&quot;notmuch&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
You can read the <code>&gt;-&gt;</code> operator a little like a pipe, where you start
with what you want and thread that information through to the end: “I
want an editor with a certain frame name that also starts up notmuch”.
<p></p>
In full, the above function would produce the string (broken into a few
lines for better readability)
<div class="highlight"><pre><span></span>&quot;emacsclient -c -a ''
             -F '(quote (name . \&quot;notmuch-scratch\&quot;))'
             --eval '(notmuch)'&quot;
</pre></div>

<p></p>
which would be quite bothersome to type indeed.
<p></p>
Because the type of <code>mailSession</code> is <code>X String</code> and not just <code>String</code>,
the setup for this is a little bit different than usual when using
scratchpads. You would use it like this:
<div class="highlight"><pre><span></span><span class="nf">myScratchpads</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="p">[</span><span class="kt">NamedScratchpad</span><span class="p">]</span>
<span class="nf">myScratchpads</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="c1">-- First, get the finished string.</span>
<span class="w">  </span><span class="n">mailSession</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">getInput</span><span class="w"> </span><span class="o">$</span>
<span class="w">    </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setFrameName</span><span class="w"> </span><span class="n">mailInst</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">elispFun</span><span class="w"> </span><span class="s">&quot;notmuch&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="c1">-- Now we can insert it into our scratchpads as normal.</span>
<span class="w">  </span><span class="n">pure</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="kt">NS</span><span class="w"> </span><span class="s">&quot;Mail&quot;</span><span class="w"> </span><span class="n">mailSession</span><span class="w"> </span><span class="p">(</span><span class="n">appName</span><span class="w"> </span><span class="o">=?</span><span class="w"> </span><span class="n">mailInst</span><span class="p">)</span><span class="w"> </span><span class="n">quake</span><span class="w"> </span><span class="p">]</span>
<span class="w"> </span><span class="kr">where</span>
<span class="w">  </span><span class="n">mailInst</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;notmuch-scratch&quot;</span>
<span class="w">  </span><span class="n">quake</span><span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="n">customFloating</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">RationalRect</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mi">4</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>

<span class="c1">-- The call to @namedScratchpadManageHook@ in the manageHook also</span>
<span class="c1">-- needs to be slightly adjusted.</span>
<span class="nf">myManageHook</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">ManageHook</span>
<span class="nf">myManageHook</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">mconcat</span>
<span class="w">  </span><span class="p">[</span><span class="w"> </span><span class="err">…</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">namedScratchpadManageHook</span><span class="w"> </span><span class="o">=&lt;&lt;</span><span class="w"> </span><span class="n">liftX</span><span class="w"> </span><span class="n">myScratchpads</span>
<span class="w">  </span><span class="p">]</span>
</pre></div>

<p></p>
Normally you would also add your <code>myScratchpads</code> list to all calls of
<code>namedScratchpadAction</code>; e.g., when you define the keys to call your
scratchpads. However, since the former lives in <code>X</code> now, this doesn’t
work anymore! Thankfully,
<a href="https://github.com/xmonad/xmonad-contrib/commit/3fc830aa09368dca04df24bf7ec4ac817f2de479">nowadays</a>
the first argument to <code>namedScratchpadAction</code> is actually unused and
only there for backwards compatibility. This means that it’s not
necessary to enter your scratchpads there at all if they are added to
your <code>manageHook</code>. For example, in the following I just provide the empty list:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="p">(</span><span class="s">&quot;M-C-t&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">namedScratchpadAction</span><span class="w"> </span><span class="kt">[]</span><span class="w"> </span><span class="s">&quot;Mail&quot;</span><span class="p">)</span>
</pre></div>

<p></p>
This works all the same with the above definition of <code>myScratchpads</code>.
<p></p>
A full example of how a scratchpad setup would look using this machinery
can be found in <a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/xmonad/.config/xmonad/src/xmonad.hs#L414">my config</a>.
<h3 id="calling-emacs-in-scripts">Calling Emacs in scripts</h3>
<p></p>
Spawning frames is nice and all, but how about something more
complicated, like Emacs’s batch mode so that we can use it properly in
scripts? No problem at all!
<p></p>
For example, I have the following snippet in my config to get the
currently selected text and call <a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a> with it to <a href="/posts/phd-workflow/2022-05-01-my-phd-workflow.html#citations">produce a
citation entry in my bibliography
files</a>:
<div class="highlight"><pre><span></span><span class="nf">callArXiv</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">callArXiv</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span>
<span class="w">  </span><span class="n">url</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">getSelection</span><span class="w">  </span><span class="c1">-- from X.U.XSelection</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEmacs</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">withEmacsLibs</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="kt">ElpaLib</span><span class="w"> </span><span class="s">&quot;dash&quot;</span><span class="p">,</span><span class="w"> </span><span class="kt">ElpaLib</span><span class="w"> </span><span class="s">&quot;s&quot;</span>
<span class="w">                       </span><span class="p">,</span><span class="w"> </span><span class="kt">ElpaLib</span><span class="w"> </span><span class="s">&quot;arxiv-citation&quot;</span>
<span class="w">                       </span><span class="p">,</span><span class="w"> </span><span class="kt">Special</span><span class="w"> </span><span class="s">&quot;~/.config/emacs/private-stuff.el&quot;</span><span class="w"> </span><span class="p">]</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">asBatch</span>
<span class="w">     </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">eval</span><span class="w"> </span><span class="p">(</span><span class="n">progn</span><span class="w"> </span><span class="p">[</span><span class="n">require</span><span class="w"> </span><span class="s">&quot;arxiv-citation&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">asString</span><span class="w"> </span><span class="n">url</span><span class="p">])</span>
</pre></div>

<p></p>
When executed, this translates to something like
<div class="highlight"><pre><span></span>emacs -L /home/slot/.config/emacs/elpa/dash-20220417.2250
      -L /home/slot/.config/emacs/elpa/s-20210616.619
      -L /home/slot/.config/emacs/elpa/arxiv-citation-20220510.1137/
      --batch
      --eval '(progn
                (require (quote arxiv-citation))
                (arXiv-citation &quot;&lt;url-in-the-primary-selection&gt;&quot;))'
</pre></div>

<p></p>
I certainly know which one I’d rather type—especially with <span class="small-caps">elpa</span>
directory names changing quite frequently! On that note,
<a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a> is on <span class="small-caps">melpa</span> now; yay!
<h3 id="other-programs">Other programs</h3>
<p></p>
As this is my main use case for it, the new features of
<code>XMonad.Util.Run</code> are quite specialised for Emacs. However, even for
other programs they may well come in handy. Drawing from the point
about scratchpads again, here is a hypothetical one that spawns a ghci
session:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="n">ghci</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inTerm</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">setXClass</span><span class="w"> </span><span class="n">calcInstName</span><span class="w"> </span><span class="o">&gt;-&gt;</span><span class="w"> </span><span class="n">execute</span><span class="w"> </span><span class="s">&quot;ghci&quot;</span>
</pre></div>

<p></p>
Further, something that’s useful when dealing with <a href="/posts/phd-workflow/2022-05-01-my-phd-workflow.html#topics">topic-based
workspaces</a>
is spawning a terminal or an editor already in the current topic
directory:
<div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">XMonad.Actions.TopicSpace</span><span class="w">  </span><span class="c1">-- for currentTopicDir and more</span>
<span class="nf">topicConfig</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="err">…</span>

<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnTermInTopic</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">termInDir</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>

<span class="c1">-- Optionally, modify the path to the editor with a function.</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">X</span><span class="w"> </span><span class="nb">()</span>
<span class="nf">spawnEditorInTopic</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="ow">=</span>
<span class="w">  </span><span class="n">proc</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">inEditor</span><span class="w"> </span><span class="o">&gt;-$</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">currentTopicDir</span><span class="w"> </span><span class="n">topicConfig</span>
</pre></div>

<p></p>
Quite convenient if you ask me.
<p></p>
If you have or know of a use case you would like to support but which is
awkward with the current set of functions and combinators do not
hesitate to open a pull request or an issue!
<h2 id="implementation-considerations">Implementation considerations</h2>
<p></p>
The implementation is actually very straightforward—no really, check out
the
<a href="https://github.com/xmonad/xmonad-contrib/blob/master/XMonad/Util/Run.hs#L303">source</a>
if you don’t believe me!
<p></p>
One concept that’s still worth touching upon is the internal use of
<a href="https://github.com/spl/dlist#references">difference list</a>s. The basic idea of these things is that, instead of
concatenating strings one by one, we create functions <code>String -&gt; String</code>
and then use function composition to do the work for us:
<div class="highlight"><pre><span></span><span class="w">  </span><span class="c1">-- Ordinary string concatenation</span>
<span class="w">  </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>

<span class="w">  </span><span class="c1">-- Using difference lists:</span>
<span class="w">  </span><span class="n">string1</span><span class="p">,</span><span class="w"> </span><span class="n">string2</span><span class="p">,</span><span class="w"> </span><span class="n">string3</span><span class="p">,</span><span class="w"> </span><span class="n">string4</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="w">  </span><span class="n">string1</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">s</span>
<span class="w">  </span><span class="n">string2</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="err">…</span>

<span class="w">  </span><span class="n">string1</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string3</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string4</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="s">&quot;&quot;</span>
</pre></div>

<p></p>
Note how we have to apply the entire thing to <code>""</code> at the end in order
to actually get a string back. As a concrete example, assuming we have
set <code>"Emacs"</code> as our editor, the <code>inEditor</code> function would essentially
be
<div class="highlight"><pre><span></span><span class="nf">inEditor</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="nf">inEditor</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot; Emacs &quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">s</span>
</pre></div>

<p></p>
There are some further considerations to be made, since we are in the
<code>X</code> monad and thus the type is actually <code>X (String -&gt; String)</code> instead
of just <code>String -&gt; String</code>, but that isn’t too important for us here.
<p></p>
Difference lists have some performance advantages over the traditional
concatenation of strings. The concatenation <code>(&lt;&gt;)</code> on strings is left
associative by default and so
<div class="highlight"><pre><span></span><span class="w">    </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="p">((</span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>
</pre></div>

<p></p>
However, the complexity characteristics of this operation are working
against us here; the definition of <code>(&lt;&gt;)</code> on <code>String</code><!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">Really, this is the definition of <code>(++)</code> for arbitrary lists <code>[a]</code>
and <code>(&lt;&gt;) = (++)</code> for <code>String = [Char]</code>, but let’s not get into
that here.</span></span>
 is
<div class="highlight"><pre><span></span><span class="p">(</span><span class="o">&lt;&gt;</span><span class="p">)</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">String</span>
<span class="kt">[]</span><span class="w">       </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ys</span><span class="w"> </span><span class="ow">=</span><span class="w">           </span><span class="n">ys</span>
<span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ys</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="kt">:</span><span class="w"> </span><span class="n">xs</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">ys</span>
</pre></div>

<p></p>
We are merely traversing the first string, leaving the second one
completely untouched (and unevaluated!). All in all, this means that
<code>s₁ &lt;&gt; s₂</code> is in <code>𝓞(|s₁|)</code>; given an expression of the form
<div class="highlight"><pre><span></span><span class="w">  </span><span class="p">((</span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string2&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string3&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;string4&quot;</span>
</pre></div>

<p></p>
we will have to walk over <code>"string1"</code> three times! What we actually
want is a right-associative ordering—exactly what function compositions
gives us. Spelled out,
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">string1</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string3</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">string4</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="n">string1</span><span class="w"> </span><span class="p">(</span><span class="n">string2</span><span class="w"> </span><span class="p">(</span><span class="n">string3</span><span class="w"> </span><span class="p">(</span><span class="n">string4</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)))</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="s">&quot;string1&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;string2&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;string3&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;string4&quot;</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)))</span>
</pre></div>

<p></p>
which yields the desired behaviour. In fact, this is so canonical that
instead of using <code>(.)</code>, we could have also—perhaps a bit
confusingly—used <code>(&lt;&gt;)</code> directly:
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">string1</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">string2</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">string3</span><span class="w">  </span><span class="o">.</span><span class="w"> </span><span class="n">string4</span>
<span class="w">  </span><span class="err">≡</span><span class="w"> </span><span class="n">string1</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">string3</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="n">string4</span>
</pre></div>

<p></p>
This is the fact that the <em>endomorphisms</em> for any type <code>a</code>—the functions
<code>a -&gt; a</code>—form a <em>monoid</em>. That is to say that they come equipped with
an associative an unital operation: function composition. In Haskell,
<code>(&lt;&gt;)</code> is, in some sense,
<a href="https://www.haskell.org/tutorial/classes.html">overloaded</a> so that it
can be used with any monoidal composition one can think of!<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Really, for any <em>semigroup</em>, which is a slightly weaker notion of
an operation that is merely associative, but doesn’t necessarily
have a unit.</span></span>
<p></p>
The attentive reader may have concluded that the pipe operator that we
called <code>(&gt;-&gt;)</code> above is really just <code>(&lt;&gt;)</code> in disguise, and that’s
exactly right! I, however, thought that for people not familiar with
Haskell, giving it a pipe-like appearance would be more conceptually
amenable to the threading idea.
<p></p>
I haven’t benchmarked this, so it’s not entirely clear to me whether
performance is actually relevant in this situation,<!--
--><span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">I suspect that the answer is “probably not”—that didn’t stop me,
however!</span></span>
 but using
difference lists just feels right here, and so I did.
<h2 id="conclusion">Conclusion</h2>
<p></p>
I have to say that I’m quite satisfied with this API. In fact, if I
look at the old code that only resided within my personal config, it’s
even a bit more ergonomic in a few places, despite having essentially no
user-specific strings hardcoded anywhere! As I said before, if you try
this and find something missing, do let me know and we’ll probably find
a solution! If you try this and find it useful, also let me know :)
<p></p>
Of course, technically none of this needs to live only inside your
<span class="small-caps">xm</span>onad config at all. In combination with the excellent <a href="https://hackage.haskell.org/package/turtle">turtle</a>
library, I reckon it would be quite easy to produce Haskell versions of
cool tools like magit.sh.<!--
--><span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">Available <a href="https://github.com/alphapapa/magit.sh">here</a>. I also
maintain a slightly modified and POSIX shell compatible version
<a href="https://gitlab.com/slotThe/dotfiles/-/blob/master/scripts/.scripts/magit.sh">here</a>.</span></span>
 Go nuts!

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>
<entry>
    <title>My PhD Research Workflow</title>
    <link href="https://tony-zorman.com/posts/phd-workflow/2022-05-01-my-phd-workflow.html" />
    <id>https://tony-zorman.com/posts/phd-workflow/2022-05-01-my-phd-workflow.html</id>
    <published>2022-05-01T00:00:00Z</published>
    <updated>2022-05-01T00:00:00Z</updated>
    <summary type="html"><![CDATA[<article>
    <section class="header">
      Posted on 2022-05-01
      
        | <a title="All pages tagged 'emacs'." href="/tags/emacs.html">emacs</a>, <a title="All pages tagged 'maths'." href="/tags/maths.html">maths</a>, <a title="All pages tagged 'xmonad'." href="/tags/xmonad.html">xmonad</a>
      
    </section>
    <section>
      <!-- A table of contents inline in the text, in case the screen is
           too small for the one in the `default.html' template -->
      <!-- A table of contents inline in the text, in case the screen is too
     small for the one in the `default.html' template -->

  

<p></p>
After reading <a href="https://castel.dev/post/research-workflow/">Gilles Castel</a>’s excellent blog post about his research
workflow, I decided that it was as good a time as any to write about
mine—deeming it novel enough to hopefully contribute something to the
discussion.
<p></p>
Just like Castel, I’m a new PhD student in mathematics, which means no
lab work and—in my case—no code. Just you and your inability to
understand basic concepts. As such, I often scribble things down on
paper or a blackboard first and, when sufficiently convinced that the
information is worth keeping around, type it up. Typesetting something
is a surprisingly effective way to catch errors in handwritten
manuscripts!
<p></p>
As basically my entire digital life happens in either <a href="https://www.gnu.org/software/emacs/">Emacs</a> or
<a href="https://xmonad.org/"><span class="small-caps">xm</span>onad</a>, my setup is heavily skewed in that direction; I will make use
of these tools almost every step of the way.
<!--more-->
As such, there is a lot of tangential almost relevant bits that I could
cover here. However, since these aren’t directly related to my
<em>research</em> workflow—and there is a lot of great resources out there
already—I decided to not do this here.<!--
--><span class="sidenote-wrapper"><label for="sn-0" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-0" class="margin-toggle" /><span class="sidenote">If you’d like some examples: being employed at a university also
means I have to worry a bit about efficiently dealing with
bureaucracy (<a href="https://notmuchmail.org/">notmuch.el</a>), keeping some sort of up-to-date
calendar and readable todo-notes (<a href="https://orgmode.org/">org-mode</a> and goodies, as well
as integration via <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Prompt-OrgMode.html"><span class="small-caps">xm</span>onad’s OrgMode prompt</a>), accessing the
universities internal nextcloud server (<a href="https://gitlab.com/hperrey/khalel">khalel</a> and <code>davfs2</code> or
<code>TRAMP</code>), … You get the idea.</span></span>
<h2 id="high-level-structure">High level structure</h2>
<h3 id="topics">Topics</h3>
<p></p>
<span class="small-caps">xm</span>onad has a module called <a href="https://hackage.haskell.org/package/xmonad-contrib/docs/XMonad-Actions-TopicSpace.html">TopicSpace</a>, which upgrades the X11
workspace—virtual desktop—concept to so-called topics. These are
workspaces with a “theme” associated to them; for example, I have a
topic for every project that I’m currently working on. This results in
a clean separation of concerns. Plus, I always know where my windows
are!
<p></p>
Every topic has a directory and a “startup hook”, firing when the topic
is switched to and empty, associated to it. While most convenient for
programming related tasks—e.g., spawn <code>ghcid</code> in the relevant directory
or automatically build and open this website—it’s also quite convenient
for mathematical projects.
<p></p>
I have set up special keybindings to bring up an Emacs session in the
topic directory, or spawn a terminal there. Switching to topics is done
fuzzily via the <span class="small-caps">xm</span>onad prompt, which means I only have to type a few
characters to get to my destination. This makes it feasible to have 30
topics, instead of the usual 9 or so, in the first place. As a result,
it’s rather fast to go from thinking about a certain problem to working
on it. When I’m already inside a project, I leverage Emacs’s built-in
<code>project.el</code> library to search through files and the like.
<p></p>
<img class="pure-img" src="./topics.gif">
<h3 id="files">Files</h3>
<p></p>
Here I keep things relatively simple; I have a big “library” directory
in which essentially all books or papers that I’ve ever read reside.
This may sound a bit chaotic, but since I never interact with this
as-a-directory it is actually the easiest and cleanest solution for me.
<p></p>
To keep a bit of order, all files are named in a consistent and
descriptive way: <code>authors_title.pdf</code>, where <code>authors</code> is a list of last
names of all authors separated by hyphens and <code>title</code> is the title of
the work, also separated by hyphens. For example:
<div class="highlight"><pre><span></span>    pastro-street_double-of-a-monoidal-category.pdf
</pre></div>

<p></p>
Also in this directory are <code>.xopp</code> files, when I scribble on the
relevant <span class="small-caps">pdf</span>s in <a href="https://xournalpp.github.io/">xournalpp</a>; more on that later.
<p></p>
Instead of navigating to it, all interaction with the library is done
via <a href="https://github.com/slotthe/hmenu">hmenu</a>, a small wrapper around <a href="https://tools.suckless.org/dmenu/">dmenu</a> to facilitate this kind of
behaviour. I merely have to press <code>M-y</code><!--
--><span class="sidenote-wrapper"><label for="sn-1" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-1" class="margin-toggle" /><span class="sidenote">I will be using Emacs style notation throughout the article. This
means that, for example, <code>C-x a</code> should be read as “hold down
control and press x, then release both and press a”. You can of
course safely ignore this, since the keys just serve illustrative
purposes. An important note for Emacs users, lest anyone be
confused: in <span class="small-caps">xm</span>onad, <code>M-</code> usually does <strong>not</strong> refer to the Meta
key, but to the <code>modMask</code> that the user specified. This is indeed
<code>&lt;Alt&gt;</code> by default, but many people understandably rebind this
straight away to something that’s less likely to interfere with
other programs. In my case, that’s the Super key, so <code>M-s</code> means
<code>&lt;Super&gt;-s</code> and not <code>&lt;Alt&gt;-s</code>.</span></span>
 and can then fuzzy search
through the directory. Once I’ve made a choice, <span class="small-caps">pdf</span>s are automatically
opened in <a href="https://pwmt.org/projects/zathura/">zathura</a> and <code>.xopp</code> files are opened in xournalpp.
<p></p>
<img class="pure-img" src="./hmenu.gif">
<p></p>
My bibliography is organised in a similar spirit; see
<a href="#citations">Citations</a>.
<h2 id="note-taking">Note taking</h2>
<h3 id="handwritten-notes">Handwritten notes</h3>
<p></p>
For handwritten notes I… use real paper! A little elaboration is
probably in order, having talked about <code>.xopp</code> files and xournalpp
above. I do have a Wacom tablet lying around and I’m quite happy
annotating <span class="small-caps">pdf</span>s with it. In lieu of printing everything out, this
alleviates a little bit of the usual pain with reading papers, like
coming back to one three weeks later and getting stuck on the same
calculation as last time. I do love those annotations!
<p></p>
However, there is just something deeply psychologically pleasing about
ordinary pen and paper—nothing beats drawing up the first version of
many ideas there. It’s a very “pure” experience: there’s no noise or
distractions, nothing that could break, no additional layer of
abstraction between you and the maths. Chalkboards—but not whiteboards,
with their ever empty markers—fall into this category as well,
especially when collaborating with others.
<p></p>
Not without my quirks (as I’m sure you’ve noticed), I’m a bit picky
about the particular writing setup. It’s either completely white A5<!--
--><span class="sidenote-wrapper"><label for="sn-2" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-2" class="margin-toggle" /><span class="sidenote">Although, admittedly, when drawing up large diagrams I’m sometimes
forced to switch to A4 paper in landscape mode.</span></span>

paper, paired with a good (mechanical) pencil/a fine pen, or thick
dotted paper, paired with a fountain pen.
<p></p>
Quite enjoying the experience, I tend to write quite a lot of
manuscripts by hand first. Of course, anything that’s supposed to be
permanent should be typed up properly!
<h3 id="digital-notes">Digital notes</h3>
<p></p>
Not wanting to go insane, I use LaTeX for all of my digital note taking.
My writing setup for <code>.tex</code> files is pretty similar to <a href="https://karthinks.com/software/latex-input-for-impatient-scholars/">Karthik
Chikmagalur</a>’s—whose excellent post you should definitely check out—so I
will not belabour the point too much here. The tl;dr is <a href="https://www.gnu.org/software/auctex/">AUCTeX</a>,
<a href="https://github.com/cdominik/cdlatex">CDLaTeX</a>, and <a href="https://github.com/ymarco/auto-activating-snippets">aas</a>.
<p></p>
<img class="pure-img" src="./input.gif">
<p></p>
In case you’re not used to <code>prettify-symbols-mode</code>: the inserted LaTeX
code was
<div class="highlight"><pre><span></span><span class="k">\begin</span><span class="nb">{</span>definition<span class="nb">}</span> <span class="k">\label</span><span class="nb">{</span>def:day-convolution<span class="nb">}</span>
  The <span class="k">\emph</span><span class="nb">{</span>Day convolution<span class="nb">}</span> of two functors <span class="s">$</span><span class="nb">F</span><span class="s">$</span> and <span class="s">$</span><span class="nb">G</span><span class="s">$</span> is
  <span class="sb">\[</span>
<span class="nb">    F </span><span class="o">*</span><span class="nb"> G </span><span class="nv">\defeq</span>
<span class="nb">      </span><span class="nv">\int</span><span class="nb">^{C,D </span><span class="nv">\in</span><span class="nb"> </span><span class="nv">\cc</span><span class="nb">} </span><span class="nv">\cc</span><span class="o">(</span><span class="nb">C </span><span class="nv">\otimes</span><span class="nb"> D, </span><span class="nv">\blank</span><span class="o">)</span><span class="nb"> </span><span class="nv">\otimes</span><span class="nb"> FC </span><span class="nv">\otimes</span><span class="nb"> GD.</span>
<span class="nb">  </span><span class="s">\]</span>
<span class="k">\end</span><span class="nb">{</span>definition<span class="nb">}</span>
</pre></div>

<p></p>
I do use some smaller packages not mentioned in Chikmagalur’s article,
like <a href="https://github.com/oantolin/math-delimiters">math-delimiters</a> and <a href="https://github.com/slotthe/change-env">latex-change-env</a>. The former is for
quickly changing between inline and display math, complete with slurping
punctuation symbols into display math and barfing them out of inline
math. For example, “<code>$1 + 1$.</code>” becomes “<code>\[1 + 1.\]</code>” (with line
breaks) and back.
<p></p>
The <code>latex-change-env</code> package is for changing between different kinds
of environments, including display math, while offering to rename labels
across the project if necessary. When deleting a label from an
environment, it also remembers this for the session!<!--
--><span class="sidenote-wrapper"><label for="sn-3" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-3" class="margin-toggle" /><span class="sidenote">This is based on the hash of the contents of the environment—if
that changes, the label is “lost”; though it can of course still
be retrieved manually from the relevant hash map.</span></span>
<p></p>
<img class="pure-img" src="./label-renaming.gif">
<p></p>
One neat feature of AUCTeX that I find myself using more and more often
lately<!--
--><span class="sidenote-wrapper"><label for="sn-4" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-4" class="margin-toggle" /><span class="sidenote">This is, in part, due to the new <code>pixel-scroll-precision-mode</code> in
Emacs 29, making use of XInput 2.4 functionality. It makes
scrolling through buffers that are quite dense with pictures
rather smooth.</span></span>
 is the in-buffer preview. Usually when writing a draft I’m
not that interested in how exactly something looks in the <span class="small-caps">pdf</span>—that part
comes later, believe me. In cases like these, just calling
<code>preview-buffer</code> is quite convenient and lets me use the screen real
estate that a <span class="small-caps">pdf</span> viewer would have taken up for something else.
<p></p>
<img class="pure-img" src="./preview.gif">
<p></p>
I always use pure LaTeX for writing papers, drafts, or presentations.
However, I also take lots of notes in <a href="https://orgmode.org/">org-mode</a>, which, as a crude
first approximation, is something like a markup language that’s <em>very</em>
well integrated into Emacs.
<p></p>
For the actual note-taking, I use the venerable <a href="https://www.orgroam.com/">org-roam</a>—a free
software alternative to the proprietary Roam Research program—to jot
down things that I’d like to remember for more than three days.
Org-roam describes itself as a “plain-text personal knowledge management
system”, which fits the bill pretty well. In short, it’s a note taking
system in the spirit of the <a href="https://en.wikipedia.org/wiki/zettelkasten">Zettelkasten</a> method, which is essentially
about having lots of notes with lots of backlinks to related concepts:
<p></p>
<img class="pure-img" src="./backlinks.png">
<p></p>
In fact, using <a href="https://github.com/org-roam/org-roam-ui">org-roam-ui</a>, one can even visualise the entire
Zettelkasten as an interactive and pretty graph in which notes become
nodes and backlinks become edges!
<div class="pure-g">
<div class="pure-u-1-2">
<img class="pure-img" src="./org-roam-ui-close.png">
</div>
<div class="pure-u-1-2">
<img class="pure-img" src="./org-roam-ui-far.png">
</div>
</div>
<p></p>
Org-roam <a href="https://github.com/org-roam/org-roam#configuration">suggests
keybindings</a> for all
of the most important concepts: creating notes, inserting them, showing
all of the backlinks of a file, etc. An important extra that I’ve added
is having two “types” of notes: <code>reference</code>s, where things that I
learned but are otherwise known reside, and <code>novel</code>s, where I put my own
ideas.
<p></p>
As I’m predisposed to quite easily forget details, I regularly engage
with my Zettelkasten, so as to keep things fresh in my mind. Reading
through all of the notes that are relevant to what I’m currently working
on, creating new backlinks, filling in gaps, even deleting old
information and re-organising some local region of the graph. Indeed, I
tag every new entry as a <code>draft</code> until further notice, forcing me to go
back there especially. This results in pretty good recollection of the
most important facts, even with my brain.
<h2 id="staying-up-to-date">Staying up to date</h2>
<p></p>
I use <a href="https://github.com/skeeto/elfeed">elfeed</a> to query the <a href="https://arxiv.org/">arXiv</a> for new preprints that are of
interest to me. Thankfully, the fields I’m subscribed to tend to be
moving slow-ish and so I can manage to at least read the abstract of
every paper that pops up in my feed. There is also <a href="https://gitlab.com/slotThe/dotfiles/-/blob/afa8fd39cea2647152038e3f4dd42f1dbd66c413/emacs/.config/emacs/lisp/rss.el#L61">a little bit of
elisp</a>
involved to print arXiv entries in a more readable way than the default
formatting.
<p></p>
When the abstract interests me, I usually directly download the paper
into my library and open it with zathura. This is fully automated via
<a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a>—more on that later. I merely have to press <code>C-c d</code>
while looking at a paper and magic happens!
<p></p>
<img class="pure-img" src="./elfeed.gif">
<p></p>
In the above gif, on the right-hand side you can see a score associated
to each entry. While reading every abstract has worked quite well for
me thus far, it’s nice to get the papers that are “probably interesting”
high up, so that I’m more likely to notice them sooner rather than
later. I use <a href="https://github.com/sp1ff/elfeed-score">elfeed-score</a> for this, which integrates seamlessly into
the rest of the machinery. It compares certain features of the entry
(like the title and abstract) with a list of regular expressions,
increasing the total score of the entry every time it matches something.
<p></p>
Speaking of the arXiv, in <span class="small-caps">xm</span>onad I have bound <code>M-s a</code> to look up the
given string there. Likewise, <a href="https://zbmath.org/">zbmath</a> is searched with <code>M-s z</code>. When
these commands get a “universal argument”—an Emacs concept that <span class="small-caps">xm</span>onad
borrowed—they automatically start a search with the current selection
instead. Briefly, pressing <code>M-u</code> before a command can modify it in
different ways. All of my search commands act on the <a href="https://www.jwz.org/doc/x-cut-and-paste.html">primary
selection</a> when given such an argument; <code>M-u M-s &lt;letter&gt;</code> will look up
the currently selected text on the relevant “search engine”. One
instance where this is useful is for quickly switching between the arXiv
and zbmath:
<p></p>
<img class="pure-img" src="./selected-search.gif">
<h3 id="citations">Citations</h3>
<p></p>
For citation management, I use a very simple system—no Zotero, JabRef,
or similar technology. Concretely, this means that I have a blessed
bibliography file somewhere within my home directory and I either
symlink (when I’m writing something alone) or copy (when working with at
least one coauthor) the file into the relevant project directory. In
case of a copy operation, I only have to update a single variable in
Emacs (<code>arxiv-citation-bibtex-files</code>), which is good enough for me and
doesn’t seem to warrant a slightly more automated, yet probably much
more complicated solution.
<p></p>
Adding new citations is done via the now aptly named Emacs package
<a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a><!--
--><span class="sidenote-wrapper"><label for="sn-5" class="margin-toggle sidenote-number"></label><input type="checkbox" id="sn-5" class="margin-toggle" /><span class="sidenote">Ostensibly, this should be an <span class="small-caps">xm</span>onad module, as it does not
necessarily have anything to do with Emacs itself. However, I had
already written the elfeed integration and so the most annoying
part (scraping the arXiv xml for certain bits) was already done.
On the other hand, there are more Emacs than <span class="small-caps">xm</span>onad users, so
perhaps doing it like this will help more people anyways.</span></span>
 with <a href="https://gitlab.com/slotThe/dotfiles/-/blob/afa8fd39cea2647152038e3f4dd42f1dbd66c413/xmonad/.config/xmonad/src/xmonad.hs#L576">a bit of
plumbing</a>
on the <span class="small-caps">xm</span>onad side to get Emacs going. The basic idea is that—given an
arXiv or zbmath link—we first look up the paper on zbmath to see if it
was published and, if not, just use the arXiv data to construct our own
bibliography entry instead. By default, my keybinding for this acts on
the primary selection, so I merely have to highlight the link, press
<code>M-o a</code>, sit back, and enjoy the show. The following gif should help
drive home the point, also showcasing the format of a not yet published
paper and a published one.
<p></p>
<img class="pure-img" src="./arXiv-citation.gif">
<h2 id="final-thoughts">Final thoughts</h2>
<p></p>
And that’s it! If nothing else, this post helped me to nail down some
ideas that I had lying around and got me to finally clean up and publish
many of the extensions talked about here—that’s already a win in my
book.
<p></p>
I’m sure that some details will change over the course of the next three
years as I mature mathematically and my needs change, but overall I feel
pretty comfortable with this setup.
<h5 id="addendum">Addendum</h5>
<p></p>
Thanks to everyone who reached out! I received some inquiries as to my
configurations, so here are the most important bits again, for your
convenience:
<a href="https://gitlab.com/slotThe/dotfiles/-/tree/master/emacs/.config/emacs">my Emacs config</a>,
<a href="https://gitlab.com/slotThe/dotfiles/-/tree/master/xmonad/.config/xmonad">my <span class="small-caps">xm</span>onad config</a>,
<a href="https://www.orgroam.com/">org-roam</a>, <a href="https://github.com/oantolin/math-delimiters">math-delimiters</a>, <a href="https://github.com/slotthe/arxiv-citation">arxiv-citation</a>, <a href="https://github.com/slotthe/change-env">latex-change-env</a>,
<a href="https://github.com/slotthe/hmenu">hmenu</a>.

      <!-- Body is included in the above file -->
    </section>
</article>
]]></summary>
</entry>

</feed>
